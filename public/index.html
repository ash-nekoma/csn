<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stick N' Trade Casino</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0f0f14;
  color: white;
}

.hidden { display: none; }

.topbar {
  display: flex;
  justify-content: space-between;
  padding: 15px;
  background: #181824;
  align-items: center;
}

button {
  padding: 8px 14px;
  background: #6c4cff;
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 6px;
}

button:hover {
  opacity: 0.85;
}

.auth-container {
  position: fixed;
  inset: 0;
  background: #0f0f14;
  display: flex;
  justify-content: center;
  align-items: center;
}

.auth-box {
  background: #181824;
  padding: 30px;
  border-radius: 10px;
  width: 320px;
}

input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  background: #222232;
  border: 1px solid #333;
  color: white;
  border-radius: 6px;
}

.section {
  padding: 30px;
}
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="authScreen" class="auth-container">
  <div class="auth-box">
    <h2 id="authTitle">Login</h2>
    <input id="username" placeholder="Username" />
    <input id="password" type="password" placeholder="Password" />
    <button onclick="submitAuth()">Continue</button>
    <p id="authError" style="color:red;"></p>
    <p style="text-align:center; margin-top:10px;">
      <span id="toggleAuth" style="cursor:pointer; color:#6c4cff;">Switch to Register</span>
    </p>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" class="hidden">

  <div class="topbar">
    <div>
      ðŸ‘¤ <span id="usernameDisplay"></span> |
      ðŸ’° <span id="creditsDisplay"></span>
    </div>
    <div>
      <button id="adminBtn" class="hidden" onclick="showAdmin()">Admin</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="section">
    <h2>Shared Table</h2>
    <input id="betAmount" type="number" placeholder="Bet amount"/>
    <button onclick="placeBet('heads')">Bet Heads</button>
    <button onclick="placeBet('tails')">Bet Tails</button>
    <div id="liveFeed"></div>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>

<script>
let isLogin = true;
let socket = null;
let currentUser = null;

document.getElementById("toggleAuth").onclick = () => {
  isLogin = !isLogin;
  document.getElementById("authTitle").innerText = isLogin ? "Login" : "Register";
  document.getElementById("toggleAuth").innerText = isLogin ? "Switch to Register" : "Switch to Login";
};

async function submitAuth() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const endpoint = isLogin ? "/api/login" : "/api/register";

  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ username, password })
  });

  const data = await res.json();

  if (!res.ok) {
    document.getElementById("authError").innerText = data.error || "Error";
    return;
  }

  if (!isLogin) {
    isLogin = true;
    document.getElementById("authTitle").innerText = "Login";
    document.getElementById("authError").innerText = "Registered! Now login.";
    return;
  }

  await loadUser();
}

async function loadUser() {
  const res = await fetch("/api/me", { credentials: "include" });
  if (!res.ok) return;

  currentUser = await res.json();

  document.getElementById("authScreen").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");

  document.getElementById("usernameDisplay").innerText = currentUser.username;
  document.getElementById("creditsDisplay").innerText = currentUser.credits;

  if (currentUser.role === "admin") {
    document.getElementById("adminBtn").classList.remove("hidden");
  }

  connectSocket();
}

function connectSocket() {
  socket = io({
    withCredentials: true
  });

  socket.on("table:update", data => {
    const feed = document.getElementById("liveFeed");
    feed.innerHTML += `<p>${data.player} bet ${data.amount} on ${data.choice}</p>`;
  });

  socket.on("bet:accepted", data => {
    document.getElementById("creditsDisplay").innerText = data.newCredits;
  });

  socket.on("bet:rejected", data => {
    alert(data.reason);
  });
}

function placeBet(choice) {
  const amount = parseInt(document.getElementById("betAmount").value);
  if (!amount) return alert("Enter bet amount");
  socket.emit("bet:place", { choice, amount });
}

async function logout() {
  await fetch("/api/logout", { method: "POST", credentials: "include" });
  location.reload();
}

function showAdmin() {
  alert("Admin panel placeholder.");
}

// Auto-check session on load
loadUser();
</script>

</body>
</html>
