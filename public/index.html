<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stick N' Trade | Casino</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&family=Rajdhani:wght@600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        /* ================= CSS VARIABLES & RESET ================= */
        :root { 
            --ps-bg: #000814; 
            --ps-blue: #00439c; 
            --ps-light-blue: #0070cc; 
            --ps-glow: #00a2ff; 
            --glass-bg: rgba(0, 10, 25, 0.75); 
            --glass-border: rgba(255, 255, 255, 0.15); 
            --glass-hover: rgba(255, 255, 255, 0.9); 
            --danger: #ff3366; 
            --success: #00e676; 
            --credits: #ffb400; 
            --text-main: #f8fafc; 
            --text-muted: #8c9eb5; 
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; outline: none; -webkit-tap-highlight-color: transparent;}
        
        /* Rigid Fullscreen Body - No Scrolling on PC */
        @media (min-width: 769px) {
            body { 
                background: linear-gradient(135deg, #000a1f 0%, #001f4d 50%, #000000 100%); 
                background-size: 200% 200%; 
                animation: AmbientBG 15s ease infinite; 
                color: var(--text-main); 
                height: 100vh; 
                width: 100vw; 
                overflow: hidden; 
            }
        }
        
        @keyframes AmbientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .chip, .anim-deal, .play-card, .wheelPanel, canvas, .flying-obj, .coin, .dice-icon, .mode-card, .game-card { will-change: transform, opacity; transform: translateZ(0); backface-visibility: hidden; }

        button i { pointer-events: none; }

        ::-webkit-scrollbar { display: none; }
        .custom-scroll { overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) transparent; padding-right: 5px;}
        .custom-scroll::-webkit-scrollbar { width: 6px; display: block; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        /* ================= AUTHENTICATION ================= */
        #auth-container { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 9999999; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); }
        .auth-box { width: 420px; max-width: 95vw; background: rgba(0, 5, 15, 0.9); padding: 2.5rem; border-radius: 16px; border: 1px solid rgba(0, 162, 255, 0.4); border-top: 3px solid var(--ps-glow); box-shadow: 0 25px 80px rgba(0,0,0,0.9), inset 0 0 30px rgba(0, 162, 255, 0.1); text-align: center; backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); }
        .auth-title { font-size: 2.2rem; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; white-space: nowrap;}
        .auth-sub { color: var(--ps-glow); font-weight: 800; font-size: 1rem; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 30px; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .auth-tab { flex: 1; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-muted); font-weight: 900; padding: 10px; cursor: pointer; text-transform: uppercase; transition: 0.2s; font-size: 1rem; }
        .auth-tab.active { border-bottom-color: var(--ps-glow); color: var(--ps-glow); }
        .auth-msg { font-size: 0.9rem; font-weight: 800; min-height: 20px; margin-bottom: 15px; text-align: center; }
        .auth-error { color: var(--danger); }
        .auth-success { color: var(--success); }
        
        .pwd-input-wrapper { position: relative; width: 100%; display: block; }
        .pwd-input-wrapper input { width: 100%; text-align: center; padding: 12px; }
        .pwd-input-wrapper i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted); font-size: 1.1rem; z-index: 2; transition: 0.2s; }
        .pwd-input-wrapper i:hover { color: white; }

        /* BUTTONS & INPUTS */
        .btn-play { background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--glass-border); padding: 12px 15px; border-radius: 8px; font-size: 1rem; font-weight: 900; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-play:hover:not(:disabled) { background: white; color: black; transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255,255,255,0.2); border-color: white;} 
        .btn-play:disabled { background: rgba(0,0,0,0.5) !important; color: var(--text-muted) !important; cursor: not-allowed !important; border-color: transparent !important; opacity: 0.5 !important; box-shadow:none !important; transform:none !important; }
        
        .input-group label { display: block; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: 800; margin-bottom: 8px; text-align: left; }
        .input-control { width: 100%; padding: 12px 15px; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); color: white; border-radius: 8px; font-size: 1rem; font-weight: 600; text-align: center; outline: none; transition: 0.2s;}
        .input-control:focus { border-color: var(--ps-glow); background: rgba(0,0,0,0.7); box-shadow: 0 0 15px rgba(0,162,255,0.2); }
        .bet-input { text-align: center !important; }
        .bet-input::placeholder { text-align: center; color: rgba(255,255,255,0.4); }
        
        /* PERFECTLY SQUARED ICON BUTTONS */
        .btn-rules { background: rgba(0,0,0,0.5); color: var(--text-muted); border: 1px solid var(--glass-border); width: 44px; height: 44px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; padding: 0; flex-shrink: 0;} 
        .btn-rules:hover { background: rgba(255,255,255,0.1); color: white; border-color: white; transform: scale(1.05); }

        /* ================= 1-ROW HUD TOPBAR ================= */
        #app-container { display: none; height: 100%; width: 100%; }
        .topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 99999; background: rgba(0, 5, 15, 0.95); border-bottom: 1px solid var(--glass-border); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 12px 25px; height: 75px; display: flex; align-items: center;}
        .topbar-inner { width: 100%; max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        
        .brand { display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; padding: 5px; border-radius: 8px;}
        .brand:hover { background: rgba(255,255,255,0.05); transform: scale(1.02); }
        .brand-dot { width: 14px; height: 14px; border-radius: 50%; background: var(--ps-glow); box-shadow: 0 0 20px var(--ps-glow); }
        .brand-title { font-weight: 900; letter-spacing: 2px; text-transform: uppercase; font-size: 1.5rem; color: var(--text-main); line-height: 1; text-shadow: 0 0 10px rgba(0, 162, 255, 0.5); }
        .brand-sub { color: var(--ps-glow); font-weight: 800; font-size: 0.9rem; letter-spacing: 3px; margin-top: 2px; text-transform: uppercase; }

        .topbar-right { display: flex; flex-direction: row; align-items: center; gap: 20px; position: relative;}
        
        .player-profile { display: flex; align-items: center; gap: 8px; font-weight: 800; color: white; font-size: 1rem; text-transform: uppercase; }
        .player-profile i { color: var(--ps-glow); font-size: 1.4rem; }

        .wallet-pill { background: rgba(0,0,0,0.8); border: 1px solid rgba(255,180,0,0.4); padding: 8px 20px; border-radius: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.3s; box-shadow: inset 0 0 10px rgba(255,180,0,0.1); }
        .wallet-pill:hover { border-color: var(--credits); transform: translateY(-2px); box-shadow: 0 0 15px rgba(255,180,0,0.3); }
        .wallet-pill i { color: var(--credits); font-size: 1.2rem; }
        #nav-credits { color: var(--credits); font-weight: 900; font-size: 1.1rem; }
        .wallet-unit { color: var(--text-muted); font-size: 0.8rem; font-weight: 800; }

        .topbar-actions { display: flex; flex-direction: row; align-items: center; gap: 15px; background: rgba(0,0,0,0.8); padding: 8px 20px; border-radius: 50px; border: 1px solid var(--glass-border); width: fit-content; }
        .top-icon-btn { position: relative; cursor: pointer; background: transparent; border: none; font-size: 1.15rem; transition: 0.2s; display: flex; align-items: center; justify-content: center; color: white; width: 20px; }
        .top-icon-btn i { text-align: center; width: 100%; transition: 0.2s; }
        .top-icon-btn:hover { transform: scale(1.1); }
        
        .notif-badge { display: none; position: absolute; top: -6px; right: -8px; background: var(--danger); color: white; font-size: 0.65rem; font-weight: bold; padding: 2px 5px; border-radius: 50px; border: 2px solid var(--ps-bg); }
        .notif-badge.active { display: block; }

        /* NEW NOTIFICATION POPOVER (Replaces the Center Modal) */
        .notif-popover { position: absolute; top: 65px; right: 0; width: 350px; background: rgba(0,5,15,0.95); border: 1px solid var(--glass-border); border-top: 3px solid var(--ps-glow); border-radius: 8px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; flex-direction: column; z-index: 100000; box-shadow: 0 25px 50px rgba(0,0,0,0.9); transform-origin: top right; transition: all 0.2s ease-out; opacity: 1; transform: scale(1); }
        .notif-popover.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .notif-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--glass-border); font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 1px; flex-shrink: 0;}
        .notif-actions { display: flex; gap: 10px; }
        .notif-action-btn { background: transparent; border: none; color: var(--text-muted); font-size: 0.8rem; font-weight: 800; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .notif-action-btn:hover { color: white; }
        .notif-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .notif-action-btn.del:hover:not(:disabled) { color: var(--danger); }
        
        .notif-popover-list { display: flex; flex-direction: column; gap: 8px; padding: 15px; max-height: 400px; overflow-y: auto; overflow-x: hidden; }
        .notif-item { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; gap: 5px; position: relative; transition: 0.2s; }
        .notif-item.unread { border-left: 3px solid var(--ps-glow); background: rgba(0,162,255,0.05); }
        .notif-item-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; font-weight: 900; text-transform: uppercase; }
        .notif-item-title { color: white; }
        .notif-item.unread .notif-item-title { color: var(--ps-glow); }
        .notif-item-time { color: var(--text-muted); font-weight: 600; font-size: 0.75rem; }
        .notif-item-body { font-size: 0.9rem; color: var(--text-muted); line-height: 1.4; padding-right: 20px;}
        .notif-item-del { position: absolute; right: 12px; bottom: 12px; background: transparent; border: none; color: var(--text-muted); font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .notif-item-del:hover { color: var(--danger); transform: scale(1.1); }

        /* MAIN RIGID WRAPPER */
        @media (min-width: 769px) {
            .main-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; height: calc(100vh - 75px); margin-top: 75px; overflow: hidden;}
            .content { width: 100%; max-width: 1400px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 2rem; flex: 1;}
        }

        .view-container { width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; }
        
        .header-title { font-size: 3rem; font-weight: 900; margin: 0 0 2rem 0; text-transform: uppercase; letter-spacing: 2px; color: white; text-shadow: 0 2px 15px rgba(0,0,0,0.8); text-align: center; width: 100%;}
        .casino-title { font-size: 4rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; margin: 0 0 3rem 0; line-height: 1.1; color: white; text-shadow: 0 0 20px rgba(255,255,255,0.2); text-align: center; }
        
        .lobby-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .lobby-modes-container { display: flex; gap: 40px; justify-content: center; width: 100%; max-width: 900px; flex-wrap: wrap; }
        
        /* MASSIVE PORTRAIT HOME CARDS (Blueprint) */
        .mode-card { width: clamp(300px, 100%, 340px); height: 460px; text-align: center; cursor: pointer; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; border-radius: 16px; background: var(--glass-bg); border: 1px solid var(--glass-border); transition: 0.3s; overflow: hidden; flex-shrink: 0; }
        .mode-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(255,255,255,0.05), transparent); z-index: 1; }
        .mode-card:hover { transform: translateY(-10px); border-color: var(--ps-glow); box-shadow: 0 15px 40px rgba(0, 162, 255, 0.2); background: rgba(0, 30, 60, 0.8); }
        .mode-icon { font-size: 6rem; margin-bottom: 2.5rem; color: var(--ps-light-blue); transition: 0.3s; position: relative; z-index: 2; }
        .mode-card:hover .mode-icon { transform: scale(1.1); color: white; text-shadow: 0 0 20px var(--ps-glow); }
        .mode-title { font-size: 2.2rem; font-weight: 900; color: white; text-transform: uppercase; margin-bottom: 12px; position: relative; z-index: 2; letter-spacing: 1px; white-space: nowrap; }
        .mode-desc { color: var(--text-muted); font-size: 1.1rem; position: relative; z-index: 2; font-weight: 600; line-height: 1.6; }

        /* STRICT VERTICAL CARDS GRID FOR GAMES (Blueprint) */
        .casino-grid { display: flex; flex-wrap: wrap; gap: 2.5rem; justify-content: center; align-items: center; width: 100%; max-width: 1300px; margin: 0 auto; }
        .casino-grid.solo-grid { max-width: 1000px; } 

        .game-card { width: 280px; height: 400px; cursor: pointer; display: flex; flex-direction: column; position: relative; border-radius: 16px; overflow: hidden; background: var(--glass-bg); border: 1px solid var(--glass-border); transition: 0.3s; flex-shrink: 0;}
        .game-card:hover { transform: translateY(-8px); border-color: var(--glass-hover); box-shadow: 0 15px 35px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,255,0.1); }
        .game-img { flex: 1; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; font-size: 5rem; color: var(--ps-light-blue); transition: 0.3s; position: relative; }
        .game-card:hover .game-img { color: white; text-shadow: 0 0 25px var(--ps-glow); background: rgba(0,30,70,0.4); }
        .game-info { height: 110px; padding: 15px; text-align: center; background: rgba(0, 5, 15, 0.95); border-top: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 5px; justify-content: center; flex-shrink: 0;}
        .game-title { font-size: 1.3rem; font-weight: 900; color: white; text-transform:uppercase; letter-spacing: 1px; margin: 0; } 
        .game-desc { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; line-height: 1.3; }

        .active-players { position: absolute; top: 15px; left: 15px; color: var(--success); font-size: 1rem; font-weight: 800; z-index: 10; display: flex; align-items: center; gap: 6px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        /* BACK NAVIGATION ALIGNED */
        .game-wrapper { width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: center;}
        .game-wrapper.solo-wrap { max-width: 850px; }
        
        .back-nav { margin-bottom: 15px; width: 100%; display: flex; justify-content: flex-start;}
        .btn-back { background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 800; font-size: 1rem; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; backdrop-filter: blur(10px); text-transform: uppercase; letter-spacing: 1px; }
        .btn-back:hover { background: white; color: black; box-shadow: 0 5px 15px rgba(255,255,255,0.2); }

        /* ================= IN-GAME UI PANELS ================= */
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.6); overflow: hidden; display: flex; flex-direction: column; transition: 0.3s; width: 100%;}
        .glass-header { background: rgba(0,0,0,0.7); padding: 15px 20px; border-bottom: 1px solid var(--glass-border); color: white; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .glass-header h2 { margin:0; font-size: 1.6rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; line-height: 1; }

        /* Game Box and Panels strictly fixed height so nothing grows on PC */
        .game-box { display: flex; flex-direction: column; width: 100%; max-width: 850px; background: var(--glass-bg); border-radius: 12px; border: 1px solid var(--glass-border); box-shadow: 0 15px 35px rgba(0,0,0,0.6); overflow: hidden; height: 650px;} 
        .main-panel { display: flex; flex-direction: column; height: 100%; }
        .game-display { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; overflow: hidden; perspective: 1000px; padding: 20px;}
        
        .controls-grid { display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 25px; background: rgba(0,0,0,0.8); border-top: 1px solid var(--glass-border); flex-shrink: 0; } 
        .controls-full { display: flex; gap: 15px; justify-content: center; width: 100%; }

        .shared-layout { display: flex; gap: 20px; width: 100%; height: 650px; align-items: stretch; justify-content: center; }
        .chat-panel { width: 320px; flex-shrink: 0; display: flex; flex-direction: column; height: 100%; }
        .chat-body { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto;}
        .chat-msg { background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 8px; border-left: 3px solid var(--ps-light-blue); animation: popIn 0.2s ease-out; flex-shrink: 0;}
        .chat-user { font-weight: 900; color: var(--ps-glow); margin-bottom: 5px; text-transform: uppercase; font-size: 0.85rem;}
        .chat-sys { border-left-color: var(--success); color: var(--success); font-style: italic; font-weight: 600;}

        /* TIMER */
        .timer-box { background: rgba(0,0,0,0.8); border: 1px solid var(--glass-border); padding: 0 15px; height: 44px; border-radius: 8px; color: white; font-weight: 900; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.5); transition: 0.3s; font-family: 'Rajdhani', monospace;} 
        .timer-box.closing { border-color: var(--danger); color: var(--danger); box-shadow: 0 0 20px rgba(255, 51, 102, 0.4); animation: shake 0.5s infinite;}
        .timer-sec { font-size: 0.7em; margin-left: 2px; font-weight: 600; color: var(--text-muted); }

        /* SHARED BET BUTTONS & ACTIVE BET OUTLINE */
        .bet-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; width: 100%; }
        .bet-grid.perya-grid { grid-template-columns: repeat(3, 1fr); gap: 10px;}
        .bet-btn { background: rgba(0,0,0,0.6); border: 1px solid var(--glass-border); color: white; padding: 15px 10px; min-height: 50px; border-radius: 8px; font-weight: 900; font-size: 1.1rem; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;}
        .bet-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

        .bet-btn.has-bet { 
            border-top: 2px solid var(--tile-color, var(--ps-glow)) !important;
            border-left: 2px solid var(--tile-color, var(--ps-glow)) !important;
            border-right: 2px solid var(--tile-color, var(--ps-glow)) !important;
            box-shadow: inset 0 0 15px rgba(255,255,255,0.1), 0 -5px 20px rgba(0,0,0,0.6); 
            color: #fff !important; 
            text-shadow: 0 0 10px var(--tile-color, var(--ps-glow)); 
            transform: translateY(-3px); 
        }
        .bet-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; border-color: var(--glass-border) !important; color: var(--text-muted) !important; }

        /* MODALS - SIZED TO FIT CONTENT (PlayStation Theme / Glassmorphism) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 100000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .modal-content { background: rgba(0, 5, 15, 0.9); width: 600px; max-width: 95vw; padding: 2.5rem; border-radius: 12px; border: 1px solid rgba(0, 162, 255, 0.4); border-top: 3px solid var(--ps-glow); color: white; box-shadow: 0 25px 80px rgba(0,0,0,0.9), inset 0 0 30px rgba(0, 162, 255, 0.1); position: relative; display: flex; flex-direction: column; height: auto; max-height: 90vh; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);}
        .modal-close-icon { position: absolute; top: 25px; right: 25px; font-size: 1.8rem; color: var(--text-muted); cursor: pointer; transition: 0.2s; z-index: 10;}
        .modal-close-icon:hover { color: var(--danger); transform: scale(1.1); }
        .modal-content h3 { font-size: 1.8rem; font-weight: 900; margin-bottom: 1.5rem; margin-top: 0; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; text-align: center; flex-shrink: 0; color: white;}

        .bank-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; flex-shrink: 0;}
        .bank-tab { flex: 1; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-muted); font-weight: 900; padding: 12px; cursor: pointer; text-transform: uppercase; transition: 0.2s; font-size: 1.1rem; letter-spacing: 1px;}
        .bank-tab:hover { color: white; }
        .bank-tab.active { border-bottom: 3px solid var(--ps-glow); color: var(--ps-glow); }
        .bank-section { display: none; flex: 1; padding-right: 15px;}
        .bank-section.active { display: block; }
        
        .btn-ledger { background: rgba(0,0,0,0.5); color: white; border: 1px solid var(--glass-border); border-left: 3px solid var(--ps-glow); width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 8px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: center; align-items: center; gap: 10px;}
        .btn-ledger:hover { background: rgba(255,255,255,0.1); border-color: white; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,162,255,0.2);}

        /* Quick Chips for Cashier */
        .quick-chips { display: flex; gap: 10px; justify-content: space-between; margin-bottom: 20px; }
        .chip-btn { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; padding: 8px 0; border-radius: 6px; font-size: 0.85rem; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .chip-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }

        /* Solid Header Backgrounds to fix scroll overlap */
        thead th { position: sticky; top: 0; background: #000a1f; z-index: 10; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; border-bottom: 1px solid var(--glass-border); padding: 10px 15px;}

        /* DAILY REWARD */
        .dr-days { display: flex; gap: 10px; justify-content: center; align-items: flex-end; margin-bottom: 25px; height: 160px; }
        .dr-day { flex: 1; background: linear-gradient(180deg, #1a2a6c 0%, #001f4d 100%); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 10px 5px; height: 130px; transition: 0.3s; position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .dr-day::before { content: ''; position: absolute; inset: -50%; background: repeating-conic-gradient(rgba(255,255,255,0.08) 0 15deg, transparent 15deg 30deg); z-index: 0; opacity: 0.8; animation: rotateBurst 20s linear infinite; }
        @keyframes rotateBurst { 100% { transform: rotate(360deg); } }

        .dr-day > * { position: relative; z-index: 1; }
        .dr-day.claimed { background: rgba(255,255,255,0.05); filter: grayscale(1); opacity: 0.6; border-color: var(--glass-border); box-shadow: none;}
        .dr-day.claimed::before { display: none; }

        /* Active Day -> Huge, Gold, WITH Sunburst Animation */
        .dr-day.active { background: linear-gradient(180deg, #ffcc00 0%, #ff9900 100%); border: 2px solid #fff; transform: scale(1.1); opacity: 1; z-index: 5; box-shadow: 0 10px 25px rgba(255, 204, 0, 0.4); height: 150px; color: black; }
        .dr-day.active::before { background: repeating-conic-gradient(rgba(255,255,255,0.3) 0 15deg, transparent 15deg 30deg); opacity: 0.6; display: block;}
        .dr-day.active .dr-title, .dr-day.active .dr-coin { color: #000; text-shadow: none; }

        /* Active-Claimed: Keeps Huge Size, removes gold/animation, grays out */
        .dr-day.active.active-claimed { background: rgba(255,255,255,0.1); border: 2px solid var(--glass-border); filter: grayscale(1); opacity: 0.8; box-shadow: none; color: white;}
        .dr-day.active.active-claimed .dr-title, .dr-day.active.active-claimed .dr-coin { color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .dr-day.active.active-claimed::before { display: none; }

        .dr-title { font-size: 0.9rem; text-transform: uppercase; font-weight: 900; margin-top: 5px; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.5); text-align: center;}
        .dr-coin { font-size: 1rem; font-weight: 900; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.5); text-align: center; margin-bottom: 5px;}

        .dr-claim-btn { width: 100%; max-width: 250px; margin: 0 auto; background: #ffcc00; color: #000; font-size: 1.2rem; border: 2px solid #fff; box-shadow: 0 5px 15px rgba(255,204,0,0.4); }
        .dr-claim-btn:hover:not(:disabled) { background: #ff9900; color: #000; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255,204,0,0.6);}
        .dr-claim-btn:disabled { background: rgba(255,255,255,0.1) !important; border-color: transparent !important; color: var(--text-muted) !important; box-shadow: none !important; cursor: not-allowed !important; transform: none !important;}

        #dr-status-container { text-align: center; margin-top: 10px; }
        .dr-status-text { font-size: 1.2rem; font-weight: 900; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; }
        .dr-timer { font-size: 1.5rem; font-weight: 900; color: var(--ps-glow); font-family: 'Rajdhani', sans-serif; }

        /* BACCARAT TEXT & IN-GAME NOTIFS */
        #bac-action-text { height: 24px; color: var(--ps-glow); font-weight: 800; text-align: center; margin-top: 40px; letter-spacing: 1px; text-transform: uppercase; font-size: 1.1rem; text-shadow: 0 0 10px rgba(0,162,255,0.5); }

        /* GLOBAL TOAST (Top Right) */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(0, 5, 15, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(0, 162, 255, 0.4); color: white; padding: 15px 25px; border-radius: 8px; display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1rem; transform: translateX(120%); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0, 162, 255, 0.25); text-transform: uppercase;}
        .toast.show { transform: translateX(0); }
        .toast-success { border-left: 5px solid var(--ps-glow); }
        .toast-success i { color: var(--ps-glow); font-size: 1.3rem;}
        .toast-error { border-left: 5px solid var(--danger); border-color: rgba(255, 51, 102, 0.4); box-shadow: 0 10px 30px rgba(255, 51, 102, 0.25); }
        .toast-error i { color: var(--danger); font-size: 1.3rem;}

        /* EXACT GREEN/RED RESULT BOXES FOR BOTH SOLO AND SHARED */
        .result-box, .result-overlay-shared { position: absolute; bottom: 20px; right: 20px; left: auto; top: auto; transform: translateX(120%); opacity: 0; text-align: right; padding: 15px 30px; font-weight: 600; font-size: 1.1rem; border-radius: 8px; display: none; z-index: 100; min-width: 250px; text-transform: uppercase; backdrop-filter: blur(20px); box-shadow: 0 15px 40px rgba(0,0,0,0.8); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .result-box.win, .result-overlay-shared.win { background: rgba(0, 230, 118, 0.15); color: var(--success); border: 1px solid rgba(0, 230, 118, 0.4); border-right: 4px solid var(--success); } 
        .result-box.lose, .result-overlay-shared.lose { background: rgba(255, 51, 102, 0.15); color: var(--danger); border: 1px solid rgba(255, 51, 102, 0.4); border-right: 4px solid var(--danger); } 
        .result-box.push, .result-overlay-shared.push { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-right: 4px solid var(--text-muted); }
        
        .result-overlay-shared { display: flex; flex-direction: column; pointer-events: none; background: rgba(0, 10, 30, 0.85); border: 1px solid rgba(0, 162, 255, 0.4); border-right: 4px solid var(--ps-glow); } 
        .result-box.show, .result-overlay-shared.show { opacity: 1; transform: translateX(0); }
        
        .res-title { font-size: 1.2rem; font-weight: 900; color: white; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; text-align: right; width: 100%; } 
        .res-payout { font-size: 1.4rem; font-weight: 800; text-align: right; width: 100%; }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes popBalance { 0% { transform: scale(1); } 50% { transform: scale(1.1); background: rgba(0, 230, 118, 0.3); border-color: var(--success); } 100% { transform: scale(1); } } .anim-pop { animation: popBalance 0.6s ease-out; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 50% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } 100% { transform: rotate(0deg); } } .anim-shake { animation: shake 0.3s infinite; }
        
        /* PROMO POP ANIMATION */
        @keyframes giftPop { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); text-shadow: 0 0 20px var(--ps-glow); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .anim-gift { animation: giftPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* GAME ASSETS */
        .blackjack-scores { display: flex; justify-content: center; gap: 40px; width: 100%; align-items: flex-start; } .card-area { min-width: 250px; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 240px; } .bj-title { font-size: 1.1rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-muted); margin-bottom: 5px; font-weight: 600; } .bj-score { font-size: 2.5rem; font-weight: 800; color: white; margin-bottom: 15px; line-height: 1; } .card-hand { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; width: 100%; } .play-card { background: white; color: black; border-radius: 6px; width: 65px; height: 95px; border: 1px solid #ccc; box-shadow: 2px 5px 15px rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 800; } .play-card .val { font-size: 1.6rem; line-height: 1; margin-bottom: 2px; } .play-card .suit { font-size: 1.8rem; line-height: 1; } .card-red { color: #e60000; } .card-back { background: repeating-linear-gradient(45deg, #001f4d, #001f4d 10px, #000a1f 10px, #000a1f 20px); border: 2px solid rgba(255,255,255,0.8); color: transparent; }
        .anim-deal { animation: dealCard 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; transform-origin: center; } @keyframes dealCard { 0% { opacity: 0; transform: translate(0, -200px) scale(0.5) rotateY(180deg); } 100% { opacity: 1; transform: translate(0, 0) scale(1) rotateY(0deg); } } .anim-flip { animation: flipCard 0.4s ease-in-out forwards; } @keyframes flipCard { 0% { transform: rotateY(180deg); } 50% { transform: rotateY(90deg); color: transparent; } 51% { color: inherit; background: white; } 100% { transform: rotateY(0deg); background: white; color: black; } }
        .dice-icon { font-size: 7rem; color: var(--text-muted); text-shadow: 0 10px 30px rgba(0,0,0,0.8); transition: 0.1s; line-height: 1; } #dice-num { font-size: 6rem !important; line-height: 1; text-shadow: 0 10px 30px rgba(0,0,0,0.8); font-weight: 900 !important; }
        .coin-wrapper { perspective: 1000px; width: 200px; height: 200px; margin: 0 auto; display: flex; justify-content: center; align-items: center; } .coin-inner { width: 100%; height: 100%; transition: transform 2.5s cubic-bezier(0.25, 1, 0.2, 1); transform-style: preserve-3d; position: relative; } .coin-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; font-size: 5rem; font-weight: 900; border-radius: 50%; box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 15px 40px rgba(0,0,0,0.9); border: 8px solid; } .coin-heads { background: radial-gradient(circle at 30% 30%, #fde047, #b45309); color: #78350f; border-color: #f59e0b; } .coin-tails { background: radial-gradient(circle at 30% 30%, #e2e8f0, #475569); color: #0f172a; border-color: #94a3b8; transform: rotateY(180deg); } .tossing { animation: toss 2.5s cubic-bezier(0.25, 1, 0.2, 1); } @keyframes toss { 0% { transform: scale(1) translateY(0); } 50% { transform: scale(1.5) translateY(-50px); } 100% { transform: scale(1) translateY(0); } }

        /* SHARED GAMES SPECIFICS */
        .color-dice-container { display: flex; gap: 30px; justify-content: center; font-size: 6rem; margin-bottom: 20px; } .color-die { width: 130px; height: 130px; border-radius: 16px; border: 2px solid rgba(255,255,255,0.3); box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 15px 30px rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; color: white; transition: 0.3s; background: #111; font-weight: 800;} .c-grey { background: radial-gradient(circle, #333, #0a0a0a); color: rgba(255,255,255,0.4); border-color: #444; } .c-red { background: radial-gradient(circle, #ff3366, #99002b); border-color: #ff3366;} .c-blue { background: radial-gradient(circle, #00a2ff, #003d66); border-color: #00a2ff;} .c-yellow { background: radial-gradient(circle, #ffcc00, #997a00); border-color: #ffcc00;} .c-white { background: radial-gradient(circle, #ffffff, #999999); color: #000; border-color: #fff;} .c-green { background: radial-gradient(circle, #00e676, #006634); border-color: #00e676;} .c-pink { background: radial-gradient(circle, #ff66b2, #99004d); border-color: #ff66b2;}
        .dt-arena { display: flex; justify-content: center; gap: 80px; width: 100%; align-items: center; margin-bottom: 20px; } .dt-side { display: flex; flex-direction: column; align-items: center; gap: 20px; } .dt-label { font-size: 2rem; font-weight: 900; text-transform: uppercase; letter-spacing: 3px; } .lbl-dragon { color: var(--danger); text-shadow: 0 0 20px rgba(255,51,102,0.6); } .lbl-tiger { color: var(--credits); text-shadow: 0 0 20px rgba(255,180,0,0.6); } .dt-card { width: 120px !important; height: 170px !important; } .dt-card .val { font-size: 3rem; } .dt-card .suit { font-size: 3.5rem; }
        .sicbo-dice { display: flex; justify-content: center; gap: 30px; font-size: 6rem; margin-bottom: 10px; } .s-die { color: white; text-shadow: 0 10px 20px rgba(0,0,0,0.8); }

        /* ================= MOBILE RESPONSIVENESS ================= */
        @media (max-width: 768px) {
            body { height: auto; overflow-y: auto; overflow-x: hidden; }
            .topbar { padding: 10px 15px; height: auto; min-height: 60px; }
            .topbar-inner { flex-direction: row; gap: 10px; justify-content: space-between; flex-wrap: nowrap;}
            .brand-title { font-size: 1.2rem; display: none; } 
            .brand-sub { display: none; }
            .topbar-right { gap: 10px; }
            .player-profile { display: none; } 
            
            .main-wrapper { padding-top: 80px; justify-content: flex-start; padding-bottom: 30px; height: auto; overflow: visible;}
            .casino-title { font-size: 2.2rem; margin-top: 20px;}
            .back-nav { padding: 0 15px; }
            
            .shared-layout { flex-direction: column; height: auto; }
            .chat-panel { width: 100%; height: 300px; margin-top: 15px; }
            .game-box { height: auto; min-height: 500px; }
            
            .blackjack-scores { flex-direction: column; align-items: center; gap: 20px; }
            .color-die { width: 80px; height: 80px; font-size: 3rem; }
            .dt-arena { gap: 20px; }
            .dt-card { width: 80px !important; height: 120px !important; }
            .dt-card .val { font-size: 2rem; }
            .dt-card .suit { font-size: 2.5rem; }
            
            .modal-content { width: 95vw; padding: 25px 20px; }
            .dr-days { flex-wrap: wrap; height: auto; }
            .dr-day { min-width: 60px; height: 90px; }
            .dr-day.active { height: 110px; }
            
            .notif-popover { width: 300px; right: 10px; }
        }
    </style>
</head>
<body>
  
  <div id="toast-container"></div>

  <div id="auth-container">
      <div class="auth-box">
          <div class="auth-title">STICK N' TRADE</div>
          <div class="auth-sub">CASINO</div>
          
          <div class="auth-tabs">
              <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
              <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
          </div>

          <div id="auth-form-login">
              <div class="input-group" style="margin-bottom:20px;">
                  <input type="text" id="login-user" class="input-control" placeholder="Username">
              </div>
              <div class="input-group" style="margin-bottom:15px;">
                  <div class="pwd-input-wrapper">
                      <input type="password" id="login-pass" class="input-control" placeholder="Password">
                      <i class="fas fa-eye" onclick="toggleInputPwd('login-pass', this)"></i>
                  </div>
              </div>
              <div id="auth-error-login" class="auth-msg auth-error"></div>
              <button class="btn-play" style="width:100%;" onclick="submitAuth('login')">LOGIN TO CASINO</button>
          </div>
          
          <div id="auth-form-register" style="display:none;">
              <div class="input-group" style="margin-bottom:20px;">
                  <input type="text" id="reg-user" class="input-control" placeholder="Username">
              </div>
              <div class="input-group" style="margin-bottom:15px;">
                  <div class="pwd-input-wrapper">
                      <input type="password" id="reg-pass" class="input-control" placeholder="Password">
                      <i class="fas fa-eye" onclick="toggleInputPwd('reg-pass', this)"></i>
                  </div>
              </div>
              <div id="auth-error-register" class="auth-msg auth-error"></div>
              <button class="btn-play" style="width:100%; border-color:var(--success); color:var(--success);" onclick="submitAuth('register')">CREATE ACCOUNT</button>
          </div>
      </div>
  </div>

  <div id="app-container">
      
      <header class="topbar">
      <div class="topbar-inner">
        
        <div class="brand" onclick="backToCasino()" title="Return to Lobby">
          <div class="brand-dot"></div>
          <div class="brand-text">
            <div class="brand-title">STICK N' TRADE</div>
            <div class="brand-sub">CASINO</div>
          </div>
        </div>

        <div class="topbar-right">
            
            <div class="player-profile">
                <i class="fas fa-user-circle"></i>
                <span id="player-name-display">Player</span>
            </div>
            
            <div class="wallet-pill" id="pill-credits" onclick="openCashier()" title="Open Cashier">
                <i class="fas fa-coins"></i>
                <span id="nav-credits">0</span>
                <span class="wallet-unit">TC</span>
            </div>
            
            <div class="topbar-actions">
                <button class="top-icon-btn admin-btn hidden" onclick="window.location.href='/admin.html'" title="Admin Panel" style="color:var(--ps-glow);">
                    <i class="fas fa-user-shield"></i>
                </button>
                <button class="top-icon-btn" id="bell-btn" onclick="toggleNotifPopover(event)" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <div class="notif-badge" id="notif-badge-display">0</div>
                    
                    <div id="notif-dropdown" class="notif-popover hidden" onclick="event.stopPropagation()">
                        <div class="notif-header">
                            <span>NOTIFICATIONS</span>
                            <div class="notif-actions">
                                <button class="notif-action-btn" onclick="markAllNotifsRead()"><i class="fas fa-check-double"></i> Read</button>
                                <button class="notif-action-btn del" id="btn-clear-notifs" onclick="clearNotifs()" disabled><i class="fas fa-trash"></i> Clear</button>
                            </div>
                        </div>
                        <div id="notif-list-popover" class="notif-popover-list custom-scroll">
                            <div style="text-align:center; color:var(--text-muted); padding:20px;" id="no-notif-msg">No new notifications.</div>
                        </div>
                    </div>
                </button>
                <button class="top-icon-btn" onclick="openModal('daily-reward-modal')" title="Daily Reward" style="color:var(--credits);">
                    <i class="fas fa-calendar-check"></i>
                </button>
                <button class="top-icon-btn" onclick="openModal('promo-modal')" title="Gift Code" style="color:var(--ps-glow);">
                    <i class="fas fa-gift"></i>
                </button>
                <button class="top-icon-btn" id="mute-btn" onclick="toggleAudio()" title="Toggle Audio">
                    <i class="fas fa-volume-up"></i>
                </button>
                <button class="top-icon-btn" onclick="confirmLogout()" title="Logout" style="color:var(--danger);">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
            
        </div>
      </div>
    </header>
      
      <div class="main-wrapper">
        <div class="content">
          
          <div id="view-casino" class="view-container">
            
            <div class="lobby-wrapper" id="lobby-modes">
              <div style="text-align: center; margin-bottom: 3rem; width:100%;">
                 <h1 class="casino-title">STICK N' TRADE CASINO</h1>
              </div>

              <div class="lobby-modes-container">
                <div class="mode-card glass-panel" onclick="openLobbyMode('indiv')">
                  <i class="fas fa-user mode-icon"></i>
                  <div class="mode-title">SOLO PLAY</div>
                  <div class="mode-desc">Single-player mini games.<br>Quick rounds and instant payouts.</div>
                </div>
                <div class="mode-card glass-panel" onclick="openLobbyMode('shared')">
                  <div class="live-badge"><div class="live-dot"></div> LIVE</div>
                  <i class="fas fa-users mode-icon"></i>
                  <div class="mode-title" style="white-space: nowrap;">SHARED TABLES</div>
                  <div class="mode-desc">Multiplayer game rooms.<br>Play with others live.</div>
                </div>
              </div>
            </div>

            <div class="lobby-wrapper hidden" id="lobby-indiv">
              <div class="game-wrapper solo-wrap">
                  <div class="back-nav"><button class="btn-back" onclick="openLobbyMode('modes')"><i class="fas fa-arrow-left"></i> Back to Hub</button></div>
                  <h2 class="header-title" style="align-self: center;">Solo Play</h2>
                  <div class="casino-grid solo-grid">
                    <div class="game-card glass-panel" onclick="openGame('dice')">
                        <div class="game-img"><i class="fas fa-dice"></i></div><div class="game-info"><div class="game-title">Dice Roll</div><div class="game-desc">Roll over 50. Pays x2.</div></div>
                    </div>
                    <div class="game-card glass-panel" onclick="openGame('coinflip')">
                        <div class="game-img"><i class="fas fa-coins"></i></div><div class="game-info"><div class="game-title">Coin Flip</div><div class="game-desc">Heads or Tails. Pays x2.</div></div>
                    </div>
                    <div class="game-card glass-panel" onclick="openGame('blackjack')">
                        <div class="game-img"><i class="fas fa-spade">‚ô†Ô∏è</i></div><div class="game-info"><div class="game-title">Blackjack</div><div class="game-desc">Beat the dealer to 21.</div></div>
                    </div>
                  </div>
              </div>
            </div>

            <div class="lobby-wrapper hidden" id="lobby-shared">
              <div class="game-wrapper">
                  <div class="back-nav"><button class="btn-back" onclick="openLobbyMode('modes')"><i class="fas fa-arrow-left"></i> Back to Hub</button></div>
                  <h2 class="header-title" style="align-self: center;">Shared Tables</h2>
                  <div class="casino-grid shared-grid">
                    <div class="game-card glass-panel" onclick="openSharedGame('baccarat')">
                        <div class="active-players"><i class="fas fa-users"></i> <span class="ap-count">0</span></div>
                        <div class="game-img"><i class="fas fa-cards">üÉè</i></div><div class="game-info"><div class="game-title">Baccarat</div><div class="game-desc">Closest to 9 wins.</div></div>
                    </div>
                    <div class="game-card glass-panel" onclick="openSharedGame('perya')">
                        <div class="active-players"><i class="fas fa-users"></i> <span class="ap-count">0</span></div>
                        <div class="game-img"><i class="fas fa-dice-d6"></i></div><div class="game-info"><div class="game-title">Color Game</div><div class="game-desc">Classic 3-dice color drop.</div></div>
                    </div>
                    <div class="game-card glass-panel" onclick="openSharedGame('dt')">
                        <div class="active-players"><i class="fas fa-users"></i> <span class="ap-count">0</span></div>
                        <div class="game-img"><i class="fas fa-dragon"></i></div><div class="game-info"><div class="game-title">Dragon Tiger</div><div class="game-desc">Highest card takes all.</div></div>
                    </div>
                    <div class="game-card glass-panel" onclick="openSharedGame('sicbo')">
                        <div class="active-players"><i class="fas fa-users"></i> <span class="ap-count">0</span></div>
                        <div class="game-img"><i class="fas fa-dice"></i></div><div class="game-info"><div class="game-title">Sic Bo</div><div class="game-desc">Asian 3-dice betting.</div></div>
                    </div>
                  </div>
              </div>
            </div>
          </div>

          <div id="view-game-dice" class="view-container hidden">
            <div class="game-wrapper solo-wrap">
                <div class="back-nav"><button class="btn-back" onclick="backToSoloLobby()"><i class="fas fa-arrow-left"></i> Leave Table</button></div>
                <div class="game-box">
                  <div class="main-panel">
                    <div class="glass-header">
                        <h2 style="margin:0; line-height:1;">Dice Roll</h2>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-rules" onclick="openRules('dice')" title="How to Play"><i class="fas fa-info-circle"></i></button>
                            <button class="btn-rules" onclick="openHistory('dice')" title="History"><i class="fas fa-list-alt"></i></button>
                        </div>
                    </div>
                    <div class="game-display">
                      <i class="fas fa-dice-d20 dice-icon" id="dice-icon"></i>
                      <div id="dice-num" style="display:none; color:white; font-weight:900;">0</div>
                      <div id="dice-msg" class="result-box"></div>
                    </div>
                    <div class="controls-grid">
                      <div style="display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 300px; margin: 0 auto; gap: 15px;">
                          <div class="input-group" style="margin:0; width: 100%;">
                              <label style="text-align:center">BET AMOUNT</label>
                              <input type="number" id="dice-bet" class="input-control bet-input" placeholder="10">
                          </div>
                          <button class="btn-play" id="btn-dice" onclick="playDice()" style="width: 100%;">ROLL DICE</button>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
          </div>

          <div id="view-game-coinflip" class="view-container hidden">
            <div class="game-wrapper solo-wrap">
                <div class="back-nav"><button class="btn-back" onclick="backToSoloLobby()"><i class="fas fa-arrow-left"></i> Leave Table</button></div>
                <div class="game-box">
                  <div class="main-panel">
                    <div class="glass-header">
                        <h2 style="margin:0; line-height:1;">Coin Flip</h2>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-rules" onclick="openRules('coinflip')" title="How to Play"><i class="fas fa-info-circle"></i></button>
                            <button class="btn-rules" onclick="openHistory('coinflip')" title="History"><i class="fas fa-list-alt"></i></button>
                        </div>
                    </div>
                    <div class="game-display">
                      <div class="coin-wrapper" id="coin-wrapper">
                        <div class="coin-inner" id="coin-obj">
                          <div class="coin-face coin-heads"><i class="fas fa-coins"></i></div>
                          <div class="coin-face coin-tails"><i class="fas fa-gem"></i></div>
                        </div>
                      </div>
                      <div id="coin-msg" class="result-box"></div>
                    </div>
                    <div class="controls-grid">
                      <div style="display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 300px; margin: 0 auto; gap: 15px;">
                          <div class="input-group" style="margin:0; width: 100%;">
                              <label style="text-align:center">BET AMOUNT</label>
                              <input type="number" id="coin-bet" class="input-control bet-input" placeholder="10">
                          </div>
                          <div style="display:flex; gap:10px; width:100%; justify-content:center;">
                              <button class="btn-play" id="btn-heads" onclick="playCoin('Heads')" style="flex:1; background: rgba(255,180,0,0.2); border-color: var(--credits);">Heads</button>
                              <button class="btn-play" id="btn-tails" onclick="playCoin('Tails')" style="flex:1; background: rgba(255,255,255,0.1); border-color: white;">Tails</button>
                          </div>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
          </div>

          <div id="view-game-blackjack" class="view-container hidden">
            <div class="game-wrapper solo-wrap">
                <div class="back-nav"><button class="btn-back" onclick="backToSoloLobby()"><i class="fas fa-arrow-left"></i> Leave Table</button></div>
                <div class="game-box">
                  <div class="main-panel">
                    <div class="glass-header">
                        <h2 style="margin:0; line-height:1;">Blackjack</h2>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-rules" onclick="openRules('blackjack')" title="How to Play"><i class="fas fa-info-circle"></i></button>
                            <button class="btn-rules" onclick="openHistory('blackjack')" title="History"><i class="fas fa-list-alt"></i></button>
                        </div>
                    </div>
                    <div class="game-display">
                      <div class="blackjack-scores">
                        <div class="card-area"><div class="bj-title">Dealer</div><div class="bj-score" id="bj-d-score">0</div><div class="card-hand" id="bj-d-hand"></div></div>
                        <div class="card-area"><div class="bj-title">You</div><div class="bj-score" id="bj-p-score">0</div><div class="card-hand" id="bj-p-hand"></div></div>
                      </div>
                      <div id="bj-msg" class="result-box"></div>
                    </div>
                    
                    <div class="controls-grid" id="bj-start-controls">
                      <div style="display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 300px; margin: 0 auto; gap: 15px;">
                          <div class="input-group" style="margin:0; width: 100%;">
                              <label style="text-align:center">BET AMOUNT</label>
                              <input type="number" id="bj-bet" class="input-control bet-input" placeholder="10">
                          </div>
                          <button class="btn-play" onclick="startBlackjack()" id="btn-bj-deal" style="width: 100%;">DEAL CARDS</button>
                      </div>
                    </div>

                    <div class="controls-grid hidden" id="bj-action-controls">
                      <div style="display:flex; justify-content:center; gap:15px; width: 100%; max-width: 400px; margin: 0 auto;">
                          <button class="btn-play" onclick="hitBlackjack()" id="btn-bj-hit" style="flex:1; background: rgba(0,162,255,0.2); border-color: var(--ps-glow); color: var(--ps-glow);"><i class="fas fa-hand-point-down"></i> HIT</button>
                          <button class="btn-play" onclick="standBlackjack()" id="btn-bj-stand" style="flex:1; background: rgba(255,51,102,0.2); border-color: var(--danger); color: var(--danger);"><i class="fas fa-hand-paper"></i> STAND</button>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
          </div>

          <div id="view-shared-game" class="view-container hidden">
            <div class="game-wrapper" style="max-width: 1200px;">
                <div class="back-nav"><button class="btn-back" onclick="backToSharedLobby()"><i class="fas fa-arrow-left"></i> Leave Table</button></div>
                
                <div class="shared-layout">
                  <div class="main-panel glass-panel">
                    <div class="glass-header">
                      <h2 id="sg-title" style="margin:0; line-height:1;">Table</h2>
                      <div style="display:flex; align-items:center; gap:8px;">
                          <div class="timer-box" id="sg-timer-box">
                              <i class="fas fa-clock"></i> 
                              <div style="display:flex; align-items:baseline;"><span id="sg-timer">15</span><span class="timer-sec">s</span></div>
                          </div>
                          <button class="btn-rules" onclick="openRules(window.activeSharedGame)" title="How to Play"><i class="fas fa-info-circle"></i></button>
                          <button class="btn-rules" onclick="openHistory(window.activeSharedGame)" title="History"><i class="fas fa-history"></i></button>
                      </div>
                    </div>
                    
                    <div class="game-display" id="sg-display"></div>
                    
                    <div class="controls-grid" style="padding:25px; border-top: 1px solid var(--glass-border);" id="sg-controls-container">
                      </div>
                  </div>
                  
                  <div class="glass-panel chat-panel">
                    <div class="glass-header">
                        <div>LIVE CHAT</div>
                        <div style="display:flex; align-items:center; gap:10px; font-size: 0.95rem; font-weight:800;">
                            <div style="display:flex; align-items:center; gap:6px; color:var(--success);"><i class="fas fa-users"></i> <span id="sg-active-players">0</span></div>
                        </div>
                    </div>
                    <div class="chat-body custom-scroll" id="sg-chat">
                        <div class="chat-msg chat-sys">Connected to server.</div>
                    </div>
                    <div style="padding:15px; border-top:1px solid var(--glass-border); flex-shrink: 0;">
                        <input type="text" id="chat-input" class="input-control" placeholder="Say something..." onkeypress="if(event.key==='Enter'){sendChat();}">
                    </div>
                  </div>
                  
                </div>
            </div>
          </div>

        </div>
      </div>
  </div>

  <div id="current-bets-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 350px;">
        <i class="fas fa-times modal-close-icon" onclick="closeModal('current-bets-modal')"></i>
        <h3 style="margin-top:0;">My Bets</h3>
        <div id="cb-list" class="custom-scroll" style="max-height: 300px; display: flex; flex-direction: column; gap: 8px;"></div>
    </div>
  </div>

  <div id="promo-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 400px; height: auto; min-height: fit-content;">
        <i class="fas fa-times modal-close-icon" onclick="closeModal('promo-modal')"></i>
        <h3 style="margin-top:0;">REDEEM CODE</h3>
        <p style="color:var(--text-muted); text-align:center; margin-bottom: 20px;">Enter your gift code below to claim free TC.</p>
        <div class="input-group" style="margin-bottom:10px;">
            <input type="text" id="promo-code" class="input-control bet-input" placeholder="XXXX-XXXX-XXXX">
        </div>
        <button class="btn-play" style="width:100%; margin-top: 10px;" onclick="submitPromo()">REDEEM</button>
        <div id="promo-response" style="text-align:center; font-weight:800; min-height:25px; margin-top:15px; font-size: 1.1rem; line-height:1.4;"></div>
    </div>
  </div>

  <div id="daily-reward-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 800px; height: auto; min-height: fit-content; max-width: 95vw;">
      <i class="fas fa-times modal-close-icon" onclick="closeModal('daily-reward-modal')"></i>
      <h3 style="font-size: 2.2rem; color: var(--credits); margin-bottom: 5px; border: none; padding-bottom: 0;">Daily Reward</h3>
      <p style="text-align: center; color: var(--text-muted); margin-bottom: 25px;">Claim credits every 24 hours!</p>
      <div class="dr-days" id="dr-days-container"></div>
      <div id="dr-status-container"></div>
    </div>
  </div>

  <div id="support-center-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 500px; height: auto;">
      <i class="fas fa-times modal-close-icon" onclick="closeModal('support-center-modal')"></i>
      <h3 style="margin-bottom: 20px;">CASHIER</h3>
      
      <button class="btn-ledger" onclick="switchSupportCenterTab('ledger', null)"><i class="fas fa-book"></i> VIEW FULL LEDGER</button>

      <div class="bank-tabs" id="cashier-tabs-nav">
        <button class="bank-tab active" onclick="switchSupportCenterTab('deposit', this)">Deposit</button>
        <button class="bank-tab" onclick="switchSupportCenterTab('withdraw', this)">Withdraw</button>
        <button class="bank-tab" onclick="switchSupportCenterTab('requests', this)">Requests</button>
      </div>

      <div id="sc-tab-deposit" class="bank-section active">
        <div style="background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left;">
            <div style="color:var(--text-muted); font-size: 0.8rem; font-weight: 800; margin-bottom: 5px;">SEND PAYMENT TO:</div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight: 900; color: white; font-size: 1.1rem;">GCash: 0912-345-6789</div>
                <button class="btn-rules" style="width: auto; height: 30px; font-size: 0.8rem; padding: 0 10px;" onclick="navigator.clipboard.writeText('09123456789'); showToast('Copied to clipboard!')">üìã COPY</button>
            </div>
            <div style="color:var(--ps-glow); font-size: 0.85rem; font-weight: 800; margin-top: 8px;">Note: Look for AshleyChan for top-ups.</div>
        </div>
        
        <div class="input-group" style="margin-bottom:10px;">
            <label>Amount (TC)</label>
            <input type="number" id="dep-amount" class="input-control" placeholder="e.g. 5000">
        </div>
        <div class="quick-chips">
            <button class="chip-btn" onclick="addAmount('dep-amount', 1000)">+ 1,000</button>
            <button class="chip-btn" onclick="addAmount('dep-amount', 5000)">+ 5,000</button>
            <button class="chip-btn" onclick="addAmount('dep-amount', 10000)">+ 10,000</button>
        </div>
        <div class="input-group" style="margin-bottom:20px;">
            <label>Proof of Payment</label>
            <input type="file" id="dep-ref" class="input-control" accept="image/*" style="padding: 10px; font-size: 0.95rem; cursor: pointer;">
        </div>
        <button class="btn-play" style="width:100%;" onclick="submitDeposit()"><i class="fas fa-arrow-down"></i> Submit Deposit</button>
        <div id="dep-msg" style="text-align:center; font-weight:800; min-height:20px; margin-top:10px; text-transform:uppercase; font-size:0.9rem;"></div>
      </div>

      <div id="sc-tab-withdraw" class="bank-section hidden">
        <p style="color:var(--text-muted); margin-bottom:15px; font-size:0.95rem; text-align:center;">Withdraw your credits to TC.</p>
        <div class="input-group" style="margin-bottom:10px;">
            <label>Withdraw Amount (TC)</label>
            <input type="number" id="wit-amount" class="input-control" placeholder="e.g. 10000">
        </div>
        <div class="quick-chips">
            <button class="chip-btn" onclick="addAmount('wit-amount', 1000)">+ 1,000</button>
            <button class="chip-btn" onclick="addAmount('wit-amount', 5000)">+ 5,000</button>
            <button class="chip-btn" onclick="document.getElementById('wit-amount').value = myCredits">MAX</button>
        </div>
        <div class="input-group" style="margin-bottom:20px;">
            <label>Username</label>
            <input type="text" id="wit-info" class="input-control" placeholder="e.g. AshleyChan">
        </div>
        <button class="btn-play" style="width:100%;" onclick="submitWithdrawal()"><i class="fas fa-arrow-up"></i> Request Withdrawal</button>
        <div id="wit-msg" style="text-align:center; font-weight:800; min-height:20px; margin-top:10px; text-transform:uppercase; font-size:0.9rem;"></div>
      </div>

      <div id="sc-tab-requests" class="bank-section hidden">
        <div id="bank-logs-container" class="custom-scroll" style="height: 250px; display: flex; flex-direction: column; gap: 8px; padding-right: 5px; overflow-y: auto; overflow-x: hidden;"></div>
      </div>

      <div id="sc-tab-ledger" class="bank-section hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
            <h4 style="color:var(--ps-glow); margin:0; text-transform: uppercase; letter-spacing: 1px;">Credit Ledger</h4>
            <button class="btn-rules" style="width:auto; padding: 5px 15px; height: 35px; font-size: 0.9rem;" onclick="switchSupportCenterTab('deposit', document.querySelectorAll('#cashier-tabs-nav .bank-tab')[0])"><i class="fas fa-arrow-left"></i> BACK</button>
        </div>
        
        <div style="background: rgba(255,180,0,0.1); border: 1px solid rgba(255,180,0,0.4); border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="color: var(--text-muted); font-weight: 800; font-size: 0.8rem; text-transform: uppercase;">Today's Net Profit</div>
            <div id="ledger-daily-profit" style="color: white; font-weight: 900; font-size: 1.2rem;">0 TC</div>
        </div>
        
        <div id="ledger-logs-container" class="custom-scroll" style="height: 200px; display: flex; flex-direction: column; gap: 8px; padding-right: 5px; overflow-y: auto; overflow-x: hidden;"></div>
      </div>
    </div>
  </div>

  <div id="history-modal" class="modal-overlay hidden">
     <div class="modal-content" style="width: 550px; height: 500px; padding: 0;">
        <div style="padding: 20px 25px; border-bottom: 1px solid var(--glass-border); display:flex; justify-content:space-between; align-items:center; flex-shrink: 0;">
             <h3 id="history-title" style="margin:0; border:none; padding:0; font-size:1.5rem; text-transform: uppercase; letter-spacing: 2px;">HISTORY</h3>
             <i class="fas fa-times modal-close-icon" style="position:static;" onclick="closeModal('history-modal')"></i>
        </div>
        
        <div style="padding: 20px; flex:1; display:flex; flex-direction:column; overflow:hidden;">
            <div style="background:rgba(0,0,0,0.5); border:1px solid var(--glass-border); border-radius:8px; padding:15px; text-align:center; flex-shrink: 0; margin-bottom: 20px;">
                <div style="font-weight:900; color:white; font-size:1.1rem; margin-bottom:5px;">TOTAL ROUNDS: <span id="stat-total-rounds" style="color:var(--credits);">0</span></div>
                <div id="stat-percentages" style="display:flex; flex-wrap:wrap; justify-content:center; gap:15px; font-size:0.9rem; font-weight:800;"></div>
            </div>
            
            <div style="font-weight:900; color:white; font-size:1rem; text-transform:uppercase; letter-spacing:1px; margin-bottom: 10px; text-align: center; flex-shrink: 0;">FIVE RECENT OUTCOMES</div>
            
            <div style="flex:1; border:1px solid var(--glass-border); border-radius:8px; background:rgba(0,5,15,0.8); display:flex; flex-direction:column; overflow: hidden;">
                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding:15px 15px 10px 15px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.8rem; font-weight:900; color:var(--text-muted); text-align:center; text-transform:uppercase; flex-shrink: 0; background: rgba(0,0,0,0.8);">
                    <div>Result</div><div>Bets</div><div style="color:var(--success)">Win</div><div style="color:var(--danger)">Loss</div>
                </div>
                
                <div id="history-items" class="custom-scroll" style="flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:8px;">
                    </div>
            </div>
        </div>
     </div>
  </div>

  <div id="rules-modal" class="modal-overlay hidden">
     <div class="modal-content" style="width: 500px; height: auto; min-height: fit-content; padding: 2.5rem;">
        <i class="fas fa-times modal-close-icon" onclick="closeModal('rules-modal')"></i>
        <h3 id="rules-title" style="margin-top:0;">How to Play</h3>
        <div id="rules-body" style="color:var(--text-muted); font-size:1rem; line-height:1.6; padding: 0 10px; text-align: left;"></div>
     </div>
  </div>

  <script>
    const socket = io(); 
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let audioMuted = false;
    let sfxGainVal = 0.8;
    
    let myUsername = '';
    let myCredits = 0;
    let myGameHistory = { dice: [], coinflip: [], baccarat: [], blackjack: [], perya: [], dt: [], sicbo: [] };
    let myNotifications = [];
    
    window.activeSharedGame = null;
    let sState = { time: 15, status: 'BETTING' };
    let mySBets = {};
    let mySBetsStack = []; 
    let dailyTimerInterval = null;
    let currentHistoryGame = null;

    const delay = ms => new Promise(res => setTimeout(res, ms));

    function getBetColor(betWord) {
        if(!betWord) return 'white';
        const map = {
            'PLAYER': 'var(--ps-glow)', 'BANKER': 'var(--danger)', 'TIE': 'var(--success)',
            'DRAGON': 'var(--danger)', 'TIGER': 'var(--credits)',
            'SMALL': 'var(--ps-glow)', 'BIG': 'var(--danger)', 'TRIPLE': 'white',
            'YELLOW': '#ffcc00', 'WHITE': '#fff', 'PINK': '#ff66b2', 'BLUE': '#00a2ff', 'RED': '#ff3366', 'GREEN': '#00e676',
            'BUST!': 'var(--danger)', 'PUSH': 'white', 'DEALER': 'var(--danger)', 'YOU': 'var(--success)'
        };
        return map[betWord.toUpperCase()] || 'white';
    }

    function colorsToDice(str) {
        if(str === '-') return '-';
        return str.split(',').map(c => {
            let color = c.trim().toLowerCase();
            if(!color) return '';
            return `<div class="color-die c-${color}" style="width:20px; height:20px; border-radius:4px; display:inline-flex; border:1px solid rgba(255,255,255,0.2); margin:0 2px;"></div>`;
        }).join('');
    }

    function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function addAmount(inputId, val) { let i = document.getElementById(inputId); i.value = (parseInt(i.value) || 0) + val; }

    function showToast(msg, type='success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type} show`;
        if(type === 'error') toast.classList.add('toast-error');
        let icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // --- NOTIFICATION POPOVER SYSTEM ---
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('notif-dropdown');
        const bellBtn = document.getElementById('bell-btn');
        if (dropdown && !dropdown.classList.contains('hidden')) {
            if (!dropdown.contains(e.target) && !bellBtn.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        }
    });

    function toggleNotifPopover(e) {
        e.stopPropagation();
        sfx.click();
        const dropdown = document.getElementById('notif-dropdown');
        dropdown.classList.toggle('hidden');
        renderNotifs();
    }

    function renderNotifs() {
        const list = document.getElementById('notif-list-popover');
        const badge = document.getElementById('notif-badge-display');
        const clearBtn = document.getElementById('btn-clear-notifs');
        list.innerHTML = '';
        
        let unreadCount = myNotifications.filter(n => !n.read).length;
        if(unreadCount > 0) { badge.style.display = 'block'; badge.innerText = unreadCount; }
        else { badge.style.display = 'none'; }
        
        clearBtn.disabled = unreadCount > 0 || myNotifications.length === 0;

        if(myNotifications.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;">No new notifications.</div>`;
            return;
        }

        myNotifications.forEach(n => {
            let cl = n.read ? '' : 'unread';
            list.innerHTML += `
            <div class="notif-item ${cl}" id="notif-${n.id}" onclick="markSingleRead(${n.id}, event)">
                <div class="notif-item-header">
                    <span class="notif-item-title">${n.title}</span>
                    <span class="notif-item-time">${new Date(n.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
                <div class="notif-item-body">${n.msg}</div>
                <button class="notif-item-del" onclick="deleteNotif(${n.id}, event)" ${n.read ? '' : 'style="display:none;"'}><i class="fas fa-times"></i></button>
            </div>`;
        });
    }

    function markSingleRead(id, e) {
        let n = myNotifications.find(x => x.id === id);
        if(n && !n.read) { n.read = true; renderNotifs(); }
    }

    function deleteNotif(id, e) {
        e.stopPropagation();
        myNotifications = myNotifications.filter(x => x.id !== id);
        renderNotifs();
    }

    function markAllNotifsRead() {
        myNotifications.forEach(n => n.read = true);
        renderNotifs();
    }

    function clearNotifs() {
        myNotifications = [];
        renderNotifs();
    }

    socket.on('notification', (data) => {
        myNotifications.unshift({ id: data.id || Date.now(), title: data.title, msg: data.msg, read: false, date: data.date || new Date() });
        if(myNotifications.length > 50) myNotifications.pop();
        
        let unreadCount = myNotifications.filter(n => !n.read).length;
        let badge = document.getElementById('notif-badge-display');
        badge.style.display = 'block'; badge.innerText = unreadCount;
        
        if(!document.getElementById('notif-dropdown').classList.contains('hidden')) { renderNotifs(); }
        showToast(data.msg, data.type || 'success');
    });

    socket.on('refreshBalance', () => { socket.emit('requestBalanceRefresh'); });

    function toggleAudio() {
        audioMuted = !audioMuted;
        sfxGainVal = audioMuted ? 0 : 0.8;
        let icon = document.querySelector('#mute-btn i');
        if (icon) {
            icon.className = audioMuted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
            icon.parentElement.style.color = audioMuted ? 'var(--danger)' : 'white';
        }
        if (!audioMuted && audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playTone(f, t, d, v = 0.1) { 
      if (audioMuted || audioCtx.state === 'suspended') return; 
      let o = audioCtx.createOscillator(); let g = audioCtx.createGain(); 
      o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime); 
      g.gain.setValueAtTime(v * sfxGainVal, audioCtx.currentTime); 
      g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d); 
      o.connect(g); g.connect(audioCtx.destination); 
      o.start(); o.stop(audioCtx.currentTime + d); 
    }

    const sfx = { 
      click: () => {
          if (audioMuted || audioCtx.state === 'suspended') return;
          let o = audioCtx.createOscillator(), g = audioCtx.createGain();
          o.type = 'triangle'; o.frequency.setValueAtTime(600, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.03);
          g.gain.setValueAtTime(0.15 * sfxGainVal, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.03);
          o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.03);
      },
      tick: () => {
          if (audioMuted || audioCtx.state === 'suspended') return;
          let o = audioCtx.createOscillator(), g = audioCtx.createGain();
          o.type = 'square'; o.frequency.setValueAtTime(1200, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.02);
          g.gain.setValueAtTime(0.05 * sfxGainVal, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.02);
          o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.02);
      },
      deal: () => playTone(300, 'triangle', 0.1, 0.1), 
      coin: () => { for(let i=0; i<10; i++) setTimeout(() => playTone(1500 + i * 100, 'square', 0.02, 0.05), i * 30); }, 
      win: () => { playTone(440, 'sine', 0.1, 0.1); setTimeout(() => playTone(660, 'sine', 0.15, 0.1), 100); setTimeout(() => playTone(880, 'sine', 0.3, 0.1), 250); }, 
      lose: () => { playTone(200, 'sawtooth', 0.4, 0.1); setTimeout(() => playTone(150, 'sawtooth', 0.6, 0.1), 200); }, 
      lock: () => { playTone(400, 'square', 0.1, 0.1); setTimeout(() => playTone(300, 'square', 0.1, 0.1), 100); }
    };

    function switchAuthTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        if(tab === 'login') {
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            document.getElementById('auth-form-login').style.display = 'block';
            document.getElementById('auth-form-register').style.display = 'none';
        } else {
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('auth-form-login').style.display = 'none';
            document.getElementById('auth-form-register').style.display = 'block';
        }
        document.getElementById('auth-error-login').innerText = '';
        document.getElementById('auth-error-register').innerText = '';
    }

    function toggleInputPwd(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === "password") { input.type = "text"; icon.className = "fas fa-eye-slash"; } 
        else { input.type = "password"; icon.className = "fas fa-eye"; }
    }

    document.getElementById('login-pass').addEventListener('keypress', function(e) { if (e.key === 'Enter') submitAuth('login'); });

    function submitAuth(mode) {
        const uId = mode === 'login' ? 'login-user' : 'reg-user';
        const pId = mode === 'login' ? 'login-pass' : 'reg-pass';
        const user = document.getElementById(uId).value.trim();
        const pass = document.getElementById(pId).value;
        if(!user || !pass) return document.getElementById(mode === 'login' ? 'auth-error-login' : 'auth-error-register').innerText = "Please fill all fields.";
        socket.emit(mode, { username: user, password: pass });
    }

    socket.on('authError', (msg) => {
        document.getElementById('auth-error-login').innerText = msg;
        document.getElementById('auth-error-register').innerText = msg;
    });

    socket.on('registerSuccess', (msg) => {
        document.getElementById('auth-error-register').className = 'auth-msg auth-success';
        document.getElementById('auth-error-register').innerText = msg;
        setTimeout(() => { switchAuthTab('login'); }, 1000);
    });

    socket.on('loginSuccess', (data) => {
        myUsername = data.username;
        myCredits = data.credits;
        document.getElementById('player-name-display').innerText = myUsername;
        document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
        
        if(data.role === 'Admin') {
            document.querySelector('.admin-btn').classList.remove('hidden');
        }

        setupDailyRewardUI(data.daily);

        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        
        if (audioCtx.state === 'suspended') audioCtx.resume();
        switchView('casino');
    });

    socket.on('balanceUpdateData', (newBalance) => { updateMyBalance(newBalance, true); });

    function triggerWinAnim() { 
      let p1 = document.getElementById('pill-credits'); 
      if (p1) { p1.classList.remove('anim-pop'); void p1.offsetWidth; p1.classList.add('anim-pop'); sfx.win(); } 
    }

    function updateMyBalance(newBalance, didWin = false) {
        if(didWin && newBalance > myCredits) { triggerWinAnim(); }
        myCredits = newBalance;
        document.getElementById('nav-credits').innerText = myCredits.toLocaleString(); 
    }

    // --- DAILY REWARD LOGIC ---
    function setupDailyRewardUI(dailyData) {
        const container = document.getElementById('dr-days-container');
        container.innerHTML = '';
        const rewards = [25, 50, 100, 200, 500, 750, 1000];
        
        for(let i=1; i<=7; i++) {
            let statClass = ''; let boxTitle = `Day ${i}`;
            
            if (!dailyData.canClaim && dailyData.day === 1) {
                statClass = 'claimed'; boxTitle = "CLAIMED";
            }
            else if (i < dailyData.day) { 
                statClass = 'claimed'; boxTitle = "CLAIMED"; 
            } 
            else if (i === dailyData.day && dailyData.canClaim) { 
                statClass = 'active'; 
            }
            
            container.innerHTML += `<div class="dr-day ${statClass}" id="dr-day-${i}"><div class="dr-title">${boxTitle}</div><div class="dr-coin">${rewards[i-1]}<br>Credits</div></div>`;
        }

        let sc = document.getElementById('dr-status-container');
        if(dailyData.canClaim) { sc.innerHTML = `<button class="btn-play dr-claim-btn" id="btn-claim-reward" onclick="claimDaily()">CLAIM REWARD</button>`; } 
        else { startDailyTimer(dailyData.nextClaim); }
    }

    function claimDaily() { socket.emit('claimDaily'); }

    socket.on('dailyClaimed', (data) => {
        let activeEl = document.querySelector('.dr-day.active');
        if (activeEl) { activeEl.classList.add('active-claimed'); activeEl.querySelector('.dr-title').innerText = "CLAIMED"; }
        updateMyBalance(data.newBalance, true);
        startDailyTimer(data.nextClaim);
        showToast(`Reward Claimed: +${data.amt} TC!`);
        setTimeout(() => { closeModal('daily-reward-modal'); }, 1500);
    });

    function startDailyTimer(nextClaimDate) {
        let sc = document.getElementById('dr-status-container');
        sc.innerHTML = `<div class="dr-status-text" style="margin-top:10px;">COME BACK TOMORROW</div><div class="dr-timer" id="dr-timer-display" style="margin-top:5px;">--:--:--</div>`;
        let dest = new Date(nextClaimDate).getTime();
        if(dailyTimerInterval) clearInterval(dailyTimerInterval);
        
        dailyTimerInterval = setInterval(() => {
            let now = new Date().getTime(); let d = dest - now;
            if(d <= 0) { clearInterval(dailyTimerInterval); sc.innerHTML = `<button class="btn-play dr-claim-btn" onclick="location.reload()">REFRESH TO CLAIM</button>`; return; }
            let h = Math.floor((d % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            let m = Math.floor((d % (1000 * 60 * 60)) / (1000 * 60));
            let s = Math.floor((d % (1000 * 60)) / 1000);
            h = (h < 10) ? "0" + h : h; m = (m < 10) ? "0" + m : m; s = (s < 10) ? "0" + s : s;
            document.getElementById('dr-timer-display').innerText = `${h}:${m}:${s}`;
        }, 1000);
    }

    // --- RULES & UNIFIED HISTORY LOGIC ---
    const gameInfoMap = {
      'dice': { title: "Dice Roll", body: "<ul><li style='margin-bottom:10px;'>Enter your bet amount and click <strong>Roll</strong>.</li><li style='margin-bottom:10px;'>Generates a random number between 1 and 100.</li><li style='margin-bottom:10px;'><strong>51 through 100</strong> wins (x2 Payout).</li><li style='margin-bottom:10px;'><strong>1 through 50</strong> loses.</li></ul>" },
      'coinflip': { title: "Coin Flip", body: "<ul><li style='margin-bottom:10px;'>Enter your bet and choose either <strong>Heads</strong> or <strong>Tails</strong>.</li><li style='margin-bottom:10px;'>True 50/50 chance.</li><li style='margin-bottom:10px;'>Winning pays <strong>x2</strong> your bet.</li></ul>" },
      'baccarat': { title: "Baccarat", body: "<ul><li style='margin-bottom:10px;'>Bet on Player, Banker, or Tie. Hand closest to <strong>9</strong> wins.</li><li style='margin-bottom:10px;'><strong>Card Rules:</strong> Standard 3rd card draw rules apply.</li><li style='margin-bottom:10px;'>Player pays <strong>x2</strong>. Banker pays <strong>x1.95</strong>.</li><li style='margin-bottom:10px;'>Tie pays <strong>x9</strong>. Player/Banker bets push on Tie.</li></ul>" },
      'blackjack': { title: "Blackjack", body: "<ul><li style='margin-bottom:10px;'>Beat the dealer without going over 21.</li><li style='margin-bottom:10px;'>Dealer must draw to 16 and stand on <strong>17 or higher</strong>.</li><li style='margin-bottom:10px;'>Natural Blackjack pays <strong>x2.5</strong>. Standard wins pay <strong>x2</strong>. Ties push.</li></ul>" },
      'perya': { title: "Color Game", body: "<ul><li style='margin-bottom:10px;'>Bet on Red, Blue, Yellow, White, Green, or Pink.</li><li style='margin-bottom:10px;'>3 dice are rolled.</li><li style='margin-bottom:10px;'>1 Match pays <strong>x2</strong>. 2 Matches pay <strong>x3</strong>. 3 Matches pay <strong>x4</strong>!</li></ul>" },
      'dt': { title: "Dragon Tiger", body: "<ul><li style='margin-bottom:10px;'>Bet on Dragon, Tiger, or Tie. Highest card wins.</li><li style='margin-bottom:10px;'>Aces are low (1). Kings are high (13).</li><li style='margin-bottom:10px;'>Dragon/Tiger pays <strong>x2</strong>. Tie pays <strong>x9</strong>.</li></ul>" },
      'sicbo': { title: "Sic Bo", body: "<ul><li style='margin-bottom:10px;'>Bet on Small (Sum 4-10) or Big (Sum 11-17).</li><li style='margin-bottom:10px;'>Wins pay <strong>x2</strong>.</li><li style='margin-bottom:10px;'>Any Triple roll loses all Big/Small bets.</li></ul>" }
    };

    function openRules(k) { 
      if (!k || !gameInfoMap[k]) return; 
      document.getElementById('rules-title').innerHTML = gameInfoMap[k].title + " Rules"; 
      document.getElementById('rules-body').innerHTML = gameInfoMap[k].body; 
      openModal('rules-modal'); 
    }

    function openHistory(id) {
        if (!id || !gameInfoMap[id]) return; 
        currentHistoryGame = id;
        
        document.getElementById('history-title').innerText = gameInfoMap[id].title.toUpperCase() + " HISTORY";
        document.getElementById('stat-total-rounds').innerText = "0";
        document.getElementById('stat-percentages').innerHTML = "";
        
        const list = document.getElementById('history-items');
        list.innerHTML = '';
        const history = myGameHistory[id] || [];
        
        if(history.length === 0) { 
            list.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding: 20px;">No history available yet.</div>`; 
        } 
        else {
            history.forEach(h => {
                let winVal = h.didBet ? (h.wonProfit > 0 ? `<span style="color:var(--success)">+${h.wonProfit}</span>` : '-') : '-';
                let lossVal = h.didBet ? (h.lostBet > 0 ? `<span style="color:var(--danger)">-${h.lostBet}</span>` : '-') : '-';
                
                if (h.didBet && h.wonProfit === 0 && h.lostBet === 0) { winVal = '<span style="color:white">PUSH</span>'; lossVal = '-'; }
                
                let bHtml = h.bet;
                let rHtml = h.result;
                
                if (id === 'perya') {
                    bHtml = h.bet === '-' ? '-' : `<div style="display:flex; justify-content:center; gap:4px; flex-wrap:wrap;">${colorsToDice(h.bet)}</div>`;
                    rHtml = `<div style="display:flex; justify-content:center; gap:4px;">${colorsToDice(h.result)}</div>`;
                } else {
                    bHtml = h.bet === '-' ? '-' : `<span style="font-weight:800; color:${getBetColor(h.bet.split(',')[0])}">${h.bet}</span>`;
                    rHtml = `<span style="font-weight:900; color:${getBetColor(h.result.split(' ')[0])}">${h.result}</span>`;
                }

                list.innerHTML += `<div style="background:rgba(255,255,255,0.05); padding:12px 10px; border-radius:6px; display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:10px; align-items:center; font-size:0.9rem; text-transform:uppercase; text-align:center;">
                    <div>${rHtml}</div>
                    <div>${bHtml}</div>
                    <div>${winVal}</div>
                    <div>${lossVal}</div>
                </div>`;
            });
        }
        
        socket.emit('getGlobalResults', id);
        openModal('history-modal');
    }

    function logHistory(gid, betStr, resultStr, wonProfit, lostBet, didBet = true) {
        if(!myGameHistory[gid]) myGameHistory[gid] = [];
        myGameHistory[gid].unshift({ bet: betStr, result: resultStr, wonProfit: wonProfit, lostBet: lostBet, didBet: didBet });
        // Rigidly enforce the 5 item limit
        if(myGameHistory[gid].length > 5) myGameHistory[gid].pop();
    }

    socket.on('globalResultsData', data => {
        if(data.game !== currentHistoryGame) return;
        
        document.getElementById('stat-total-rounds').innerText = data.stats.total;
        
        let statsHtml = ``;
        if (data.stats.total > 0) {
            Object.keys(data.stats).forEach(key => {
                if (key !== 'total') {
                    let perc = ((data.stats[key] / data.stats.total) * 100).toFixed(1);
                    if (data.game === 'perya') {
                        statsHtml += `<div style="display:flex; align-items:center; gap:6px;"><div class="color-die c-${key.toLowerCase()}" style="width:16px; height:16px; border-radius:3px; border:1px solid rgba(255,255,255,0.2); font-size:0;"></div><span style="color:white; font-weight:800;">${perc}%</span></div>`;
                    } else {
                        statsHtml += `<span><span style="color:${getBetColor(key)}; font-weight:800;">${key.toUpperCase()}: ${perc}%</span></span>`;
                    }
                }
            });
        }
        document.getElementById('stat-percentages').innerHTML = statsHtml;
    });

    // --- INTERACTIVE CURRENT BETS ---
    function openCurrentBetsModal() {
        if(!window.activeSharedGame) return;
        const list = document.getElementById('cb-list');
        list.innerHTML = '';
        let total = 0;
        const entries = Object.entries(mySBets);
        
        if(entries.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;">No active bets for this round.</div>`;
        } else {
            entries.forEach(([choice, amount]) => {
                total += amount; let cColor = getBetColor(choice);
                list.innerHTML += `<div style="background:rgba(0,0,0,0.4); padding:10px 15px; border-radius:6px; border-left:4px solid ${cColor}; display:flex; justify-content:space-between; align-items:center; font-weight:800; margin-bottom:5px;"><span style="text-transform:uppercase; color:${cColor};">${choice}</span><span style="color:var(--credits); font-size: 1rem;">${amount.toLocaleString()} TC</span></div>`;
            });
            list.innerHTML += `<div style="border-top:1px solid var(--glass-border); padding-top:10px; margin-top:5px; display:flex; justify-content:space-between; font-weight:900; font-size:1.1rem; color:white;"><span>TOTAL WAGERED</span><span style="color:var(--credits);">${total.toLocaleString()} TC</span></div>`;
        }
        openModal('current-bets-modal');
    }

    // --- NAVIGATION LOGIC ---
    function switchView(viewId) { 
      if (audioCtx.state === 'suspended') audioCtx.resume(); 
      document.querySelectorAll('.main-wrapper > .content > .view-container').forEach(d => d.classList.add('hidden')); 
      let v = document.getElementById('view-' + viewId); 
      if (v) v.classList.remove('hidden'); 
      if (viewId === 'casino') openLobbyMode('modes'); 
    }

    function openLobbyMode(mode) { 
      ['modes', 'indiv', 'shared'].forEach(m => {
        let el = document.getElementById('lobby-' + m);
        if(el) el.classList.add('hidden');
      }); 
      let target = document.getElementById('lobby-' + mode);
      if(target) target.classList.remove('hidden'); 
      
      if(mode === 'modes') document.querySelector('.casino-title').classList.remove('hidden');
      else document.querySelector('.casino-title').classList.add('hidden');
    }
    
    function openGame(id) { 
      switchView('game-' + id); 
      let resBox = document.querySelector(`#view-game-${id} .result-box`);
      if(resBox) {
          resBox.style.display = 'none';
          resBox.classList.remove('show');
          resBox.style.opacity = '0';
      }
      
      if(id === 'dice') {
          document.getElementById('dice-icon').className = 'fas fa-dice-d20 dice-icon';
          document.getElementById('dice-icon').style.display='block'; 
          document.getElementById('dice-num').style.display='none';
          document.getElementById('btn-dice').disabled = false;
      }
      if(id === 'coinflip') {
          document.getElementById('btn-heads').disabled = false;
          document.getElementById('btn-tails').disabled = false;
          document.getElementById('coin-wrapper').classList.remove('tossing');
      }
      if(id === 'blackjack') {
          document.getElementById('bj-p-hand').innerHTML=''; document.getElementById('bj-d-hand').innerHTML='';
          document.getElementById('bj-p-score').innerText='0'; document.getElementById('bj-d-score').innerText='0';
          document.getElementById('bj-start-controls').classList.remove('hidden');
          document.getElementById('bj-action-controls').classList.add('hidden');
          document.getElementById('btn-bj-deal').disabled = false;
          bjSt.active = false;
      }
    }

    function backToSoloLobby() { switchView('casino'); openLobbyMode('indiv'); }
    
    function backToSharedLobby() { 
        if (window.activeSharedGame && mySBets && Object.values(mySBets).reduce((a,b)=>a+b,0) > 0 && sState.status === 'BETTING') {
            showToast("Cannot leave with active bets. Wait for round to finish.", "error"); return;
        }
        document.getElementById('view-shared-game').classList.add('hidden'); 
        socket.emit('leaveRoom', window.activeSharedGame);
        window.activeSharedGame = null; 
        switchView('casino'); 
        openLobbyMode('shared'); 
    }
    
    function backToCasino() { switchView('casino'); }
    function confirmLogout() { if(confirm("Are you sure you want to log out of Stick N' Trade?")) { location.reload(); } }

    // --- SOLO GAMES ENGINE (PERFECT TIMING FIX WITH NO BLANK FLASH) ---
    function showEndBox(box, bet, payout, msg, newBalance) {
        let pft = payout > bet ? payout - bet : 0; 
        let loss = payout === 0 ? bet : 0;
        
        let h = `<div class="res-title" style="color:white;">${msg}</div>`; 
        if (payout > bet) { 
            h += `<div class="res-payout" style="color:var(--success)">+${pft} TC</div>`; 
            box.className = "result-box win"; 
        } else if (payout === bet) { 
            h += `<div class="res-payout" style="color:white">Push</div>`; 
            box.className = "result-box push"; 
        } else { 
            sfx.lose(); 
            h += `<div class="res-payout" style="color:var(--danger)">Lost -${loss}</div>`; 
            box.className = "result-box lose"; 
        } 
        
        // 1. Inject HTML instantly while hidden to prevent flash
        box.innerHTML = h; 
        box.style.display = 'block'; 
        box.style.opacity = '0'; 
        
        // 2. Trigger visual slide-in gracefully
        requestAnimationFrame(() => {
            box.style.opacity = '1';
            box.classList.add('show'); 
        });
        
        // 3. Exact pause AFTER box shows before animating credits
        setTimeout(() => { updateMyBalance(newBalance, payout > bet); }, 1500);
    }

    async function playDice() {
      let betEl = document.getElementById('dice-bet');
      let bet = parseInt(betEl.value);
      if (isNaN(bet) || bet <= 0) { showToast("Invalid bet.", "error"); return; }
      if (bet > myCredits) { showToast("Insufficient TC.", "error"); return; }
      
      const btn = document.getElementById('btn-dice'), icn = document.getElementById('dice-icon'), nd = document.getElementById('dice-num'), mb = document.getElementById('dice-msg');
      btn.disabled = true; mb.style.display = 'none'; icn.style.display = 'block'; nd.style.display = 'none'; mb.classList.remove('show');
      icn.className = `fas fa-dice-d20 dice-icon anim-shake`;
      
      myCredits -= bet; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
      
      let resData = null;
      socket.once('diceResult', (data) => { resData = data; });
      socket.emit('playSolo', { game: 'dice', bet: bet });

      const indFaces = ['fa-dice-one', 'fa-dice-two', 'fa-dice-three', 'fa-dice-four', 'fa-dice-five', 'fa-dice-six'];
      let animCycle = setInterval(() => { icn.className = `fas ${indFaces[Math.floor(Math.random() * 6)]} dice-icon anim-shake`; sfx.tick(); }, 80);
      
      await delay(1600); // Wait for physical animation
      clearInterval(animCycle);
      
      if(resData) {
          icn.style.display = 'none'; nd.style.display = 'block'; nd.innerText = resData.roll;
          nd.style.color = resData.payout > 0 ? "var(--success)" : "var(--danger)";
          
          await delay(500); // Pause before reveal box
          showEndBox(mb, resData.bet, resData.payout, resData.resStr, resData.newBalance);
          logHistory('dice', resData.bet + ' TC', resData.resStr, resData.payout > resData.bet ? resData.payout - resData.bet : 0, resData.payout === 0 ? resData.bet : 0, true);
          
          await delay(3500); // Cooldown
          icn.className = 'fas fa-dice-d20 dice-icon';
          icn.style.display = 'block'; nd.style.display = 'none'; mb.style.display = 'none';
          btn.disabled = false;
      }
    }

    let coinFlips = 0;
    async function playCoin(choice) {
      let betEl = document.getElementById('coin-bet');
      let bet = parseInt(betEl.value);
      if (isNaN(bet) || bet <= 0) { showToast("Invalid bet.", "error"); return; }
      if (bet > myCredits) { showToast("Insufficient TC.", "error"); return; }
      
      document.getElementById('btn-heads').disabled = true; document.getElementById('btn-tails').disabled = true; 
      const cw = document.getElementById('coin-wrapper'), co = document.getElementById('coin-obj'), mb = document.getElementById('coin-msg');
      mb.style.display = 'none'; mb.classList.remove('show');
      
      sfx.coin(); cw.classList.add('tossing');
      myCredits -= bet; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
      
      let resData = null;
      socket.once('coinResult', (data) => { resData = data; });
      socket.emit('playSolo', { game: 'coinflip', bet: bet, choice: choice });

      await delay(2500); // Wait for exact tossing CSS to land
      cw.classList.remove('tossing');
      
      if(resData) {
          coinFlips += 5; let er = resData.result === 'Tails' ? 180 : 0; 
          co.style.transform = `rotateY(${coinFlips * 360 + er}deg)`; 
          
          await delay(500); // Pause before box
          showEndBox(mb, resData.bet, resData.payout, resData.resStr, resData.newBalance);
          logHistory('coinflip', choice.toUpperCase(), resData.resStr, resData.payout > resData.bet ? resData.payout - resData.bet : 0, resData.payout === 0 ? resData.bet : 0, true);
          
          await delay(3500); // Cooldown
          document.getElementById('btn-heads').disabled = false; 
          document.getElementById('btn-tails').disabled = false;
          mb.style.display = 'none'; 
      }
    }

    let bjSt = { bet: 0, active: false };
    function startBlackjack() {
      if (bjSt.active) return; 
      let betEl = document.getElementById('bj-bet');
      let bet = parseInt(betEl.value);
      if (isNaN(bet) || bet <= 0) { showToast("Invalid bet.", "error"); return; }
      if (bet > myCredits) { showToast("Insufficient TC.", "error"); return; }
      
      bjSt.bet = bet; bjSt.active = true; 
      document.getElementById('btn-bj-deal').disabled = true;
      document.getElementById('bj-msg').style.display = 'none'; document.getElementById('bj-msg').classList.remove('show');
      document.getElementById('bj-start-controls').classList.add('hidden'); 
      document.getElementById('btn-bj-hit').disabled = true; 
      document.getElementById('btn-bj-stand').disabled = true;
      document.getElementById('bj-p-hand').innerHTML = ''; document.getElementById('bj-d-hand').innerHTML = '';
      document.getElementById('bj-p-score').innerText = '0'; document.getElementById('bj-d-score').innerText = '0';
      
      myCredits -= bet; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
      socket.emit('playSolo', { game: 'blackjack', action: 'start', bet: bet });
    }
    
    function hitBlackjack() { if(bjSt.active) { document.getElementById('btn-bj-hit').disabled=true; socket.emit('playSolo', { game:'blackjack', action:'hit' }); } }
    function standBlackjack() { if(bjSt.active) { bjSt.active=false; document.getElementById('btn-bj-hit').disabled=true; document.getElementById('btn-bj-stand').disabled=true; socket.emit('playSolo', { game:'blackjack', action:'stand' }); } }

    function getBJScore(hand) {
        let score = 0, aces = 0;
        hand.forEach(c => { score += c.bjVal; if (c.raw === 'A') aces++; });
        while (score > 21 && aces > 0) { score -= 10; aces--; }
        return score;
    }

    async function appendCard(containerId, scoreId, card, fullHandArr, isHidden = false) {
        let container = document.getElementById(containerId);
        let ir = (card.suit === '‚ô•' || card.suit === '‚ô¶'); let sh = ir ? `<span class="card-red">${card.suit}</span>` : card.suit;
        let html = isHidden ? `<div class="play-card anim-deal card-back" id="hidden-card">?</div>` : `<div class="play-card anim-deal"><div class="val">${card.val}</div><div class="suit">${sh}</div></div>`;
        container.insertAdjacentHTML('beforeend', html);
        sfx.deal();
        await delay(400); 
        if (!isHidden) document.getElementById(scoreId).innerText = getBJScore(fullHandArr);
    }

    socket.on('bjUpdate', async (data) => {
        if(data.event === 'deal') {
            await appendCard('bj-p-hand', 'bj-p-score', data.pHand[0], data.pHand.slice(0,1));
            await appendCard('bj-d-hand', 'bj-d-score', data.dHand[0], data.dHand.slice(0,1));
            await appendCard('bj-p-hand', 'bj-p-score', data.pHand[1], data.pHand);
            await appendCard('bj-d-hand', 'bj-d-score', data.dHand[1], data.dHand, true); 
            document.getElementById('bj-action-controls').classList.remove('hidden');
            document.getElementById('btn-bj-hit').disabled = false; document.getElementById('btn-bj-stand').disabled = false;
        } 
        else if (data.event === 'hit') {
            await appendCard('bj-p-hand', 'bj-p-score', data.pHand[data.pHand.length - 1], data.pHand);
            document.getElementById('btn-bj-hit').disabled = false;
        }
        else if (data.event === 'resolved') {
            bjSt.active = false;
            document.getElementById('bj-action-controls').classList.add('hidden');
            document.getElementById('bj-start-controls').classList.remove('hidden');
            
            let pHandEl = document.getElementById('bj-p-hand');
            if (pHandEl && data.msg === 'Bust!' && data.pHand.length > pHandEl.children.length) {
                let lastCard = data.pHand[data.pHand.length - 1];
                await appendCard('bj-p-hand', 'bj-p-score', lastCard, data.pHand);
            }
            
            let hidden = document.getElementById('hidden-card');
            if (hidden) {
                let c = data.dHand[1]; let ir = (c.suit === '‚ô•' || c.suit === '‚ô¶'); let sh = ir ? `<span class="card-red">${c.suit}</span>` : c.suit;
                hidden.outerHTML = `<div class="play-card anim-flip"><div class="val">${c.val}</div><div class="suit">${sh}</div></div>`;
                sfx.deal(); await delay(400); document.getElementById('bj-d-score').innerText = getBJScore(data.dHand.slice(0,2));
            }

            if (data.dHand.length > 2 && data.msg !== 'Bust!') {
                for(let i = 2; i < data.dHand.length; i++) {
                    await delay(400); 
                    await appendCard('bj-d-hand', 'bj-d-score', data.dHand[i], data.dHand.slice(0, i+1));
                }
            }
            
            await delay(500); 
            
            showEndBox(document.getElementById('bj-msg'), bjSt.bet, data.payout, data.resStr, data.newBalance);
            let wProf = data.payout > bjSt.bet ? data.payout - bjSt.bet : 0;
            let lBet = data.payout === 0 ? bjSt.bet : 0;
            logHistory('blackjack', bjSt.bet + ' TC', data.resStr, wProf, lBet, true);
            
            setTimeout(() => {
                document.getElementById('btn-bj-deal').disabled = false;
                document.getElementById('bj-msg').style.display = 'none';
            }, 3500);
        }
    });

    // --- SHARED TABLES NETWORKING ---
    function sendChat() {
        const input = document.getElementById('chat-input');
        if(input.value.trim() === '') return;
        socket.emit('sendChat', { room: window.activeSharedGame, msg: input.value });
        input.value = '';
    }
    
    socket.on('chatMessage', (data) => {
        let cb = document.getElementById('sg-chat'); if (!cb) return; 
        if (data.sys) cb.insertAdjacentHTML('beforeend', `<div class="chat-msg chat-sys">${data.text}</div>`);
        else cb.insertAdjacentHTML('beforeend', `<div class="chat-msg"><div class="chat-user">${data.user}</div><div>${data.text}</div></div>`);
        cb.scrollTop = cb.scrollHeight;
    });

    socket.on('playerCount', (counts) => {
        document.querySelectorAll('.active-players .ap-count').forEach((el, index) => {
            const keys = ['baccarat', 'perya', 'dt', 'sicbo'];
            if(counts[keys[index]]!==undefined) el.innerText = counts[keys[index]];
        });
        const sgCount = document.getElementById('sg-active-players');
        if(sgCount && window.activeSharedGame) sgCount.innerText = counts[window.activeSharedGame] || 0;
    });

    function undoSharedBet() {
        if (sState.status !== 'BETTING' || mySBetsStack.length === 0) return;
        socket.emit('undoSharedBet', { room: window.activeSharedGame });
    }

    socket.on('undoSuccess', (data) => {
        mySBetsStack.pop();
        if(mySBets[data.choice]) {
            mySBets[data.choice] -= data.amount;
            if(mySBets[data.choice] <= 0) {
                delete mySBets[data.choice];
                let btn = document.querySelector(`.bet-btn[data-choice="${data.choice}"]`);
                if(btn) btn.classList.remove('has-bet');
            }
        }
        let tot = Object.values(mySBets).reduce((sum, val) => sum + val, 0);
        let mb = document.getElementById('sg-my-bet');
        if(mb) mb.innerHTML = `${tot.toLocaleString()} TC`;
        sfx.tick();
    });

    const sConf = {
      'perya': {
        title: 'Color Game', 
        setupUI: function() { 
          let d = document.getElementById('sg-display'); if (!d) return; 
          d.innerHTML = `<div class="color-dice-container" id="cg-dice"><div class="color-die c-grey" id="cd1">?</div><div class="color-die c-grey" id="cd2">?</div><div class="color-die c-grey" id="cd3">?</div></div><div class="result-overlay-shared" id="sg-overlay"><div class="res-title" id="sg-res-title"></div><div class="res-payout" id="sg-res-payout" style="display:none"></div></div>`; 
          let cg = document.getElementById('sg-controls-container'); 
          if (cg) cg.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%; max-width: 600px; margin: 0 auto 15px auto;">
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div class="input-group" style="margin: 0; width: 120px;">
                        <label>BET AMOUNT</label>
                        <input type="number" id="sg-bet-input" class="input-control bet-input" placeholder="10">
                    </div>
                    <button class="btn-rules" style="height: 44px; width: 44px;" onclick="undoSharedBet()" title="Undo Last Bet"><i class="fas fa-undo"></i></button>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--text-muted); font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-bottom:5px;">TOTAL BET</div>
                    <div id="sg-my-bet" style="color: white; font-size: 1.5rem; font-weight: 900; line-height: 1; cursor:pointer;" onclick="openCurrentBetsModal()">0 TC</div>
                </div>
            </div>
            <div class="bet-grid perya-grid controls-full" id="sg-bet-grid" style="width:100%; max-width: 600px; margin: 0 auto;"></div>`; 
          let bg = document.getElementById('sg-bet-grid'); 
          if (bg) { 
            const choices = [ {id: 'Yellow', c: '#ffcc00'}, {id: 'White', c: '#ffffff'}, {id: 'Pink', c: '#ff66b2'}, {id: 'Blue', c: '#00a2ff'}, {id: 'Red', c: '#ff3366'}, {id: 'Green', c: '#00e676'} ];
            choices.forEach(c => { 
              bg.innerHTML += `<button class="bet-btn perya-tile" data-choice="${c.id}" style="--tile-color:${c.c}; border-bottom:5px solid ${c.c}" onclick="placeSharedBet('${c.id}')">${c.id}</button>`; 
            }); 
          } 
        },
        animateResult: function(data) {
            let d1 = document.getElementById('cd1'), d2 = document.getElementById('cd2'), d3 = document.getElementById('cd3'); 
            if(d1) {
                d1.className = 'color-die anim-shake c-grey'; d2.className = 'color-die anim-shake c-grey'; d3.className = 'color-die anim-shake c-grey'; 
                d1.innerText = ''; d2.innerText = ''; d3.innerText = ''; sfx.tick();
            }
            
            setTimeout(() => {
                let rollArr = Array.isArray(data.roll) ? data.roll : data.roll.split(',');
                if (d1) {
                    d1.className = `color-die c-${rollArr[0].toLowerCase().trim()}`; 
                    d2.className = `color-die c-${rollArr[1].toLowerCase().trim()}`; 
                    d3.className = `color-die c-${rollArr[2].toLowerCase().trim()}`; 
                }
                
                let totBet = 0, totWon = 0;
                let wonProfit = 0, lostBet = 0;
                
                for(let b in mySBets) { 
                    let a = mySBets[b];
                    totBet += a; 
                    let m = rollArr.filter(x => x.trim() === b).length; 
                    if(m > 0) {
                        let p = a + (a * m);
                        totWon += p; 
                        wonProfit += (a * m);
                    } else {
                        lostBet += a;
                    }
                }
                let msg = rollArr.join(', ').toUpperCase();
                processSharedPayout('perya', totWon, totBet, msg, wonProfit, lostBet, Object.keys(mySBets).join(', '), msg);
            }, 2000);
        }
      },
      'baccarat': {
        title: 'Baccarat',
        setupUI: function() {
          let d = document.getElementById('sg-display'); if (!d) return; 
          d.innerHTML = `
            <div class="dt-arena" style="gap:40px; margin-bottom: 0;">
                <div class="dt-side">
                    <div class="dt-label" style="color:var(--ps-glow)">Player</div>
                    <div id="bac-p-score" style="font-size:2rem; font-weight:900; color:white; line-height:1; margin-bottom:5px;">0</div>
                    <div id="bac-p-hand" style="display:flex; gap:5px; justify-content:center; min-height:100px; width:210px;"></div>
                </div>
                <div style="font-size:2.5rem;color:white;font-weight:300;">VS</div>
                <div class="dt-side">
                    <div class="dt-label" style="color:var(--danger)">Banker</div>
                    <div id="bac-b-score" style="font-size:2rem; font-weight:900; color:white; line-height:1; margin-bottom:5px;">0</div>
                    <div id="bac-b-hand" style="display:flex; gap:5px; justify-content:center; min-height:100px; width:210px;"></div>
                </div>
            </div>
            <div id="bac-action-text"></div>
            <div class="result-overlay-shared" id="sg-overlay"><div class="res-title" id="sg-res-title"></div><div class="res-payout" id="sg-res-payout" style="display:none"></div></div>`; 
          
          let cg = document.getElementById('sg-controls-container'); 
          if (cg) cg.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%; max-width: 600px; margin: 0 auto 15px auto;">
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div class="input-group" style="margin: 0; width: 120px;">
                        <label>BET AMOUNT</label>
                        <input type="number" id="sg-bet-input" class="input-control bet-input" placeholder="10">
                    </div>
                    <button class="btn-rules" style="height: 44px; width: 44px;" onclick="undoSharedBet()" title="Undo Last Bet"><i class="fas fa-undo"></i></button>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--text-muted); font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-bottom:5px;">TOTAL BET</div>
                    <div id="sg-my-bet" style="color: white; font-size: 1.5rem; font-weight: 900; line-height: 1; cursor:pointer;" onclick="openCurrentBetsModal()">0 TC</div>
                </div>
            </div>
            <div class="bet-grid controls-full" id="sg-bet-grid" style="width:100%; max-width: 600px; margin: 0 auto;"></div>`; 
          let bg = document.getElementById('sg-bet-grid'); 
          if (bg) bg.innerHTML = `
            <button class="bet-btn shared-tile" data-choice="Player" style="--tile-color:var(--ps-glow); border-bottom:5px solid var(--ps-glow);" onclick="placeSharedBet('Player')">PLAYER (x2)</button>
            <button class="bet-btn shared-tile" data-choice="Tie" style="--tile-color:var(--success); border-bottom:5px solid var(--success);" onclick="placeSharedBet('Tie')">TIE (x9)</button>
            <button class="bet-btn shared-tile" data-choice="Banker" style="--tile-color:var(--danger); border-bottom:5px solid var(--danger);" onclick="placeSharedBet('Banker')">BANKER (x1.95)</button>`;
        },
        animateResult: async function(data) {
            let pHand = document.getElementById('bac-p-hand'), bHand = document.getElementById('bac-b-hand');
            let pScoreEl = document.getElementById('bac-p-score'), bScoreEl = document.getElementById('bac-b-score');
            let acText = document.getElementById('bac-action-text');
            pHand.innerHTML = ''; bHand.innerHTML = ''; pScoreEl.innerText = '0'; bScoreEl.innerText = '0';

            let pC = [], bC = [];
            const dealTo = async (side, scoreEl, currentScore, card) => {
                side.insertAdjacentHTML('beforeend', `<div class="play-card anim-deal"><div class="val">${card.raw}</div><div class="suit">${card.suitHtml}</div></div>`);
                sfx.deal();
                await delay(800); 
                scoreEl.innerText = (currentScore + card.bacVal) % 10;
                return (currentScore + card.bacVal) % 10;
            };

            let pS = 0, bS = 0;
            pS = await dealTo(pHand, pScoreEl, pS, data.pCards[0]);
            bS = await dealTo(bHand, bScoreEl, bS, data.bCards[0]);
            pS = await dealTo(pHand, pScoreEl, pS, data.pCards[1]);
            bS = await dealTo(bHand, bScoreEl, bS, data.bCards[1]);

            if (data.p3Drawn || data.b3Drawn) {
                await delay(800);
            }

            if (data.p3Drawn) {
                if(acText) acText.innerText = "Player draws 3rd card...";
                await delay(800);
                pS = await dealTo(pHand, pScoreEl, pS, data.pCards[2]);
            }
            if (data.b3Drawn) {
                if(acText) acText.innerText = "Banker draws 3rd card...";
                await delay(800);
                bS = await dealTo(bHand, bScoreEl, bS, data.bCards[2]);
            }
            if(acText) acText.innerText = ""; 

            await delay(1000); 
            let w = data.winner;
            let tp = 0, tba = 0; 
            let wonProfit = 0, lostBet = 0;
            
            for (let b in mySBets) { 
                let a = mySBets[b]; tba += a; 
                if (b === w) { 
                    let p = a * (w === 'Tie' ? 9 : (w === 'Banker' ? 1.95 : 2)); 
                    tp += p; wonProfit += (p - a);
                } else if (w === 'Tie' && (b === 'Player' || b === 'Banker')) {
                    tp += a; // Push refund, wonProfit is 0
                } else { 
                    lostBet += a;
                }
            } 
            let msg = w === 'Tie' ? `TIE!` : `${w.toUpperCase()} WINS!`;
            processSharedPayout('baccarat', tp, tba, msg, wonProfit, lostBet, Object.keys(mySBets).join(', '), data.resStr);
        }
      },
      'dt': {
        title: 'Dragon Tiger',
        setupUI: function() { 
          let d = document.getElementById('sg-display'); if (!d) return; 
          d.innerHTML = `<div class="dt-arena"><div class="dt-side"><div class="dt-label lbl-dragon">Dragon</div><div id="dt-c1" class="card-back dt-card play-card">?</div></div><div style="font-size:2.5rem;color:white;font-weight:300;">VS</div><div class="dt-side"><div class="dt-label lbl-tiger">Tiger</div><div id="dt-c2" class="card-back dt-card play-card">?</div></div></div><div class="result-overlay-shared" id="sg-overlay"><div class="res-title" id="sg-res-title"></div><div class="res-payout" id="sg-res-payout" style="display:none"></div></div>`; 
          let cg = document.getElementById('sg-controls-container'); 
          if (cg) cg.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%; max-width: 600px; margin: 0 auto 15px auto;">
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div class="input-group" style="margin: 0; width: 120px;">
                        <label>BET AMOUNT</label>
                        <input type="number" id="sg-bet-input" class="input-control bet-input" placeholder="10">
                    </div>
                    <button class="btn-rules" style="height: 44px; width: 44px;" onclick="undoSharedBet()" title="Undo Last Bet"><i class="fas fa-undo"></i></button>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--text-muted); font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-bottom:5px;">TOTAL BET</div>
                    <div id="sg-my-bet" style="color: white; font-size: 1.5rem; font-weight: 900; line-height: 1; cursor:pointer;" onclick="openCurrentBetsModal()">0 TC</div>
                </div>
            </div>
            <div class="bet-grid controls-full" id="sg-bet-grid" style="width:100%; max-width: 600px; margin: 0 auto;"></div>`; 
          let bg = document.getElementById('sg-bet-grid'); 
          if (bg) bg.innerHTML = `
            <button class="bet-btn shared-tile" data-choice="Dragon" style="--tile-color:var(--danger); border-bottom:5px solid var(--danger);" onclick="placeSharedBet('Dragon')">DRAGON (x2)</button>
            <button class="bet-btn shared-tile" data-choice="Tie" style="--tile-color:var(--success); border-bottom:5px solid var(--success);" onclick="placeSharedBet('Tie')">TIE (x9)</button>
            <button class="bet-btn shared-tile" data-choice="Tiger" style="--tile-color:var(--credits); border-bottom:5px solid var(--credits);" onclick="placeSharedBet('Tiger')">TIGER (x2)</button>`; 
        },
        animateResult: function(data) { 
          let e1 = document.getElementById('dt-c1'); 
          if (e1) { e1.outerHTML = `<div class="play-card anim-deal dt-card" id="dt-c1"><div class="val">${data.dCard.raw}</div><div class="suit">${data.dCard.suitHtml}</div></div>`; sfx.deal(); } 
          setTimeout(() => { 
            let e2 = document.getElementById('dt-c2'); 
            if (e2) { e2.outerHTML = `<div class="play-card anim-deal dt-card" id="dt-c2"><div class="val">${data.tCard.raw}</div><div class="suit">${data.tCard.suitHtml}</div></div>`; sfx.deal(); } 
            
            setTimeout(() => { 
              let w = data.winner;
              let tp = 0, tba = 0; 
              let wonProfit = 0, lostBet = 0;
              for (let b in mySBets) { 
                let a = mySBets[b]; tba += a; 
                if (b === w) { 
                    let p = a * (w === 'Tie' ? 9 : 2); 
                    tp += p; wonProfit += (p - a);
                } else { 
                    lostBet += a; 
                }
              } 
              let msg = w === 'Tie' ? `TIE!` : `${w.toUpperCase()} WINS!`;
              processSharedPayout('dt', tp, tba, msg, wonProfit, lostBet, Object.keys(mySBets).join(', '), data.resStr); 
            }, 1000); 
          }, 500); 
        }
      },
      'sicbo': {
        title: 'Sic Bo',
        setupUI: function() { 
          let d = document.getElementById('sg-display'); if (!d) return; 
          d.innerHTML = `<div class="sicbo-dice" id="sb-dice"><i class="fas fa-dice-d6 s-die"></i><i class="fas fa-dice-d6 s-die"></i><i class="fas fa-dice-d6 s-die"></i></div><div id="sb-sum" style="font-size:2rem;color:var(--text-muted); margin-top:30px; font-weight:900; letter-spacing:2px;">Waiting for roll...</div><div class="result-overlay-shared" id="sg-overlay"><div class="res-title" id="sg-res-title"></div><div class="res-payout" id="sg-res-payout" style="display:none"></div></div>`; 
          let cg = document.getElementById('sg-controls-container'); 
          if (cg) cg.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%; max-width: 600px; margin: 0 auto 15px auto;">
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div class="input-group" style="margin: 0; width: 120px;">
                        <label>BET AMOUNT</label>
                        <input type="number" id="sg-bet-input" class="input-control bet-input" placeholder="10">
                    </div>
                    <button class="btn-rules" style="height: 44px; width: 44px;" onclick="undoSharedBet()" title="Undo Last Bet"><i class="fas fa-undo"></i></button>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--text-muted); font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-bottom:5px;">TOTAL BET</div>
                    <div id="sg-my-bet" style="color: white; font-size: 1.5rem; font-weight: 900; line-height: 1; cursor:pointer;" onclick="openCurrentBetsModal()">0 TC</div>
                </div>
            </div>
            <div class="bet-grid controls-full" id="sg-bet-grid" style="width:100%; max-width: 600px; margin: 0 auto;"></div>`; 
          let bg = document.getElementById('sg-bet-grid'); 
          if (bg) bg.innerHTML = `
            <button class="bet-btn shared-tile" data-choice="Small" style="--tile-color:var(--ps-glow); border-bottom:5px solid var(--ps-glow);" onclick="placeSharedBet('Small')">SMALL (x2)</button>
            <div style="display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-weight:800;font-size:1rem;text-align:center;">TRIPLE LOSES</div>
            <button class="bet-btn shared-tile" data-choice="Big" style="--tile-color:var(--danger); border-bottom:5px solid var(--danger);" onclick="placeSharedBet('Big')">BIG (x2)</button>`; 
        },
        animateResult: function(data) { 
          const dc = document.getElementById('sb-dice'); 
          if (dc) { dc.innerHTML = `<i class="fas fa-dice-d6 s-die anim-shake"></i><i class="fas fa-dice-d6 s-die anim-shake"></i><i class="fas fa-dice-d6 s-die anim-shake"></i>`; sfx.tick(); } 
          setTimeout(() => { 
            const f = ['fa-dice-one','fa-dice-two','fa-dice-three','fa-dice-four','fa-dice-five','fa-dice-six']; 
            let r1 = data.roll[0]-1, r2 = data.roll[1]-1, r3 = data.roll[2]-1;
            let s = data.sum;
            let it = (data.winner === 'None');
            if (dc) { 
              dc.innerHTML = `<i class="fas ${f[r1]} s-die"></i><i class="fas ${f[r2]} s-die"></i><i class="fas ${f[r3]} s-die"></i>`; 
              sfx.deal(); 
              document.getElementById('sb-sum').innerText = `Sum: ${s} ${it ? '(Triple!)' : ''}`; 
            } 
            let w = data.winner; 
            let tp = 0, tba = 0; 
            let wonProfit = 0, lostBet = 0;
            for (let b in mySBets) { 
              let a = mySBets[b]; tba += a; 
              if (b === w) { tp += a * 2; wonProfit += a; } else { lostBet += a;}
            } 
            let msg = it ? `TRIPLE! HOUSE WINS` : `${w.toUpperCase()}`;
            processSharedPayout('sicbo', tp, tba, msg, wonProfit, lostBet, Object.keys(mySBets).join(', '), data.resStr); 
          }, 2000); 
        }
      }
    };
    
    function openSharedGame(id) { 
      window.activeSharedGame = id; 
      document.getElementById('sg-title').innerText = sConf[id].title; 
      
      let cb = document.getElementById('sg-chat');
      if (cb) { cb.innerHTML = `<div class="chat-msg chat-sys">Connected to ${sConf[id].title} room.</div>`; }

      let o = document.getElementById('sg-overlay'); 
      if (o) { o.classList.remove('show'); o.style.display = 'none'; }
      
      mySBets = {}; 
      mySBetsStack = [];
      sConf[id].setupUI(); 
      document.querySelectorAll('.main-wrapper > .content > .view-container').forEach(d => d.classList.add('hidden')); 
      document.getElementById('view-shared-game').classList.remove('hidden'); 
      socket.emit('joinRoom', id);
    }
    
    function placeSharedBet(c) { 
      if (sState.status !== 'BETTING') { showToast("Bets are closed! Wait for next round.", "error"); return; } 
      let i = document.getElementById('sg-bet-input'); 
      if (!i) return; 
      let a = parseInt(i.value); 
      if (isNaN(a) || a <= 0) { showToast("Invalid bet.", "error"); return; } 
      if (a > myCredits) { showToast("Insufficient TC.", "error"); return; } 
      
      socket.emit('placeSharedBet', { room: window.activeSharedGame, choice: c, amount: a });
      
      myCredits -= a; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
      if (!mySBets[c]) mySBets[c] = 0; mySBets[c] += a; 
      mySBetsStack.push({ choice: c, amount: a });
      
      let tot = Object.values(mySBets).reduce((sum, val) => sum + val, 0);
      let mb = document.getElementById('sg-my-bet'); 
      if (mb) { mb.innerHTML = `${tot.toLocaleString()} TC`; } 
      
      document.querySelectorAll('#sg-bet-grid .bet-btn').forEach(b => { 
        if (b.getAttribute('data-choice') === c) { b.classList.add('has-bet'); } 
      }); 
      sfx.tick(); 
    }

    // --- SHARED PAYOUT TIMING FIX ---
    function processSharedPayout(gid, pa, tba, msg, wonProfit = 0, lostBet = 0, betsPlacedStr = "", resStr = "") { 
      const box = document.getElementById('sg-overlay'); 
      const t = document.getElementById('sg-res-title');
      const b = document.getElementById('sg-res-payout');
      if (!box) return;

      if(resStr === "") resStr = msg; 

      let net = wonProfit - lostBet;
      let h = `<div class="res-title" style="color:white;">${msg}</div>`; 

      if (tba > 0) {
          if (net > 0) {
              box.className = "result-overlay-shared win";
          } else if (net === 0) {
              box.className = "result-overlay-shared push";
          } else {
              box.className = "result-overlay-shared lose";
          }
      } else {
          box.className = "result-overlay-shared push";
      }
      
      logHistory(gid, betsPlacedStr || '-', resStr, wonProfit, lostBet, tba > 0);
      
      // Exact Pacing
      setTimeout(() => {
          if (t) t.innerHTML = msg; 
          if (tba > 0 && b) { 
            b.style.display = 'block'; 
            if (net > 0) { b.innerHTML = `Won <span style="color:var(--success)">+${net} TC</span>`; } 
            else if (net === 0) { b.innerHTML = `Push <span style="color:var(--text-muted)">Returned</span>`; } 
            else { b.innerHTML = `Lost <span style="color:var(--danger)">-${Math.abs(net)} TC</span>`; } 
          } else if (b) {
              b.style.display = 'none'; 
          } 
          
          box.style.display = 'flex';
          box.style.opacity = '0';
          
          requestAnimationFrame(() => {
              box.style.opacity = '1';
              box.classList.add('show'); 
              if (tba > 0 && net > 0) sfx.win();
              else if (tba > 0 && net < 0) sfx.lose();
          });
          
          setTimeout(() => { socket.emit('requestBalanceRefresh'); }, 1500);
      }, 500);
    }

    function wipeTableVisually() {
        let o = document.getElementById('sg-overlay'); 
        if (o) { o.classList.remove('show'); setTimeout(() => { o.style.display = 'none'; }, 300); } 
        
        let oldBetInput = document.getElementById('sg-bet-input') ? document.getElementById('sg-bet-input').value : '';
        
        if (window.activeSharedGame && sConf[window.activeSharedGame] && sConf[window.activeSharedGame].setupUI) {
            sConf[window.activeSharedGame].setupUI();
        }
        
        let newBetInput = document.getElementById('sg-bet-input');
        if(newBetInput && oldBetInput) newBetInput.value = oldBetInput;
        
        mySBets = {}; 
        mySBetsStack = [];
        let m = document.getElementById('sg-my-bet'); 
        if (m) m.innerHTML = '0 TC'; 
        
        document.querySelectorAll('#sg-bet-grid .bet-btn').forEach(btn => { btn.classList.remove('has-bet'); btn.disabled = false; }); 
    }

    socket.on('timerUpdate', (t) => { 
      sState.time = t; 
      let r = document.getElementById('sg-timer-box'), s = document.getElementById('sg-timer');
      if (sState.status === 'BETTING') {
          if (s) s.innerText = t; 
          if (t <= 5 && r) r.classList.add('closing'); 
          else if(r) r.classList.remove('closing');
      }
    });

    socket.on('lockBets', () => { 
        sState.status = 'RESOLVING'; 
        let r = document.getElementById('sg-timer-box'); 
        if (r) { r.classList.remove('closing'); r.style.color = 'var(--danger)'; r.style.borderColor = 'var(--danger)'; } 
        
        let s = document.getElementById('sg-timer');
        if (s) s.innerText = '0';
        
        if (window.activeSharedGame) {
            let cb = document.getElementById('sg-chat');
            if (cb) {
                cb.insertAdjacentHTML('beforeend', `<div class="chat-msg chat-sys">No more bets!</div>`);
                cb.scrollTop = cb.scrollHeight;
            }
        }
        
        document.querySelectorAll('.bet-btn').forEach(b => { b.disabled = true; });
        sfx.lock(); 
    });

    socket.on('sharedResults', (data) => {
        if(window.activeSharedGame === data.room && sConf[data.room]) {
            sConf[data.room].animateResult(data);
        }
    });

    socket.on('newRound', () => { 
        sState.status = 'BETTING'; 
        sState.time = 15;
        let r = document.getElementById('sg-timer-box'); 
        if (r) { r.style.color = 'white'; r.style.borderColor = 'var(--glass-border)'; } 
        
        if (window.activeSharedGame) {
            let cb = document.getElementById('sg-chat');
            if (cb) {
                cb.insertAdjacentHTML('beforeend', `<div class="chat-msg chat-sys">Place your bets!</div>`);
                cb.scrollTop = cb.scrollHeight;
            }
            wipeTableVisually();
        }
    });

    // --- CASHIER & PROMOS ---
    function openCashier() {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      sfx.click();
      switchSupportCenterTab('deposit', document.querySelectorAll('#cashier-tabs-nav .bank-tab')[0]);
      openModal('support-center-modal');
    }

    function switchSupportCenterTab(tab, el) {
      if(el) {
          document.querySelectorAll('#cashier-tabs-nav .bank-tab').forEach(b => b.classList.remove('active'));
          el.classList.add('active');
      }
      ['deposit','withdraw','requests','ledger'].forEach(t => {
        let scTab = document.getElementById('sc-tab-' + t);
        if(scTab) {
            scTab.classList.toggle('active', t === tab);
            scTab.classList.toggle('hidden', t !== tab);
        }
      });
      if(tab === 'requests') socket.emit('getTransactions');
      if(tab === 'ledger') socket.emit('getWalletLogs');
    }

    function submitDeposit() {
        const amt = document.getElementById('dep-amount').value;
        const proofInput = document.getElementById('dep-ref');
        
        if(!amt || proofInput.files.length === 0) return showToast("Please fill amount and attach proof.", "error");
        
        let filename = proofInput.files[0].name; 
        socket.emit('submitTransaction', { type: 'Deposit', amount: parseInt(amt), ref: filename });
        
        let msgBox = document.getElementById('dep-msg');
        msgBox.innerHTML = '<span style="color:var(--success)">REQUEST SUBMITTED</span>';
        setTimeout(() => { if(msgBox) msgBox.innerHTML = ''; }, 3000);

        document.getElementById('dep-amount').value = ''; 
        document.getElementById('dep-ref').value = '';
    }

    function submitWithdrawal() {
        const amt = parseInt(document.getElementById('wit-amount').value);
        const info = document.getElementById('wit-info').value;
        if(!amt || !info) return showToast("Please fill all fields.", "error");
        if(amt > myCredits) return showToast("Insufficient TC.", "error");
        
        socket.emit('submitTransaction', { type: 'Withdrawal', amount: amt, ref: info });
        
        let msgBox = document.getElementById('wit-msg');
        msgBox.innerHTML = '<span style="color:var(--success)">REQUEST SUBMITTED</span>';
        setTimeout(() => { if(msgBox) msgBox.innerHTML = ''; }, 3000);

        document.getElementById('wit-amount').value = ''; document.getElementById('wit-info').value = '';
    }

    socket.on('transactionsData', (txs) => {
        const container = document.getElementById('bank-logs-container'); container.innerHTML = '';
        if(txs.length === 0) return container.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">No requests found.</div>';
        txs.forEach(t => {
            let statClass = t.status === 'Approved' ? 'approved' : (t.status === 'Rejected' ? 'rejected' : 'pending');
            let color = t.type === 'Deposit' ? 'var(--success)' : 'var(--danger)'; let sign = t.type === 'Deposit' ? '+' : '-';
            container.innerHTML += `<div class="ticket-log-item"><div class="ticket-log-header"><span class="ticket-log-id">${t._id.substring(0,8)}... - ${new Date(t.date).toLocaleDateString()}</span><span class="ticket-log-status ${statClass}">${t.status}</span></div><div style="display:flex; justify-content:space-between; align-items:center;"><div style="font-weight:900; font-size:1.1rem; text-transform:uppercase;">${t.type}</div><div style="color:${color}; font-weight:900; font-size:1.2rem;">${sign}${t.amount} TC</div></div></div>`;
        });
    });

    socket.on('walletLogsData', (data) => {
        const container = document.getElementById('ledger-logs-container'); container.innerHTML = '';
        
        // Update today's profit HUD
        const pHud = document.getElementById('ledger-daily-profit');
        if(pHud) {
            let pColor = data.dailyProfit > 0 ? 'var(--success)' : (data.dailyProfit < 0 ? 'var(--danger)' : 'white');
            let pSign = data.dailyProfit > 0 ? '+' : '';
            pHud.innerHTML = `<span style="color:${pColor}">${pSign}${data.dailyProfit.toLocaleString()} TC</span>`;
        }

        if(data.logs.length === 0) return container.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">No ledger history found.</div>';
        data.logs.forEach(l => {
            let color = l.amount > 0 ? 'var(--success)' : (l.amount < 0 ? 'var(--danger)' : 'white'); 
            let sign = l.amount > 0 ? '+' : '';
            container.innerHTML += `<div class="ticket-log-item"><div class="ticket-log-header"><span style="color:white; font-weight:900; text-transform:uppercase; font-size:0.9rem;">${l.action}</span><span style="font-size:0.8rem; color:var(--text-muted); font-weight:600;">${new Date(l.date).toLocaleString()}</span></div><div style="display:flex; justify-content:space-between; align-items:center;"><div style="font-size:0.85rem; color:var(--text-muted); font-weight:600;">${l.details}</div><div style="color:${color}; font-weight:900; font-size:1.1rem;">${sign}${l.amount} TC</div></div></div>`;
        });
    });

    function submitPromo() {
        const code = document.getElementById('promo-code').value.trim(); 
        if(!code) return document.getElementById('promo-response').innerHTML = `<span style="color:var(--danger)">Enter a code.</span>`;
        socket.emit('redeemPromo', code);
    }

    socket.on('promoResult', (res) => {
        const div = document.getElementById('promo-response');
        div.classList.remove('anim-gift');
        void div.offsetWidth; 
        
        if(res.success) { 
            div.innerHTML = `<span style="color:var(--success)">Valid</span><br><span style="color:var(--ps-glow)">+${res.amt} TC</span>`; 
            div.classList.add('anim-gift');
            sfx.win();
            document.getElementById('promo-code').value = ''; 
        } 
        else { div.innerHTML = `<span style="color:var(--danger)">${res.msg}</span>`; }
    });

    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode === 123) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode === 'I'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode === 'C'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode === 'J'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.keyCode === 'U'.charCodeAt(0)) return false; 
    };

  </script>
</body>
</html>
