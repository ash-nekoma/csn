<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Stick N' Trade | Casino</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&family=Rajdhani:wght@600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="/socket.io/socket.io.js"></script>
<style>
/* CSS VARIABLES & RESET */
:root { --ps-bg: #000814; --ps-blue: #00439c; --ps-light-blue: #0070cc; --ps-glow: #00a2ff; --glass-bg: rgba(0, 15, 35, 0.65); --glass-border: rgba(255, 255, 255, 0.15); --glass-hover: rgba(255, 255, 255, 0.9); --danger: #ff3366; --success: #00e676; --credits: #ffb400; --text-main: #f8fafc; --text-muted: #8c9eb5; --radius: 12px; }
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; outline: none; -webkit-tap-highlight-color: transparent;}
body { background: linear-gradient(135deg, #000a1f 0%, #001f4d 50%, #000000 100%); background-size: 200% 200%; animation: AmbientBG 15s ease infinite; color: var(--text-main); min-height: 100vh; overflow-x: hidden; overflow-y: auto;}
@keyframes AmbientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
button i { pointer-events: none; }
::-webkit-scrollbar { display: none; }
.custom-scroll::-webkit-scrollbar { width: 6px; display: block; } .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
.hidden { display: none !important; opacity: 0; pointer-events: none; }

/* SHARED UI ELEMENTS */
.btn-play { background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--glass-border); padding: 15px 20px; border-radius: 8px; font-size: 1.1rem; font-weight: 900; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; }
.btn-play:hover:not(:disabled) { background: white; color: black; transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255,255,255,0.2); }
.btn-play:disabled { background: rgba(0,0,0,0.5) !important; color: var(--text-muted) !important; cursor: not-allowed !important; border-color: transparent !important; box-shadow:none !important; transform:none !important;}
.input-control { width: 100%; padding: 15px; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); color: white; border-radius: 8px; font-size: 1.1rem; font-weight: 600; text-align: center;}
.input-control:focus { border-color: var(--ps-glow); }
.input-group label { display: block; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; font-weight: 800; margin-bottom: 5px; text-align: left;}

/* AUTHENTICATION MODAL */
#auth-container { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 9999999; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); }
.auth-box { width: 450px; background: var(--glass-bg); padding: 3rem; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center; }
.auth-title { font-size: 2.8rem; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; white-space: nowrap;}
.auth-sub { color: var(--ps-glow); font-weight: 800; font-size: 1rem; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 30px; }
.auth-tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;}
.auth-tab { flex: 1; background: transparent; border: none; color: var(--text-muted); font-weight: 900; padding: 10px; cursor: pointer; text-transform: uppercase; font-size: 1.1rem; }
.auth-tab.active { border-bottom: 3px solid var(--ps-glow); color: var(--ps-glow); }
.auth-msg { font-size: 0.9rem; font-weight: 800; min-height: 20px; margin-bottom: 15px; } .auth-error { color: var(--danger); } .auth-success { color: var(--success); }
.pwd-input-wrapper { position: relative; display: flex; align-items: center;} .pwd-input-wrapper input { padding-right: 40px; } .pwd-input-wrapper i { position: absolute; right: 15px; cursor: pointer; color: var(--text-muted); }

/* TOPBAR */
#app-container { display: none; }
.topbar { position: fixed; top: 0; left: 0; right: 0; z-index: 99999; background: rgba(0,0,0,0.6); border-bottom: 1px solid var(--glass-border); backdrop-filter: blur(16px); padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; }
.brand { display: flex; align-items: center; gap: 15px; cursor: pointer; } .brand-dot { width: 14px; height: 14px; border-radius: 50%; background: var(--ps-glow); box-shadow: 0 0 20px var(--ps-glow); }
.brand-title { font-weight: 900; letter-spacing: 2px; font-size: 1.5rem; text-shadow: 0 0 10px rgba(0, 162, 255, 0.5);} .brand-sub { color: var(--ps-glow); font-weight: 800; font-size: 0.8rem; letter-spacing: 3px; }
.topbar-right { display: flex; align-items: center; gap: 20px; }
.player-profile { display: flex; align-items: center; gap: 8px; font-weight: 800; text-transform: uppercase; } .player-profile i { color: var(--ps-glow); font-size: 1.3rem; }
.wallet-pill { background: rgba(0,0,0,0.5); border: 1px solid rgba(255,180,0,0.3); padding: 8px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; font-weight: 900; font-size: 1.1rem; color: var(--credits); cursor: pointer; transition: 0.3s; }
.wallet-pill:hover { transform: translateY(-2px); border-color: var(--credits); }
.topbar-actions { display: flex; gap: 4px; background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 50px; border: 1px solid var(--glass-border); }
.top-icon-btn { position: relative; cursor: pointer; color: white; width: 34px; height: 34px; border-radius: 50%; background: transparent; border: none; font-size: 1.15rem; transition: 0.2s;} .top-icon-btn:hover { background: rgba(255,255,255,0.15); transform: scale(1.1); }

/* LOBBY & CARDS */
.main-wrapper { padding-top: 100px; display: flex; flex-direction: column; align-items: center; width: 100%; padding-bottom: 50px;}
.casino-title { font-size: 4rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; margin: 0 0 3rem 0; color: white; text-shadow: 0 0 20px rgba(255,255,255,0.2); text-align: center;}
.lobby-modes-container { display: flex; gap: 40px; justify-content: center; width: 100%; max-width: 900px; }
.mode-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative;}
.mode-card { width: 320px; height: 400px; padding: 20px;} .mode-card:hover { border-color: var(--ps-glow); transform: translateY(-10px); background: rgba(0, 30, 60, 0.8);}
.mode-icon { font-size: 6rem; margin-bottom: 2rem; color: var(--ps-light-blue); transition: 0.3s;} .mode-card:hover .mode-icon { color: white; transform: scale(1.1); text-shadow: 0 0 20px var(--ps-glow);}
.mode-title { font-size: 1.9rem; font-weight: 900; margin-bottom: 12px; } .mode-desc { color: var(--text-muted); font-size: 1.05rem; font-weight: 600; line-height: 1.6;}
.casino-grid { display: flex; flex-wrap: wrap; gap: 2.5rem; justify-content: center; max-width: 1300px;}
.game-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative; width: 280px; height: 380px; overflow: hidden;} 
.game-card:hover { border-color: white; transform: translateY(-8px); }
.game-img { flex: 1; width: 100%; display: flex; align-items: center; justify-content: center; font-size: 6rem; background: rgba(0,0,0,0.5); color: var(--ps-light-blue); transition: 0.3s;} .game-card:hover .game-img { color: white; text-shadow: 0 0 25px var(--ps-glow); }
.game-info { height: 110px; width: 100%; background: rgba(0,0,0,0.85); border-top: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; font-weight: 900; text-transform: uppercase;}
.active-players { position: absolute; top: 15px; left: 15px; color: var(--success); font-size: 1rem; font-weight: 800; z-index: 10; display: flex; align-items: center; gap: 6px; }

/* IN-GAME PANELS */
.game-box, .shared-layout { display: flex; gap: 20px; height: 650px; width: 100%; max-width: 900px; margin: 0 auto; } .shared-layout { max-width: 1100px; }
.glass-panel { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; display: flex; flex-direction: column; flex: 1; overflow: hidden; backdrop-filter: blur(20px);}
.glass-header { background: rgba(0,0,0,0.7); padding: 15px 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; font-weight: 900; font-size: 1.5rem; text-transform: uppercase;}
.game-display { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; padding: 20px;}
.controls-grid { padding: 25px; background: rgba(0,0,0,0.8); border-top: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 15px;}
.bet-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
.bet-btn { background: rgba(0,0,0,0.6); border: 1px solid var(--glass-border); color: white; padding: 15px; border-radius: 8px; font-weight: 900; cursor: pointer; text-transform: uppercase; transition: 0.2s;}
.bet-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
.bet-btn.has-bet { border-color: var(--tile-color); box-shadow: inset 0 0 10px rgba(255,255,255,0.1), 0 0 15px var(--tile-color); transform: translateY(-3px); }

/* CHAT & TIMER */
.chat-panel { width: 320px; display: flex; flex-direction: column; }
.chat-body { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
.chat-msg { background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 8px; border-left: 3px solid var(--ps-light-blue); animation: popIn 0.2s ease-out; } .chat-user { font-weight: 900; color: var(--ps-glow); font-size: 0.85rem; margin-bottom: 5px;} .chat-sys { border-left-color: var(--success); color: var(--success); font-style: italic; font-weight: 600; }
.timer-box { background: rgba(0,0,0,0.8); border: 1px solid var(--glass-border); padding: 8px 15px; border-radius: 8px; font-weight: 900; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; font-family: 'Rajdhani', monospace; transition: 0.3s;} 
.timer-box.closing { border-color: var(--danger); color: var(--danger); box-shadow: 0 0 20px rgba(255,51,102,0.4); animation: shake 0.5s infinite;}

/* ANIMATIONS & ASSETS */
.dice-icon { font-size: 7rem; text-shadow: 0 10px 30px rgba(0,0,0,0.8); } #dice-num { font-size: 6rem; font-weight: 900; }
.anim-shake { animation: shake 0.3s infinite; } @keyframes shake { 0%,100%{transform:rotate(0deg);} 25%{transform:rotate(-15deg);} 75%{transform:rotate(15deg);} }
.coin-wrapper { width: 200px; height: 200px; perspective: 1000px; } .coin-inner { width: 100%; height: 100%; transition: transform 2.5s cubic-bezier(0.25,1,0.2,1); transform-style: preserve-3d; position: relative; }
.coin-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; font-size: 5rem; border-radius: 50%; border: 8px solid; }
.coin-heads { background: radial-gradient(circle, #fde047, #b45309); color: #78350f; border-color: #f59e0b; } .coin-tails { background: radial-gradient(circle, #e2e8f0, #475569); color: #0f172a; border-color: #94a3b8; transform: rotateY(180deg); }
.tossing { animation: toss 2.5s cubic-bezier(0.25,1,0.2,1); } @keyframes toss { 0%,100%{transform:scale(1) translateY(0);} 50%{transform:scale(1.5) translateY(-50px);} }
.play-card { background: white; color: black; width: 65px; height: 95px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 900; font-size: 1.6rem; border: 1px solid #ccc; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
.card-red { color: #e60000; } .card-back { background: repeating-linear-gradient(45deg, #001f4d, #000a1f 10px); color: transparent; border: 2px solid white; }
.anim-deal { animation: deal 0.4s ease-out; } @keyframes deal { 0%{opacity:0; transform:translateY(-100px) rotateY(180deg);} 100%{opacity:1; transform:translateY(0) rotateY(0deg);} }
.color-dice-container { display: flex; gap: 30px; font-size: 6rem; } .color-die { width: 130px; height: 130px; border-radius: 16px; border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; background: #111; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); } .c-grey{background:#333;} .c-yellow{background:#ffcc00;} .c-white{background:#fff;} .c-pink{background:#ff66b2;} .c-blue{background:#00a2ff;} .c-red{background:#ff3366;} .c-green{background:#00e676;}
.dt-arena { display: flex; gap: 80px; align-items: center; } .dt-side { display: flex; flex-direction: column; align-items: center; gap: 10px; } .dt-label { font-size: 1.5rem; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }

/* DAILY REWARD */
.dr-days { display: flex; gap: 10px; justify-content: center; align-items: flex-end; margin-bottom: 25px; height: 160px; }
.dr-day { flex: 1; background: linear-gradient(180deg, #1a2a6c, #001f4d); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 10px 5px; height: 130px; position: relative; overflow: hidden; transition: 0.3s; }
.dr-day::before { content: ''; position: absolute; inset: -50%; background: repeating-conic-gradient(rgba(255,255,255,0.08) 0 15deg, transparent 15deg 30deg); opacity: 0.8; animation: spin 20s linear infinite; z-index: 0; }
@keyframes spin { 100% { transform: rotate(360deg); } }
.dr-day > * { position: relative; z-index: 1; }
.dr-day.claimed { filter: grayscale(1); opacity: 0.6; } .dr-day.claimed::before { display: none; }
.dr-day.active { background: linear-gradient(180deg, #ffcc00, #ff9900); border-color: white; transform: scale(1.1); height: 150px; color: black; z-index: 5; }
.dr-day.active::before { background: repeating-conic-gradient(rgba(255,255,255,0.3) 0 15deg, transparent 15deg 30deg); opacity: 0.6; display: block;}
.dr-day.active .dr-title, .dr-day.active .dr-coin { color: black; text-shadow: none; }
.dr-day.active.active-claimed { background: rgba(255,255,255,0.1); border-color: var(--glass-border); filter: grayscale(1); color: white; opacity: 0.8;}
.dr-day.active.active-claimed .dr-title, .dr-day.active.active-claimed .dr-coin { color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }

.dr-title { font-size: 0.9rem; font-weight: 900; text-transform: uppercase; margin-top: 5px; text-align: center;}
.dr-coin { font-size: 1rem; font-weight: 900; text-align: center; margin-bottom: 5px;}
#dr-status-container { text-align: center; margin-top: 10px; }
.dr-status-text { font-size: 1.2rem; font-weight: 900; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px;}
.dr-timer { font-size: 1.5rem; font-weight: 900; color: var(--ps-glow); font-family: 'Rajdhani', sans-serif;}

/* TOAST & RESULTS */
.toast { position: fixed; top: 20px; right: 20px; background: rgba(5,10,25,0.95); padding: 15px 25px; border-radius: 8px; border-left: 5px solid var(--ps-glow); color: white; font-weight: 800; transform: translateX(120%); transition: 0.4s; z-index: 9999999; box-shadow: 0 10px 30px rgba(0,0,0,0.5);}
.toast.show { transform: translateX(0); } .toast-error { border-color: var(--danger); }
.result-box { position: absolute; bottom: 20px; right: 20px; padding: 15px 30px; border-radius: 8px; text-align: right; font-weight: 900; text-transform: uppercase; display: none; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);}
.result-box.win { background: rgba(0,230,118,0.15); border: 1px solid var(--success); color: var(--success); border-right: 4px solid var(--success); }
.result-box.lose { background: rgba(255,51,102,0.15); border: 1px solid var(--danger); color: var(--danger); border-right: 4px solid var(--danger); }
.result-box.push { background: rgba(255,255,255,0.1); border: 1px solid white; color: white; border-right: 4px solid white; }
@keyframes popIn { 0%{transform: scale(0.8) translateX(50px); opacity:0;} 100%{transform: scale(1) translateX(0); opacity:1;} }
.anim-pop { animation: popBal 0.5s ease-out; } @keyframes popBal { 50%{transform: scale(1.1); background: rgba(0,230,118,0.3); border-color: var(--success);} }

/* MODALS */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
.modal-content { background: var(--glass-bg); width: 500px; padding: 2.5rem; border-radius: 12px; border: 1px solid var(--glass-border); position: relative; display: flex; flex-direction: column; }
.modal-close-icon { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); transition: 0.2s;} .modal-close-icon:hover { color: var(--danger); }
.modal-content h3 { font-size: 2rem; font-weight: 900; margin-top: 0; margin-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; text-transform: uppercase; text-align: center; }
.bank-tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;}
.bank-tab { flex: 1; background: transparent; border: none; border-bottom: 4px solid transparent; color: var(--text-muted); font-weight: 900; padding: 12px; cursor: pointer; text-transform: uppercase; font-size: 1.1rem;}
.bank-tab.active { border-bottom: 4px solid var(--ps-glow); color: var(--ps-glow); }
.bank-section { display: none; flex: 1; } .bank-section.active { display: block; }
.btn-rules { background: transparent; color: var(--text-muted); border: 1px solid var(--glass-border); padding: 8px 12px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; transition: 0.2s; display: flex; justify-content: center;} .btn-rules:hover { background: rgba(255,255,255,0.1); color: white; }
</style>
</head>
<body>

  <div id="toast-container"></div>

  <div id="auth-container">
      <div class="auth-box">
          <div class="auth-title">STICK N' TRADE</div><div class="auth-sub">CASINO</div>
          <div class="auth-tabs"><button class="auth-tab active" onclick="switchAuthTab('login')">Login</button><button class="auth-tab" onclick="switchAuthTab('register')">Register</button></div>
          
          <div id="auth-form-login">
              <div class="input-group"><input type="text" id="login-user" class="input-control" placeholder="Username" style="margin-bottom:15px;"></div>
              <div class="input-group pwd-input-wrapper" style="margin-bottom:15px;"><input type="password" id="login-pass" class="input-control" placeholder="Password"><i class="fas fa-eye" onclick="toggleInputPwd('login-pass', this)"></i></div>
              <div id="auth-error-login" class="auth-msg auth-error"></div>
              <button class="btn-play" style="width:100%;" onclick="submitAuth('login')">LOGIN</button>
          </div>
          
          <div id="auth-form-register" class="hidden">
              <div class="input-group"><input type="text" id="reg-user" class="input-control" placeholder="Username" style="margin-bottom:15px;"></div>
              <div class="input-group pwd-input-wrapper" style="margin-bottom:15px;"><input type="password" id="reg-pass" class="input-control" placeholder="Password"><i class="fas fa-eye" onclick="toggleInputPwd('reg-pass', this)"></i></div>
              <div id="auth-error-register" class="auth-msg auth-error"></div>
              <button class="btn-play" style="width:100%; border-color:var(--success); color:var(--success);" onclick="submitAuth('register')">REGISTER</button>
          </div>
      </div>
  </div>

  <div id="app-container">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand" onclick="switchView('casino')"><div class="brand-dot"></div><div><div class="brand-title">STICK N' TRADE</div><div class="brand-sub">CASINO</div></div></div>
        
        <div class="topbar-right">
          <div class="player-profile"><i class="fas fa-user-circle"></i> <span id="player-name-display">Player</span></div>
          <div class="wallet-pill" id="pill-credits" onclick="openCashier()"><i class="fas fa-coins"></i> <span id="nav-credits">0</span> <span style="font-size:0.8rem; opacity:0.6;">TC</span></div>
          <div class="topbar-actions">
              <button class="top-icon-btn" onclick="openModal('daily-reward-modal')"><i class="fas fa-calendar-check" style="color:var(--credits)"></i></button>
              <button class="top-icon-btn" onclick="openModal('promo-modal')"><i class="fas fa-gift" style="color:var(--ps-glow)"></i></button>
              <button class="top-icon-btn" id="mute-btn" onclick="toggleAudio()"><i class="fas fa-volume-up"></i></button>
              <button class="top-icon-btn" onclick="confirmLogout()"><i class="fas fa-sign-out-alt" style="color:var(--danger);"></i></button>
          </div>
        </div>
      </div>
    </header>

    <div class="main-wrapper">
        <div id="view-casino" class="view-container">
            <h1 class="casino-title">STICK N' TRADE CASINO</h1>
            <div id="lobby-modes" class="lobby-modes-container">
                <div class="mode-card" onclick="openLobbyMode('indiv')"><i class="fas fa-user mode-icon"></i><div class="mode-title">SOLO PLAY</div><div class="mode-desc">Single-player mini games.<br>Quick rounds and instant payouts.</div></div>
                <div class="mode-card" onclick="openLobbyMode('shared')"><i class="fas fa-users mode-icon"></i><div class="mode-title">SHARED TABLES</div><div class="mode-desc">Multiplayer game rooms.<br>Play with others live.</div></div>
            </div>
            
            <div id="lobby-indiv" class="hidden" style="width:100%; max-width: 1000px; display:flex; flex-direction:column; align-items:center;">
                <button class="btn-play" style="margin-bottom:30px; min-width: 200px;" onclick="openLobbyMode('modes')">Back to Hub</button>
                <div class="casino-grid">
                    <div class="game-card" onclick="openGame('dice')"><div class="game-img"><i class="fas fa-dice"></i></div><div class="game-info">Dice Roll</div></div>
                    <div class="game-card" onclick="openGame('coinflip')"><div class="game-img"><i class="fas fa-coins"></i></div><div class="game-info">Coin Flip</div></div>
                    <div class="game-card" onclick="openGame('blackjack')"><div class="game-img">‚ô†Ô∏è</div><div class="game-info">Blackjack</div></div>
                </div>
            </div>

            <div id="lobby-shared" class="hidden" style="width:100%; max-width: 1300px; display:flex; flex-direction:column; align-items:center;">
                <button class="btn-play" style="margin-bottom:30px; min-width: 200px;" onclick="openLobbyMode('modes')">Back to Hub</button>
                <div class="casino-grid">
                    <div class="game-card" onclick="openSharedGame('baccarat')"><div class="active-players"><i class="fas fa-users"></i> <span class="ap-count">0</span></div><div class="game-img">üÉè</div><div class="game-info">Baccarat</div></div>
                    <div class="game-card" onclick="openSharedGame('perya')"><div class="active-players"><i class="fas fa-users"></i> <span class="ap-count">0</span></div><div class="game-img"><i class="fas fa-dice-d6"></i></div><div class="game-info">Color Game</div></div>
                    <div class="game-card" onclick="openSharedGame('dt')"><div class="active-players"><i class="fas fa-users"></i> <span class="ap-count">0</span></div><div class="game-img"><i class="fas fa-dragon"></i></div><div class="game-info">Dragon Tiger</div></div>
                    <div class="game-card" onclick="openSharedGame('sicbo')"><div class="active-players"><i class="fas fa-users"></i> <span class="ap-count">0</span></div><div class="game-img"><i class="fas fa-dice"></i></div><div class="game-info">Sic Bo</div></div>
                </div>
            </div>
        </div>

        <div id="view-game-dice" class="view-container hidden">
            <button class="btn-play" style="margin-bottom:20px;" onclick="switchView('casino')">Leave Table</button>
            <div class="game-box">
                <div class="glass-panel">
                    <div class="glass-header"><span>Dice Roll</span><div style="display:flex;gap:10px;"><button class="btn-rules" onclick="openRules('dice')" title="Rules"><i class="fas fa-info-circle"></i></button><button class="btn-rules" onclick="openGameHistory('dice')" title="My History"><i class="fas fa-history"></i></button><button class="btn-rules" onclick="openGlobalResults('dice')" title="Recent Results"><i class="fas fa-list-ol"></i></button></div></div>
                    <div class="game-display"><i class="fas fa-dice-d20 dice-icon" id="dice-icon"></i><div id="dice-num" style="display:none; color:white;">0</div><div id="dice-msg" class="result-box"></div></div>
                    <div class="controls-grid" style="align-items:center;">
                        <input type="number" id="dice-bet" class="input-control" placeholder="Bet Amount" style="max-width:200px;">
                        <button class="btn-play" id="btn-dice" onclick="playDice()" style="width:200px; background:var(--ps-glow); color:#000;">ROLL (2x)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-game-coinflip" class="view-container hidden">
            <button class="btn-play" style="margin-bottom:20px;" onclick="switchView('casino')">Leave Table</button>
            <div class="game-box">
                <div class="glass-panel">
                    <div class="glass-header"><span>Coin Flip</span><div style="display:flex;gap:10px;"><button class="btn-rules" onclick="openRules('coinflip')" title="Rules"><i class="fas fa-info-circle"></i></button><button class="btn-rules" onclick="openGameHistory('coinflip')" title="My History"><i class="fas fa-history"></i></button><button class="btn-rules" onclick="openGlobalResults('coinflip')" title="Recent Results"><i class="fas fa-list-ol"></i></button></div></div>
                    <div class="game-display">
                        <div class="coin-wrapper" id="coin-wrapper"><div class="coin-inner" id="coin-obj"><div class="coin-face coin-heads"><i class="fas fa-coins"></i></div><div class="coin-face coin-tails"><i class="fas fa-gem"></i></div></div></div>
                        <div id="coin-msg" class="result-box"></div>
                    </div>
                    <div class="controls-grid" style="align-items:center;">
                        <input type="number" id="coin-bet" class="input-control" placeholder="Bet Amount" style="max-width:200px;">
                        <div style="display:flex;gap:10px;"><button class="btn-play" id="btn-heads" onclick="playCoin('Heads')" style="border-color:var(--credits); color:var(--credits); width:100px;">Heads</button><button class="btn-play" id="btn-tails" onclick="playCoin('Tails')" style="width:100px;">Tails</button></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-game-blackjack" class="view-container hidden">
            <button class="btn-play" style="margin-bottom:20px;" onclick="switchView('casino')">Leave Table</button>
            <div class="game-box" style="max-width:1000px;">
                <div class="glass-panel">
                    <div class="glass-header"><span>Blackjack</span><div style="display:flex;gap:10px;"><button class="btn-rules" onclick="openRules('blackjack')" title="Rules"><i class="fas fa-info-circle"></i></button><button class="btn-rules" onclick="openGameHistory('blackjack')" title="My History"><i class="fas fa-history"></i></button><button class="btn-rules" onclick="openGlobalResults('blackjack')" title="Recent Results"><i class="fas fa-list-ol"></i></button></div></div>
                    <div class="game-display">
                        <div style="display:flex;gap:50px;width:100%;justify-content:center;">
                            <div style="text-align:center;background:rgba(0,0,0,0.5);padding:20px;border-radius:12px;width:300px;"><div style="color:var(--text-muted);font-weight:900;margin-bottom:10px;">DEALER</div><div id="bj-d-score" style="font-size:2.5rem;font-weight:900;margin-bottom:15px;line-height:1;">0</div><div id="bj-d-hand" style="display:flex;gap:5px;justify-content:center;min-height:100px;"></div></div>
                            <div style="text-align:center;background:rgba(0,0,0,0.5);padding:20px;border-radius:12px;width:300px;"><div style="color:var(--ps-glow);font-weight:900;margin-bottom:10px;">YOU</div><div id="bj-p-score" style="font-size:2.5rem;font-weight:900;margin-bottom:15px;line-height:1;">0</div><div id="bj-p-hand" style="display:flex;gap:5px;justify-content:center;min-height:100px;"></div></div>
                        </div>
                        <div id="bj-msg" class="result-box"></div>
                    </div>
                    <div class="controls-grid" id="bj-start-controls" style="align-items:center;">
                        <input type="number" id="bj-bet" class="input-control" placeholder="Bet Amount" style="max-width:200px;">
                        <button class="btn-play" id="btn-bj-deal" onclick="startBlackjack()" style="width:200px; background:var(--ps-glow); color:#000;">DEAL</button>
                    </div>
                    <div class="controls-grid hidden" id="bj-action-controls" style="display:flex; flex-direction:row; justify-content:center;">
                        <button class="btn-play" id="btn-bj-hit" onclick="hitBlackjack()" style="border-color:var(--ps-glow); color:var(--ps-glow); width:150px;">HIT</button>
                        <button class="btn-play" id="btn-bj-stand" onclick="standBlackjack()" style="border-color:var(--danger); color:var(--danger); width:150px;">STAND</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-shared-game" class="view-container hidden">
            <button class="btn-play" style="margin-bottom:20px;" onclick="backToSharedLobby()">Leave Table</button>
            <div class="shared-layout">
                <div class="glass-panel main-panel">
                    <div class="glass-header"><span id="sg-title">Table</span><div style="display:flex; gap:10px; align-items:center;"><div class="timer-box" id="sg-timer-box"><i class="fas fa-clock"></i> <span id="sg-timer">15</span>s</div><button class="btn-rules" onclick="openRules(activeSharedGame)" title="Rules"><i class="fas fa-info-circle"></i></button><button class="btn-rules" onclick="openGameHistory(activeSharedGame)" title="My History"><i class="fas fa-history"></i></button><button class="btn-rules" onclick="openGlobalResults(activeSharedGame)" title="Recent Results"><i class="fas fa-list-ol"></i></button></div></div>
                    <div class="game-display" id="sg-display"></div>
                    <div class="controls-grid" id="sg-controls-container"></div>
                </div>
                <div class="glass-panel chat-panel">
                    <div class="glass-header"><div>LIVE CHAT</div><div style="color:var(--success); font-size:1rem;"><i class="fas fa-users"></i> <span id="sg-active-players">0</span></div></div>
                    <div class="chat-body custom-scroll" id="sg-chat"></div>
                    <div style="padding:15px; border-top:1px solid var(--glass-border);"><input type="text" id="chat-input" class="input-control" placeholder="Say something..." onkeypress="if(event.key==='Enter') sendChat()"></div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="daily-reward-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 800px; text-align:center; max-width: 95vw;">
      <i class="fas fa-times modal-close-icon" onclick="closeModal('daily-reward-modal')"></i>
      <h3 style="color:var(--credits); border:none; margin-bottom:5px;">Daily Reward</h3>
      <p style="color:var(--text-muted); margin-bottom:25px;">Claim credits every 24 hours!</p>
      <div class="dr-days">
          <div class="dr-day" id="dr-day-1"><div class="dr-title">Day 1</div><div class="dr-coin">25 TC</div></div>
          <div class="dr-day" id="dr-day-2"><div class="dr-title">Day 2</div><div class="dr-coin">50 TC</div></div>
          <div class="dr-day" id="dr-day-3"><div class="dr-title">Day 3</div><div class="dr-coin">100 TC</div></div>
          <div class="dr-day" id="dr-day-4"><div class="dr-title">Day 4</div><div class="dr-coin">200 TC</div></div>
          <div class="dr-day" id="dr-day-5"><div class="dr-title">Day 5</div><div class="dr-coin">500 TC</div></div>
          <div class="dr-day" id="dr-day-6"><div class="dr-title">Day 6</div><div class="dr-coin">750 TC</div></div>
          <div class="dr-day" id="dr-day-7"><div class="dr-title">Day 7</div><div class="dr-coin">1000 TC</div></div>
      </div>
      <div id="dr-status-container"></div>
    </div>
  </div>

  <div id="promo-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 400px; text-align:center;">
        <i class="fas fa-times modal-close-icon" onclick="closeModal('promo-modal')"></i>
        <h3 style="margin-top:0;">REDEEM CODE</h3>
        <p style="color:var(--text-muted); margin-bottom:20px;">Enter your gift code below.</p>
        <input type="text" id="promo-code" class="input-control" placeholder="XXXX-XXXX-XXXX" style="margin-bottom:10px;">
        <div id="promo-response" style="font-weight:800; min-height:45px; margin-bottom:15px; font-size:1.1rem;"></div>
        <button class="btn-play" style="width:100%;" onclick="submitPromo()">REDEEM</button>
    </div>
  </div>

  <div id="support-center-modal" class="modal-overlay hidden">
    <div class="modal-content" style="width: 550px; height: 550px; padding: 2rem;">
      <i class="fas fa-times modal-close-icon" onclick="closeModal('support-center-modal')"></i>
      <h3>CASHIER</h3>
      <div class="bank-tabs"><button class="bank-tab active" onclick="switchSupportCenterTab('deposit', this)">Deposit</button><button class="bank-tab" onclick="switchSupportCenterTab('withdraw', this)">Withdraw</button><button class="bank-tab" onclick="switchSupportCenterTab('requests', this)">Requests</button></div>
      
      <div id="sc-tab-deposit" class="bank-section active">
        <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.95rem; text-align:center;">Send funds and enter your reference number below.</p>
        <div class="input-group"><label>Amount (TC)</label><input type="number" id="dep-amount" class="input-control" placeholder="e.g. 5000"></div>
        <div class="input-group"><label>Reference Number</label><input type="text" id="dep-ref" class="input-control" placeholder="Enter Code"></div>
        <button class="btn-play" style="width:100%; margin-top:10px;" onclick="submitDeposit()">Submit Deposit</button>
      </div>
      
      <div id="sc-tab-withdraw" class="bank-section hidden">
        <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.95rem; text-align:center;">Withdraw your TC to real world currency.</p>
        <div class="input-group"><label>Withdraw Amount (TC)</label><input type="number" id="wit-amount" class="input-control" placeholder="e.g. 10000"></div>
        <div class="input-group"><label>Account Details (Name/Number)</label><input type="text" id="wit-info" class="input-control" placeholder="Where should we send it?"></div>
        <button class="btn-play" style="width:100%; margin-top:10px;" onclick="submitWithdrawal()">Request Withdrawal</button>
      </div>
      
      <div id="sc-tab-requests" class="bank-section hidden custom-scroll" style="height: 100%; max-height: 350px; overflow-y:auto; padding-right:5px;">
        <div id="bank-logs-container"><div style="text-align:center; color:var(--text-muted); padding:20px;">Fetching logs...</div></div>
      </div>
    </div>
  </div>

  <div id="game-history-modal" class="modal-overlay hidden">
     <div class="modal-content" style="width: 550px; height: auto; min-height: fit-content; max-height: 80vh;">
        <i class="fas fa-times modal-close-icon" onclick="closeModal('game-history-modal')"></i>
        <h3 id="gh-title" style="margin-top:0;">My History</h3>
        
        <div id="gh-list" class="custom-scroll" style="overflow-y:auto; display:flex; flex-direction:column; max-height: 400px; padding-right:5px;">
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; padding:10px 15px; border-bottom:2px solid var(--glass-border); font-weight:900; color:var(--text-muted); text-transform:uppercase; font-size:0.85rem; position:sticky; top:0; background:var(--glass-bg); z-index:10;">
                <div>Result</div><div style="text-align:center; color:var(--success)">Win</div><div style="text-align:right; color:var(--danger)">Loss</div>
            </div>
            <div id="gh-items" style="display:flex; flex-direction:column; gap:8px; margin-top:10px;"></div>
        </div>
     </div>
  </div>

  <div id="global-results-modal" class="modal-overlay hidden">
     <div class="modal-content" style="width: 500px; height: auto; min-height: fit-content; max-height: 80vh;">
        <i class="fas fa-times modal-close-icon" onclick="closeModal('global-results-modal')"></i>
        <h3 id="gr-title" style="margin-top:0;">Recent Results</h3>
        
        <div class="custom-scroll" style="overflow-y:auto; display:flex; flex-direction:column; max-height: 400px; padding-right:5px;">
            <div style="display:grid; grid-template-columns: 1fr 3fr; gap:10px; padding:10px 15px; border-bottom:2px solid var(--glass-border); font-weight:900; color:var(--text-muted); text-transform:uppercase; font-size:0.85rem; position:sticky; top:0; background:var(--glass-bg); z-index:10;">
                <div>Time</div><div>Outcome</div>
            </div>
            <div id="gr-items" style="display:flex; flex-direction:column; gap:8px; margin-top:10px;"></div>
        </div>
     </div>
  </div>

  <div id="rules-modal" class="modal-overlay hidden">
     <div class="modal-content" style="width: 500px; height: auto; min-height: fit-content; padding: 2rem;">
        <i class="fas fa-times modal-close-icon" onclick="closeModal('rules-modal')"></i>
        <h3 id="rules-title" style="margin-top:0;">How to Play</h3>
        <div id="rules-body" style="color:var(--text-muted); font-size:1.05rem; line-height:1.6; margin-left: 20px;"></div>
     </div>
  </div>

  <script>
    // --- SOCKET.IO & GLOBAL STATE ---
    const socket = io(); 
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let audioMuted = false, sfxGainVal = 0.8;
    
    let myUsername = '';
    let myCredits = 0;
    let myGameHistory = { dice: [], coinflip: [], blackjack: [], baccarat: [], perya: [], dt: [], sicbo: [] };
    
    let activeSharedGame = null;
    let sState = { time: 15, status: 'BETTING' };
    let mySBets = {};
    let dailyTimerInterval = null;

    // --- UI BASICS & MODALS ---
    function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    const delay = ms => new Promise(res => setTimeout(res, ms));

    function showToast(msg, type='success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type} show`;
        if(type === 'error') toast.classList.add('toast-error');
        let icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // --- AUTHENTICATION ---
    function switchAuthTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        if(tab === 'login') {
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            document.getElementById('auth-form-login').style.display = 'block';
            document.getElementById('auth-form-register').style.display = 'none';
        } else {
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('auth-form-login').style.display = 'none';
            document.getElementById('auth-form-register').style.display = 'block';
        }
        document.getElementById('auth-error-login').innerText = '';
        document.getElementById('auth-error-register').innerText = '';
    }

    function toggleInputPwd(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === "password") { input.type = "text"; icon.className = "fas fa-eye-slash"; } 
        else { input.type = "password"; icon.className = "fas fa-eye"; }
    }

    function submitAuth(mode) {
        const uId = mode === 'login' ? 'login-user' : 'reg-user';
        const pId = mode === 'login' ? 'login-pass' : 'reg-pass';
        const user = document.getElementById(uId).value.trim();
        const pass = document.getElementById(pId).value;
        if(!user || !pass) return document.getElementById(mode === 'login' ? 'auth-error-login' : 'auth-error-register').innerText = "Please fill all fields.";
        socket.emit(mode, { username: user, password: pass });
    }

    socket.on('authError', (msg) => {
        document.getElementById('auth-error-login').innerText = msg;
        document.getElementById('auth-error-register').innerText = msg;
    });

    socket.on('registerSuccess', (msg) => {
        document.getElementById('auth-error-register').className = 'auth-msg auth-success';
        document.getElementById('auth-error-register').innerText = msg;
        setTimeout(() => { switchAuthTab('login'); }, 1000);
    });

    socket.on('loginSuccess', (data) => {
        myUsername = data.username;
        myCredits = data.credits;
        document.getElementById('player-name-display').innerText = myUsername;
        document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
        
        setupDailyRewardUI(data.daily);

        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        if (audioCtx.state === 'suspended') audioCtx.resume();
        showToast(`Welcome, ${myUsername}!`, "success");
    });

    socket.on('balanceUpdate', (newBalance) => {
        let p1 = document.getElementById('pill-credits');
        if(newBalance > myCredits) { p1.classList.remove('anim-pop'); void p1.offsetWidth; p1.classList.add('anim-pop'); sfx.win(); }
        myCredits = newBalance;
        document.getElementById('nav-credits').innerText = myCredits.toLocaleString(); 
    });

    // --- DAILY REWARD LOGIC ---
    function setupDailyRewardUI(dailyData) {
        document.querySelectorAll('.dr-day').forEach(el => el.className = 'dr-day');
        
        for(let i=1; i<=7; i++) {
            let el = document.getElementById('dr-day-'+i);
            if(i < dailyData.day) {
                el.classList.add('claimed');
            } else if(i === dailyData.day) {
                el.classList.add('active');
                if(!dailyData.canClaim) el.classList.add('active-claimed');
            }
        }

        let statusContainer = document.getElementById('dr-status-container');
        if(dailyData.canClaim) {
            statusContainer.innerHTML = `<button class="btn-play" id="btn-claim-reward" style="width:250px; margin:0 auto; background:#ffcc00; color:#000;" onclick="claimDaily()">CLAIM REWARD</button>`;
        } else {
            startDailyTimer(dailyData.nextClaim);
        }
    }

    function claimDaily() { socket.emit('claimDaily'); }

    socket.on('dailyClaimed', (data) => {
        document.querySelector('.dr-day.active').classList.add('active-claimed');
        startDailyTimer(data.nextClaim);
        showToast(`Reward Claimed: +${data.amt} TC!`);
    });

    function startDailyTimer(nextClaimDate) {
        let sc = document.getElementById('dr-status-container');
        sc.innerHTML = `<div class="dr-status-text" style="margin-top:10px;">COME BACK TOMORROW</div><div class="dr-timer" id="dr-timer-display" style="margin-top:5px;">--:--:--</div>`;
        
        let dest = new Date(nextClaimDate).getTime();
        if(dailyTimerInterval) clearInterval(dailyTimerInterval);
        
        dailyTimerInterval = setInterval(() => {
            let now = new Date().getTime();
            let d = dest - now;
            
            if(d <= 0) { 
                clearInterval(dailyTimerInterval); 
                sc.innerHTML = `<button class="btn-play" onclick="location.reload()" style="width:250px; margin:0 auto; background:#ffcc00; color:#000;">REFRESH TO CLAIM</button>`; 
                return; 
            }
            
            let h = Math.floor((d % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            let m = Math.floor((d % (1000 * 60 * 60)) / (1000 * 60));
            let s = Math.floor((d % (1000 * 60)) / 1000);
            
            h = (h < 10) ? "0" + h : h;
            m = (m < 10) ? "0" + m : m;
            s = (s < 10) ? "0" + s : s;

            document.getElementById('dr-timer-display').innerText = `${h}:${m}:${s}`;
        }, 1000);
    }

    // --- RULES & HISTORY ---
    const gameInfoMap = {
      'dice': { title: "Dice Roll", body: "<ul><li style='margin-bottom:10px;'>Enter your bet amount and click <strong>Roll</strong>.</li><li style='margin-bottom:10px;'>Generates a random number between 1 and 100.</li><li style='margin-bottom:10px;'><strong>51 through 100</strong> wins (2x Payout).</li><li style='margin-bottom:10px;'><strong>1 through 50</strong> loses.</li></ul>" },
      'coinflip': { title: "Coin Flip", body: "<ul><li style='margin-bottom:10px;'>Enter your bet and choose either <strong>Heads</strong> or <strong>Tails</strong>.</li><li style='margin-bottom:10px;'>True 50/50 chance.</li><li style='margin-bottom:10px;'>Winning pays <strong>2x</strong> your bet.</li></ul>" },
      'baccarat': { title: "Baccarat", body: "<ul><li style='margin-bottom:10px;'>Bet on Player, Banker, or Tie. Hand closest to <strong>9</strong> wins.</li><li style='margin-bottom:10px;'><strong>Card Rules:</strong> The standard 3rd card draw rules apply based on the initial total values of Player and Banker hands.</li><li style='margin-bottom:10px;'>Player pays <strong>2x</strong>. Banker pays <strong>1.95x</strong>. Tie pays <strong>8x</strong>.</li></ul>" },
      'blackjack': { title: "Blackjack", body: "<ul><li style='margin-bottom:10px;'>Beat the dealer without going over 21.</li><li style='margin-bottom:10px;'>Dealer must draw to 16 and stand on <strong>17 or higher</strong>.</li><li style='margin-bottom:10px;'>Natural Blackjack pays <strong>2.5x</strong>. Standard wins pay <strong>2x</strong>. Ties push.</li></ul>" },
      'perya': { title: "Color Game", body: "<ul><li style='margin-bottom:10px;'>Bet on Red, Blue, Yellow, White, Green, or Pink.</li><li style='margin-bottom:10px;'>Starting dice are question marks. 3 dice are rolled.</li><li style='margin-bottom:10px;'>1 Match pays <strong>2x</strong>. 2 Matches pay <strong>3x</strong>. 3 Matches pay <strong>4x</strong>!</li></ul>" },
      'dt': { title: "Dragon Tiger", body: "<ul><li style='margin-bottom:10px;'>Bet on Dragon, Tiger, or Tie. Highest card wins.</li><li style='margin-bottom:10px;'>Aces are low (1). Kings are high (13).</li><li style='margin-bottom:10px;'>Dragon/Tiger pays <strong>2x</strong>. Tie pays <strong>8x</strong>.</li></ul>" },
      'sicbo': { title: "Sic Bo", body: "<ul><li style='margin-bottom:10px;'>Bet on Small (Sum 4-10) or Big (Sum 11-17).</li><li style='margin-bottom:10px;'>Wins pay <strong>2x</strong>.</li><li style='margin-bottom:10px;'>Any Triple roll loses all Big/Small bets.</li></ul>" }
    };

    function openRules(k) { 
      if (!k || !gameInfoMap[k]) return; 
      document.getElementById('rules-title').innerHTML = gameInfoMap[k].title + " Rules"; 
      document.getElementById('rules-body').innerHTML = gameInfoMap[k].body; 
      openModal('rules-modal'); 
    }

    function openGameHistory(id) {
       if (!id || !gameInfoMap[id]) return; 
       document.getElementById('gh-title').innerText = gameInfoMap[id].title + " History"; 
       const list = document.getElementById('gh-items');
       list.innerHTML = '';
       const history = myGameHistory[id] || [];
       if(history.length === 0) {
          list.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding: 20px;">No history available yet.</div>`;
       } else {
          history.forEach(h => {
             let isWin = h.payout > h.bet;
             let isPush = h.payout === h.bet;
             let winVal = isWin ? `+${h.payout - h.bet}` : (isPush ? 'PUSH' : '-');
             let lossVal = (!isWin && !isPush) ? `-${h.bet}` : '-';
             let color = isWin ? 'var(--success)' : (isPush ? 'white' : 'var(--danger)');

             list.innerHTML += `
                <div style="background:rgba(0,0,0,0.5); padding:12px 15px; border-radius:6px; border-left:4px solid ${color}; display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; align-items:center; font-size:0.95rem;">
                   <span style="font-weight:800; text-transform:uppercase;">${h.result}</span>
                   <span style="color:var(--success); font-weight:800; text-align:center;">${winVal}</span>
                   <span style="color:var(--danger); font-weight:800; text-align:right;">${lossVal}</span>
                </div>
             `;
          });
       }
       openModal('game-history-modal');
    }

    // Global Results Server Fetch
    function openGlobalResults(game) {
        document.getElementById('gr-title').innerText = gameInfoMap[game].title + " Feed";
        document.getElementById('gr-items').innerHTML = `<div style="text-align:center; color:var(--text-muted); padding: 20px;">Loading...</div>`;
        socket.emit('getGlobalResults', game);
        openModal('global-results-modal');
    }

    socket.on('globalResultsData', data => {
        const list = document.getElementById('gr-items');
        list.innerHTML = '';
        if(data.results.length === 0) return list.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding: 20px;">No recent outcomes.</div>`;
        
        data.results.forEach(r => {
            let t = new Date(r.time);
            let timeStr = `${(t.getHours()<10?'0':'')+t.getHours()}:${(t.getMinutes()<10?'0':'')+t.getMinutes()}:${(t.getSeconds()<10?'0':'')+t.getSeconds()}`;
            list.innerHTML += `
                <div style="background:rgba(0,0,0,0.5); padding:12px 15px; border-radius:6px; display:grid; grid-template-columns: 1fr 3fr; gap:10px; color:white; font-weight:800;">
                    <span>${timeStr}</span><span style="color:var(--ps-glow);">${r.result}</span>
                </div>`;
        });
    });
    
    function logHistory(gid, bet, payout, msg) {
        if(myGameHistory[gid]) {
            myGameHistory[gid].unshift({ result: msg, payout: payout, bet: bet });
            if(myGameHistory[gid].length > 50) myGameHistory[gid].pop();
        }
    }

    // --- NAVIGATION LOGIC ---
    function switchView(viewId) { 
      if (audioCtx.state === 'suspended') audioCtx.resume(); 
      document.querySelectorAll('.main-wrapper > .content > .view-container').forEach(d => d.classList.add('hidden')); 
      let v = document.getElementById('view-' + viewId); 
      if (v) v.classList.remove('hidden'); 
      if (viewId === 'casino') openLobbyMode('modes'); 
    }

    function openLobbyMode(mode) { 
      ['modes', 'indiv', 'shared'].forEach(m => {
        let el = document.getElementById('lobby-' + m);
        if(el) el.classList.add('hidden');
      }); 
      let target = document.getElementById('lobby-' + mode);
      if(target) target.classList.remove('hidden'); 
      
      // Toggle Big Title
      if(mode === 'modes') document.querySelector('.casino-title').classList.remove('hidden');
      else document.querySelector('.casino-title').classList.add('hidden');
    }
    
    function openGame(id) { 
      switchView('game-' + id); 
      document.querySelectorAll('.result-box').forEach(b => b.style.display = 'none'); 
    }
    
    function backToCasino() { 
      switchView('casino'); 
    }

    function confirmLogout() {
        if(confirm("Are you sure you want to log out of Stick N' Trade?")) {
            location.reload(); // Hard reset back to login
        }
    }

    // --- SOLO GAMES ENGINE ---
    function showEndBox(box, bet, payout, msg) {
        let pft = payout - bet; let h = `<div class="res-title">${msg}</div>`; 
        if (payout > bet) { h += `<div class="res-payout" style="color:var(--success)">+${payout} TC</div>`; box.className = "result-box win"; } 
        else if (payout === bet) { h += `<div class="res-payout" style="color:white">Push</div>`; box.className = "result-box push"; } 
        else { sfx.lose(); h += `<div class="res-payout" style="color:var(--danger)">Lost -${Math.abs(pft)}</div>`; box.className = "result-box lose"; } 
        box.innerHTML = h; box.style.display = 'block'; 
    }

    // Dice
    function playDice() {
      let bet = parseInt(document.getElementById('dice-bet').value);
      if (isNaN(bet) || bet <= 0 || bet > myCredits) return showToast("Invalid bet.", "error");
      
      const btn = document.getElementById('btn-dice'), icn = document.getElementById('dice-icon'), nd = document.getElementById('dice-num'), mb = document.getElementById('dice-msg');
      btn.disabled = true; mb.style.display = 'none'; icn.style.display = 'block'; nd.style.display = 'none'; 
      icn.className = `fas fa-dice-d20 dice-icon anim-shake`;
      
      // Local deduction to prevent spam
      myCredits -= bet; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
      socket.emit('playSolo', { game: 'dice', bet: bet });
    }
    
    socket.on('diceResult', (data) => {
        const btn = document.getElementById('btn-dice'), icn = document.getElementById('dice-icon'), nd = document.getElementById('dice-num'), mb = document.getElementById('dice-msg');
        let t = 0; const indFaces = ['fa-dice-one', 'fa-dice-two', 'fa-dice-three', 'fa-dice-four', 'fa-dice-five', 'fa-dice-six'];
        
        // Wait for animation to finish before updating balance!
        let s = setInterval(() => {
            icn.className = `fas ${indFaces[Math.floor(Math.random() * 6)]} dice-icon anim-shake`; sfx.tick(); t++;
            if (t > 15) {
                clearInterval(s);
                icn.style.display = 'none'; nd.style.display = 'block'; nd.innerText = data.roll;
                nd.style.color = data.payout > 0 ? "var(--success)" : "var(--danger)";
                showEndBox(mb, data.bet, data.payout, `Rolled ${data.roll}`);
                logHistory('dice', data.bet, data.payout, `Rolled ${data.roll}`);
                
                // NOW update balance
                myCredits = data.newBalance; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
                if(data.payout > 0) triggerWinAnim();
                btn.disabled = false;
            }
        }, 80);
    });

    // Coin Flip
    function playCoin(choice) {
      let bet = parseInt(document.getElementById('coin-bet').value);
      if (isNaN(bet) || bet <= 0 || bet > myCredits) return showToast("Invalid bet.", "error");
      
      document.getElementById('btn-heads').disabled = true; document.getElementById('btn-tails').disabled = true; 
      document.getElementById('coin-msg').style.display = 'none'; 
      sfx.coin(); document.getElementById('coin-wrapper').classList.add('tossing');
      
      // Local deduction
      myCredits -= bet; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
      socket.emit('playSolo', { game: 'coinflip', bet: bet, choice: choice });
    }

    socket.on('coinResult', (data) => {
        const cw = document.getElementById('coin-wrapper'), co = document.getElementById('coin-obj'), mb = document.getElementById('coin-msg');
        let er = data.result === 'Tails' ? 180 : 0; 
        co.style.transform = `rotateY(${3600 + er}deg)`; 
        
        // Wait for physical animation to finish
        setTimeout(() => {
            cw.classList.remove('tossing');
            showEndBox(mb, data.bet, data.payout, `Landed on ${data.result}`);
            logHistory('coinflip', data.bet, data.payout, data.result);
            
            // NOW update balance
            myCredits = data.newBalance; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
            if(data.payout > 0) triggerWinAnim();

            document.getElementById('btn-heads').disabled = false; document.getElementById('btn-tails').disabled = false;
            co.style.transform = `rotateY(${er}deg)`; 
        }, 2500);
    });

    // Blackjack
    let bjSt = { bet: 0, active: false };
    function startBlackjack() {
      if (bjSt.active) return; 
      let bet = parseInt(document.getElementById('bj-bet').value);
      if (isNaN(bet) || bet <= 0 || bet > myCredits) return showToast("Invalid bet.", "error");
      
      bjSt.bet = bet; bjSt.active = true; 
      document.getElementById('btn-bj-deal').disabled = true;
      document.getElementById('bj-msg').style.display = 'none'; 
      document.getElementById('bj-start-controls').classList.add('hidden'); 
      document.getElementById('btn-bj-hit').disabled = false; 
      document.getElementById('btn-bj-stand').disabled = false;
      document.getElementById('bj-p-hand').innerHTML = ''; document.getElementById('bj-d-hand').innerHTML = '';
      
      // Local deduction
      myCredits -= bet; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
      socket.emit('playSolo', { game: 'blackjack', action: 'start', bet: bet });
    }
    function hitBlackjack() { if(bjSt.active) { document.getElementById('btn-bj-hit').disabled=true; socket.emit('playSolo', { game:'blackjack', action:'hit' }); } }
    function standBlackjack() { if(bjSt.active) { bjSt.active=false; document.getElementById('btn-bj-hit').disabled=true; document.getElementById('btn-bj-stand').disabled=true; socket.emit('playSolo', { game:'blackjack', action:'stand' }); } }

    socket.on('bjUpdate', async (data) => {
        const drawHand = async (elId, scoreId, cards, hideSecond = false) => {
            let container = document.getElementById(elId); container.innerHTML = '';
            for(let i=0; i<cards.length; i++) {
                let ir = (cards[i].suit === '‚ô•' || cards[i].suit === '‚ô¶'); let sh = ir ? `<span class="card-red">${cards[i].suit}</span>` : cards[i].suit;
                if(hideSecond && i === 1) container.insertAdjacentHTML('beforeend', `<div class="play-card anim-deal card-back" id="hidden-card">?</div>`);
                else container.insertAdjacentHTML('beforeend', `<div class="play-card anim-deal"><div class="val">${cards[i].val}</div><div class="suit">${sh}</div></div>`);
            }
            document.getElementById(scoreId).innerText = data.scores ? data.scores[elId === 'bj-p-hand' ? 'player' : 'dealer'] : cards.reduce((a,b)=>a+b.bjVal,0);
        };

        if(data.event === 'deal') {
            sfx.deal(); await drawHand('bj-p-hand', 'bj-p-score', data.pHand);
            sfx.deal(); await drawHand('bj-d-hand', 'bj-d-score', data.dHand, true);
            document.getElementById('bj-action-controls').classList.remove('hidden');
        } 
        else if (data.event === 'hit') {
            sfx.deal(); await drawHand('bj-p-hand', 'bj-p-score', data.pHand);
            document.getElementById('btn-bj-hit').disabled = false;
        }
        
        if (data.status === 'resolved' || data.event === 'resolved') {
            bjSt.active = false;
            document.getElementById('bj-action-controls').classList.add('hidden');
            document.getElementById('bj-start-controls').classList.remove('hidden');
            document.getElementById('btn-bj-deal').disabled = false;
            
            sfx.deal(); await drawHand('bj-d-hand', 'bj-d-score', data.dHand, false); 
            
            showEndBox(document.getElementById('bj-msg'), bjSt.bet, data.payout, data.msg);
            logHistory('blackjack', bjSt.bet, data.payout, data.msg);

            // NOW update balance
            myCredits = data.newBalance; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
            if(data.payout > 0) triggerWinAnim();
        }
    });

    // --- SHARED LIVE TABLES ENGINE (SOCKET DRIVEN) ---
    function sendChat() {
        const input = document.getElementById('chat-input');
        if(input.value.trim() === '') return;
        socket.emit('sendChat', { room: activeSharedGame, msg: input.value });
        input.value = '';
    }
    socket.on('chatMessage', (data) => {
        let cb = document.getElementById('sg-chat'); if (!cb) return; 
        if (data.sys) cb.insertAdjacentHTML('beforeend', `<div class="chat-msg chat-sys">${data.text}</div>`);
        else cb.insertAdjacentHTML('beforeend', `<div class="chat-msg"><div class="chat-user">${data.user}</div><div>${data.text}</div></div>`);
        cb.scrollTop = cb.scrollHeight;
    });

    socket.on('playerCount', (counts) => {
        document.querySelectorAll('.active-players .ap-count').forEach((el, index) => {
            const keys = ['baccarat', 'perya', 'dt', 'sicbo'];
            if(counts[keys[index]]!==undefined) el.innerText = counts[keys[index]];
        });
        const sgCount = document.getElementById('sg-active-players');
        if(sgCount && activeSharedGame) sgCount.innerText = counts[activeSharedGame] || 0;
    });

    const sConf = {
      'perya': {
        title: 'Color Game', 
        setupUI: function() { 
          let d = document.getElementById('sg-display'); if (!d) return; 
          d.innerHTML = `<div class="color-dice-container" id="cg-dice"><div class="color-die c-grey" id="cd1">?</div><div class="color-die c-grey" id="cd2">?</div><div class="color-die c-grey" id="cd3">?</div></div><div class="result-overlay-shared" id="sg-overlay"><div class="res-title" id="sg-res-title"></div><div class="res-payout" id="sg-res-payout" style="display:none"></div></div>`; 
          let cg = document.getElementById('sg-controls-container'); 
          if (cg) cg.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;grid-column:span 2">
              <div class="input-group" style="margin:0;text-align:left;width:150px;"><label style="text-align:center">Bet Amount</label><input type="number" id="sg-bet-input" class="input-control bet-input" placeholder="10"></div>
              <div style="text-align:right;"><div style="color:var(--text-muted);font-size:0.85rem;font-weight:600;text-transform:uppercase;margin-bottom:5px;">Total Bet</div><div id="sg-my-bet" style="color:white;font-size:1.5rem;font-weight:800;">0 TC</div></div>
            </div>
            <div class="bet-grid perya-grid controls-full" id="sg-bet-grid" style="width:100%"></div>`; 
          let bg = document.getElementById('sg-bet-grid'); 
          if (bg) { 
            const choices = [ {id: 'Yellow', c: '#ffcc00'}, {id: 'White', c: '#ffffff'}, {id: 'Pink', c: '#ff66b2'}, {id: 'Blue', c: '#00a2ff'}, {id: 'Red', c: '#ff3366'}, {id: 'Green', c: '#00e676'} ];
            choices.forEach(c => { 
              bg.innerHTML += `<button class="bet-btn perya-tile" data-choice="${c.id}" style="--tile-color:${c.c}; border-bottom:5px solid ${c.c}" onclick="placeSharedBet('${c.id}')">${c.id}</button>`; 
            }); 
          } 
        },
        animateResult: function(data) {
            let d1 = document.getElementById('cd1'), d2 = document.getElementById('cd2'), d3 = document.getElementById('cd3'); 
            d1.className = 'color-die anim-shake c-grey'; d2.className = 'color-die anim-shake c-grey'; d3.className = 'color-die anim-shake c-grey'; 
            d1.innerText = ''; d2.innerText = ''; d3.innerText = ''; sfx.tick();
            
            // Wait for visual shaking to finish
            setTimeout(() => {
                d1.className = `color-die c-${data.roll[0].toLowerCase()}`; 
                d2.className = `color-die c-${data.roll[1].toLowerCase()}`; 
                d3.className = `color-die c-${data.roll[2].toLowerCase()}`; 
                
                let totBet = 0; let totWon = 0;
                for(let b in mySBets) { totBet += mySBets[b]; let m = data.roll.filter(x => x === b).length; if(m > 0) totWon += mySBets[b] + (mySBets[b] * m); }
                processSharedPayout('perya', totWon, totBet, data.roll.join(', '));
            }, 2000);
        }
      },
      'baccarat': {
        title: 'Baccarat',
        setupUI: function() {
          let d = document.getElementById('sg-display'); if (!d) return; 
          d.innerHTML = `
            <div class="dt-arena" style="gap:40px;">
                <div class="dt-side">
                    <div class="dt-label" style="color:var(--ps-glow)">Player</div>
                    <div id="bac-p-score" style="font-size:2rem; font-weight:900; color:white; line-height:1; margin-bottom:5px;">0</div>
                    <div id="bac-p-hand" style="display:flex; gap:5px; justify-content:center; min-height:100px; width:210px;"></div>
                </div>
                <div style="font-size:2.5rem;color:white;font-weight:300;">VS</div>
                <div class="dt-side">
                    <div class="dt-label" style="color:var(--danger)">Banker</div>
                    <div id="bac-b-score" style="font-size:2rem; font-weight:900; color:white; line-height:1; margin-bottom:5px;">0</div>
                    <div id="bac-b-hand" style="display:flex; gap:5px; justify-content:center; min-height:100px; width:210px;"></div>
                </div>
            </div>
            <div class="result-overlay-shared" id="sg-overlay"><div class="res-title" id="sg-res-title"></div><div class="res-payout" id="sg-res-payout" style="display:none"></div></div>`; 
          
          let cg = document.getElementById('sg-controls-container'); 
          if (cg) cg.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;grid-column:span 2"><div class="input-group" style="margin:0;text-align:left;width:150px;"><label style="text-align:center">Bet Amount</label><input type="number" id="sg-bet-input" class="input-control bet-input" placeholder="10"></div><div style="text-align:right;"><div style="color:var(--text-muted);font-size:0.85rem;font-weight:600;text-transform:uppercase;margin-bottom:5px;">Total Bet</div><div id="sg-my-bet" style="color:white;font-size:1.5rem;font-weight:800;">0 TC</div></div></div><div class="bet-grid controls-full" id="sg-bet-grid" style="width:100%"></div>`; 
          let bg = document.getElementById('sg-bet-grid'); 
          if (bg) bg.innerHTML = `
            <button class="bet-btn shared-tile" data-choice="Player" style="--tile-color:var(--ps-glow); border-bottom:5px solid var(--ps-glow);" onclick="placeSharedBet('Player')">PLAYER (2x)</button>
            <button class="bet-btn shared-tile" data-choice="Tie" style="--tile-color:var(--success); border-bottom:5px solid var(--success);" onclick="placeSharedBet('Tie')">TIE (8x)</button>
            <button class="bet-btn shared-tile" data-choice="Banker" style="--tile-color:var(--danger); border-bottom:5px solid var(--danger);" onclick="placeSharedBet('Banker')">BANKER (1.95x)</button>`;
        },
        animateResult: async function(data) {
            let pHand = document.getElementById('bac-p-hand'), bHand = document.getElementById('bac-b-hand');
            let pScoreEl = document.getElementById('bac-p-score'), bScoreEl = document.getElementById('bac-b-score');
            
            pHand.innerHTML = ''; bHand.innerHTML = '';
            
            const formatCard = (c) => { let ir = (c.suit === '‚ô•' || c.suit === '‚ô¶'); let sh = ir ? `<span class="card-red">${c.suit}</span>` : c.suit; return `<div class="play-card anim-deal"><div class="val">${c.val}</div><div class="suit">${sh}</div></div>`; };
            const getScore = (arr) => arr.reduce((sum, c) => sum + c.bacVal, 0) % 10;

            let pC = [], bC = [];
            pC.push(data.pCards[0]); pHand.insertAdjacentHTML('beforeend', formatCard(pC[0])); pScoreEl.innerText = getScore(pC); sfx.deal(); await delay(500);
            bC.push(data.bCards[0]); bHand.insertAdjacentHTML('beforeend', formatCard(bC[0])); bScoreEl.innerText = getScore(bC); sfx.deal(); await delay(500);
            pC.push(data.pCards[1]); pHand.insertAdjacentHTML('beforeend', formatCard(pC[1])); pScoreEl.innerText = getScore(pC); sfx.deal(); await delay(500);
            bC.push(data.bCards[1]); bHand.insertAdjacentHTML('beforeend', formatCard(bC[1])); bScoreEl.innerText = getScore(bC); sfx.deal(); await delay(500);

            if(data.pCards[2]) { pC.push(data.pCards[2]); pHand.insertAdjacentHTML('beforeend', formatCard(pC[2])); pScoreEl.innerText = getScore(pC); sfx.deal(); await delay(600); }
            if(data.bCards[2]) { bC.push(data.bCards[2]); bHand.insertAdjacentHTML('beforeend', formatCard(bC[2])); bScoreEl.innerText = getScore(bC); sfx.deal(); await delay(600); }

            let totBet = 0; let totWon = 0;
            for(let b in mySBets) { totBet += mySBets[b]; if(b === data.winner) totWon += mySBets[b] * (b === 'Tie' ? 8 : (b === 'Banker' ? 1.95 : 2)); }
            processSharedPayout('baccarat', totWon, totBet, `${data.winner} Wins!`); 
        }
      },
      'dt': {
        title: 'Dragon Tiger',
        setupUI: function() { 
          let d = document.getElementById('sg-display'); if (!d) return; 
          d.innerHTML = `<div class="dt-arena"><div class="dt-side"><div class="dt-label lbl-dragon">Dragon</div><div id="dt-c1" class="card-back dt-card play-card">?</div></div><div style="font-size:2.5rem;color:white;font-weight:300;">VS</div><div class="dt-side"><div class="dt-label lbl-tiger">Tiger</div><div id="dt-c2" class="card-back dt-card play-card">?</div></div></div><div class="result-overlay-shared" id="sg-overlay"><div class="res-title" id="sg-res-title"></div><div class="res-payout" id="sg-res-payout" style="display:none"></div></div>`; 
          let cg = document.getElementById('sg-controls-container'); 
          if (cg) cg.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;grid-column:span 2">
              <div class="input-group" style="margin:0;text-align:left;width:150px;"><label style="text-align:center">Bet Amount</label><input type="number" id="sg-bet-input" class="input-control bet-input" placeholder="10"></div>
              <div style="text-align:right;"><div style="color:var(--text-muted);font-size:0.85rem;font-weight:600;text-transform:uppercase;margin-bottom:5px;">Total Bet</div><div id="sg-my-bet" style="color:white;font-size:1.5rem;font-weight:800;">0 TC</div></div>
            </div>
            <div class="bet-grid controls-full" id="sg-bet-grid" style="width:100%"></div>`; 
          let bg = document.getElementById('sg-bet-grid'); 
          if (bg) bg.innerHTML = `
            <button class="bet-btn shared-tile" data-choice="Dragon" style="--tile-color:var(--danger); border-bottom:5px solid var(--danger);" onclick="placeSharedBet('Dragon')">DRAGON (2x)</button>
            <button class="bet-btn shared-tile" data-choice="Tie" style="--tile-color:var(--success); border-bottom:5px solid var(--success);" onclick="placeSharedBet('Tie')">TIE (8x)</button>
            <button class="bet-btn shared-tile" data-choice="Tiger" style="--tile-color:var(--credits); border-bottom:5px solid var(--credits);" onclick="placeSharedBet('Tiger')">TIGER (2x)</button>`; 
        },
        animateResult: function(data) { 
          const formatCard = (c) => { let ir = (c.suit === '‚ô•' || c.suit === '‚ô¶'); let sh = ir ? `<span class="card-red">${c.suit}</span>` : c.suit; return `<div class="play-card anim-deal dt-card" id="dt-c1"><div class="val">${c.val}</div><div class="suit">${sh}</div></div>`; };
          let e1 = document.getElementById('dt-c1'); 
          if (e1) { e1.outerHTML = formatCard(data.dCard); sfx.deal(); } 
          setTimeout(() => { 
            let e2 = document.getElementById('dt-c2'); 
            if (e2) { let c2Html = formatCard(data.tCard); c2Html = c2Html.replace('id="dt-c1"', 'id="dt-c2"'); e2.outerHTML = c2Html; sfx.deal(); } 
            
            setTimeout(() => { 
              let totBet = 0; let totWon = 0;
              for(let b in mySBets) { totBet += mySBets[b]; if(b === data.winner) totWon += mySBets[b] * (b === 'Tie' ? 8 : 2); }
              processSharedPayout('dt', totWon, totBet, `${data.winner} Wins!`); 
            }, 1000); 
          }, 500); 
        }
      },
      'sicbo': {
        title: 'Sic Bo',
        setupUI: function() { 
          let d = document.getElementById('sg-display'); if (!d) return; 
          d.innerHTML = `<div class="sicbo-dice" id="sb-dice"><i class="fas fa-dice-d6 s-die"></i><i class="fas fa-dice-d6 s-die"></i><i class="fas fa-dice-d6 s-die"></i></div><div id="sb-sum" style="font-size:2rem;color:var(--text-muted); margin-top:30px; font-weight:900; letter-spacing:2px;">Waiting for roll...</div><div class="result-overlay-shared" id="sg-overlay"><div class="res-title" id="sg-res-title"></div><div class="res-payout" id="sg-res-payout" style="display:none"></div></div>`; 
          let cg = document.getElementById('sg-controls-container'); 
          if (cg) cg.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;grid-column:span 2">
              <div class="input-group" style="margin:0;text-align:left;width:150px;"><label style="text-align:center">Bet Amount</label><input type="number" id="sg-bet-input" class="input-control bet-input" placeholder="10"></div>
              <div style="text-align:right;"><div style="color:var(--text-muted);font-size:0.85rem;font-weight:600;text-transform:uppercase;margin-bottom:5px;">Total Bet</div><div id="sg-my-bet" style="color:white;font-size:1.5rem;font-weight:800;">0 TC</div></div>
            </div>
            <div class="bet-grid controls-full" id="sg-bet-grid" style="width:100%"></div>`; 
          let bg = document.getElementById('sg-bet-grid'); 
          if (bg) bg.innerHTML = `
            <button class="bet-btn shared-tile" data-choice="Small" style="--tile-color:var(--ps-glow); border-bottom:5px solid var(--ps-glow);" onclick="placeSharedBet('Small')">SMALL (4-10)</button>
            <div style="display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-weight:800;font-size:1rem;text-align:center;">TRIPLE LOSES</div>
            <button class="bet-btn shared-tile" data-choice="Big" style="--tile-color:var(--danger); border-bottom:5px solid var(--danger);" onclick="placeSharedBet('Big')">BIG (11-17)</button>`; 
        },
        animateResult: function(data) { 
          const dc = document.getElementById('sb-dice'); 
          if (dc) { dc.innerHTML = `<i class="fas fa-dice-d6 s-die anim-shake"></i><i class="fas fa-dice-d6 s-die anim-shake"></i><i class="fas fa-dice-d6 s-die anim-shake"></i>`; sfx.tick(); } 
          setTimeout(() => { 
            const f = ['fa-dice-one','fa-dice-two','fa-dice-three','fa-dice-four','fa-dice-five','fa-dice-six']; 
            if (dc) { 
              dc.innerHTML = `<i class="fas ${f[data.roll[0]-1]} s-die"></i><i class="fas ${f[data.roll[1]-1]} s-die"></i><i class="fas ${f[data.roll[2]-1]} s-die"></i>`; 
              sfx.deal(); 
              document.getElementById('sb-sum').innerText = `Sum: ${data.sum} ${data.winner==='None' ? '(Triple!)' : ''}`; 
            } 
            let totBet = 0; let totWon = 0;
            for(let b in mySBets) { totBet += mySBets[b]; if(b === data.winner) totWon += mySBets[b] * 2; }
            processSharedPayout('sicbo', totWon, totBet, data.winner === 'None' ? `Triple! House Wins` : `${data.winner} (${data.sum})`); 
          }, 2000); 
        }
      }
    };
    
    function openSharedGame(id) { 
      activeSharedGame = id; 
      document.getElementById('sg-title').innerText = sConf[id].title; 
      let o = document.getElementById('sg-overlay'); if (o) o.classList.remove('show'); 
      mySBets = {}; let mb = document.getElementById('sg-my-bet'); if (mb) { mb.innerText = '0 TC'; mb.style.color = 'white'; } 
      let cb = document.getElementById('sg-chat'); if (cb) cb.innerHTML = '<div class="chat-msg chat-sys">Connected to Live Table.</div>'; 
      sConf[id].setupUI(); 
      document.querySelectorAll('.main-wrapper > .content > .view-container').forEach(d => d.classList.add('hidden')); 
      document.getElementById('view-shared-game').classList.remove('hidden'); 
      socket.emit('joinRoom', id);
    }
    
    function backToSharedLobby() { 
      let tu = Object.values(mySBets).reduce((a, b) => a + b, 0); 
      if (tu > 0 && sState.status === 'BETTING') { 
         // Visual refund (server protects real balance)
        showToast(`Your unplayed bets of ${tu} TC were refunded.`, 'success'); 
        myCredits += tu; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
      } 
      document.getElementById('view-shared-game').classList.add('hidden'); 
      socket.emit('leaveRoom', activeSharedGame);
      activeSharedGame = null; 
      switchView('casino'); 
      openLobbyMode('shared'); 
    }

    function placeSharedBet(c) { 
      if (sState.status !== 'BETTING') return showToast("Bets are closed! Wait for next round.", "error"); 
      let i = document.getElementById('sg-bet-input'); if (!i) return; 
      let a = parseInt(i.value); 
      if (isNaN(a) || a <= 0) return showToast("Invalid bet.", "error"); 
      if (a > myCredits) return showToast("Insufficient TC.", "error"); 
      
      socket.emit('placeSharedBet', { room: activeSharedGame, choice: c, amount: a });
      
      // Visual Deduction
      myCredits -= a; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
      if (!mySBets[c]) mySBets[c] = 0; mySBets[c] += a; 
      
      let tot = Object.values(mySBets).reduce((sum, val) => sum + val, 0);
      let mb = document.getElementById('sg-my-bet'); if (mb) mb.innerHTML = `${tot.toLocaleString()} TC`; 
      
      document.querySelectorAll('#sg-bet-grid .bet-btn').forEach(b => { 
        if (b.getAttribute('data-choice') === c) { b.classList.add('has-bet'); } 
      }); 
      sfx.tick(); 
    }

    socket.on('timerUpdate', (t) => { 
      sState.time = t; 
      let r = document.getElementById('sg-timer-box'), s = document.getElementById('sg-timer');
      if (s) s.innerText = t; 
      if (t <= 5 && r && sState.status === 'BETTING') r.classList.add('closing'); 
      else if(r) r.classList.remove('closing');
    });

    socket.on('lockBets', () => { 
        sState.status = 'RESOLVING'; 
        let r = document.getElementById('sg-timer-box'); 
        if (r) { r.classList.remove('closing'); r.style.color = 'var(--danger)'; r.style.borderColor = 'var(--danger)'; } 
        addChat('Dealer', 'No more bets!', true); 
        sfx.lock(); 
    });

    socket.on('sharedResults', (data) => {
        if(activeSharedGame === data.room && sConf[data.room]) {
            sConf[data.room].animateResult(data);
        }
    });

    socket.on('newRound', () => { 
        sState.status = 'BETTING'; 
        let r = document.getElementById('sg-timer-box'); 
        if (r) { r.style.color = 'white'; r.style.borderColor = 'var(--glass-border)'; } 
        addChat('Dealer', 'Place your bets!', true); 
        let o = document.getElementById('sg-overlay'); if (o) { o.classList.remove('show'); o.className = "result-box"; } 
        if (activeSharedGame) sConf[activeSharedGame].setupUI(); 
        mySBets = {}; 
        let m = document.getElementById('sg-my-bet'); if (m) m.innerHTML = '0 TC'; 
    });

    function processSharedPayout(gid, totWon, totBet, msg) { 
      const o = document.getElementById('sg-overlay'), t = document.getElementById('sg-res-title'), b = document.getElementById('sg-res-payout'); 
      if (t) t.innerHTML = msg; 
      
      if (totBet > 0 && b) { 
          b.style.display = 'block'; 
          let profit = totWon - totBet;
          if(profit > 0) { b.innerHTML = `<span style="color:var(--success)">WON +${profit}</span>`; o.className = "result-box win show"; }
          else if(profit === 0 && totWon > 0) { b.innerHTML = `<span style="color:white">PUSH</span>`; o.className = "result-box push show"; }
          else { sfx.lose(); b.innerHTML = `<span style="color:var(--danger)">LOST -${totBet}</span>`; o.className = "result-box lose show"; }
          logHistory(gid, totBet, totWon, msg); 
      } else {
          if (b) b.style.display = 'none'; 
          o.className = "result-box push show";
      }
      if (o) o.classList.add('show'); 
    }

    // --- CASHIER & PROMO MODAL HANDLERS ---
    function openCashier() {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      sfx.click();
      switchSupportCenterTab('deposit', document.querySelectorAll('.bank-tab')[0]);
      openModal('support-center-modal');
    }

    function switchSupportCenterTab(tab, el) {
      document.querySelectorAll('.bank-tabs > .bank-tab').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
      ['deposit','withdraw','requests'].forEach(t => {
        document.getElementById('sc-tab-' + t).classList.toggle('active', t === tab);
        document.getElementById('sc-tab-' + t).classList.toggle('hidden', t !== tab);
      });
      if(tab === 'requests') socket.emit('getTransactions');
    }

    function submitDeposit() {
        const amt = document.getElementById('dep-amount').value;
        const ref = document.getElementById('dep-ref').value;
        if(!amt || !ref) return showToast("Please fill all fields.", "error");
        socket.emit('submitTransaction', { type: 'Deposit', amount: parseInt(amt), ref: ref });
        showToast("Deposit request sent.");
        document.getElementById('dep-amount').value = ''; document.getElementById('dep-ref').value = '';
    }

    function submitWithdrawal() {
        const amt = parseInt(document.getElementById('wit-amount').value);
        const info = document.getElementById('wit-info').value;
        if(!amt || !info) return showToast("Please fill all fields.", "error");
        if(amt > myCredits) return showToast("Insufficient TC.", "error");
        
        // Visual deduction
        myCredits -= amt; document.getElementById('nav-credits').innerText = myCredits.toLocaleString();
        socket.emit('submitTransaction', { type: 'Withdrawal', amount: amt, ref: info });
        showToast("Withdrawal request sent.");
        document.getElementById('wit-amount').value = ''; document.getElementById('wit-info').value = '';
    }

    socket.on('transactionsData', (txs) => {
        const container = document.getElementById('bank-logs-container'); container.innerHTML = '';
        if(txs.length === 0) return container.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">No requests found.</div>';
        txs.forEach(t => {
            let statClass = t.status === 'Approved' ? 'approved' : (t.status === 'Rejected' ? 'rejected' : 'pending');
            let color = t.type === 'Deposit' ? 'var(--success)' : 'var(--danger)'; let sign = t.type === 'Deposit' ? '+' : '-';
            container.innerHTML += `<div class="ticket-log-item"><div class="ticket-log-header"><span class="ticket-log-id">${t._id.substring(0,8)}... - ${new Date(t.date).toLocaleDateString()}</span><span class="ticket-log-status ${statClass}">${t.status}</span></div><div style="display:flex; justify-content:space-between; align-items:center;"><div style="font-weight:900; font-size:1.1rem; text-transform:uppercase;">${t.type}</div><div style="color:${color}; font-weight:900; font-size:1.2rem;">${sign}${t.amount} TC</div></div></div>`;
        });
    });

    function submitPromo() {
        const code = document.getElementById('promo-code').value.trim().toUpperCase();
        if(!code) return document.getElementById('promo-response').innerHTML = `<span style="color:var(--danger)">Enter a code.</span>`;
        socket.emit('redeemPromo', code);
    }

    socket.on('promoResult', (res) => {
        const div = document.getElementById('promo-response');
        if(res.success) { div.innerHTML = `<span style="color:var(--success)">Valid</span><br><span style="color:var(--ps-glow)">+${res.amt} TC</span>`; document.getElementById('promo-code').value = ''; } 
        else { div.innerHTML = `<span style="color:var(--danger)">${res.msg}</span>`; }
    });

    // --- ANTI-SNOOPING SECURITY ---
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode === 123) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode === 'I'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode === 'C'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode === 'J'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.keyCode === 'U'.charCodeAt(0)) return false; 
    };

  </script>
</body>
</html>
