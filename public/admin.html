<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel | Stick N' Trade Casino</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&family=Rajdhani:wght@600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="/socket.io/socket.io.js"></script>
<style>
:root { --ps-bg: #000814; --ps-glow: #00a2ff; --glass-bg: rgba(0, 15, 35, 0.65); --glass-border: rgba(255, 255, 255, 0.15); --glass-hover: rgba(255, 255, 255, 0.9); --danger: #ff3366; --success: #00e676; --credits: #ffb400; --text-main: #f8fafc; --text-muted: #8c9eb5; }
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; outline: none; }
body { background: linear-gradient(135deg, #000510 0%, #001233 100%); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: var(--ps-glow); }
input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
input[type="number"] { -moz-appearance: textfield; }
#auth-container { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 9999999; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); }
.auth-box { width: 420px; background: var(--glass-bg); padding: 3rem; border-radius: 16px; border: 1px solid var(--glass-border); box-shadow: 0 25px 80px rgba(0,0,0,0.9); text-align: center; }
.auth-title { font-size: 2.2rem; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
.auth-sub { color: var(--danger); font-weight: 800; font-size: 0.9rem; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 30px; }
.auth-error-msg { color: var(--danger); font-size: 0.9rem; font-weight: 800; min-height: 20px; margin-bottom: 15px; text-align: center; }
.pwd-input-wrapper { position: relative; width: 100%; display: flex; align-items: center;}
.pwd-input-wrapper input { width: 100%; padding-right: 40px; text-align: center; }
.pwd-input-wrapper i { position: absolute; right: 15px; cursor: pointer; color: var(--text-muted); font-size: 1.1rem; transition: 0.2s;}
.pwd-input-wrapper i:hover { color: white; }
#app-container { display: none; width: 100%; height: 100%; }
.sidebar { width: 280px; background: rgba(0, 5, 20, 0.85); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; z-index: 100; backdrop-filter: blur(20px); }
.sidebar-header { padding: 25px 20px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; gap: 15px; }
.brand-dot { width: 14px; height: 14px; border-radius: 50%; background: var(--danger); box-shadow: 0 0 15px var(--danger); }
.brand-title { font-weight: 900; letter-spacing: 1px; text-transform: uppercase; font-size: 1.2rem; line-height: 1.1; }
.brand-sub { color: var(--danger); font-weight: 800; font-size: 0.8rem; letter-spacing: 3px; text-transform: uppercase; }
.nav-menu { padding: 20px 15px; display: flex; flex-direction: column; gap: 5px; flex: 1; }
.nav-item { display: flex; align-items: center; gap: 15px; padding: 12px 20px; color: var(--text-muted); text-decoration: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
.nav-item i { font-size: 1.2rem; width: 20px; text-align: center; }
.nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
.nav-item.active { background: rgba(0, 162, 255, 0.15); color: white; border-color: var(--ps-glow); box-shadow: 0 0 15px rgba(0, 162, 255, 0.2); }
.admin-profile { padding: 20px; border-top: 1px solid var(--glass-border); display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.3); }
.admin-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--ps-glow); display: flex; align-items: center; justify-content: center; font-weight: 900; color: #000; }
.admin-info div:first-child { font-weight: 800; font-size: 0.95rem; }
.admin-info div:last-child { color: var(--success); font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
.main-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
.top-header { height: 70px; background: rgba(0,0,0,0.4); border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
.page-title { font-size: 1.5rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; margin: 0; }
.top-actions { display: flex; gap: 15px; align-items: center; }
.btn-primary { background: var(--ps-glow); color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 900; cursor: pointer; transition: 0.2s; text-transform: uppercase; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; justify-content: center;}
.btn-primary:hover { background: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.5); transform: translateY(-2px); }
.btn-primary:active { transform: scale(0.98); }
.content-wrapper { padding: 30px; overflow-y: auto; flex: 1; }
.view-section { display: none; animation: fadeIn 0.3s ease; }
.view-section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
.stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--border-color, var(--ps-glow)); }
.stat-title { color: var(--text-muted); font-size: 0.9rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
.stat-value { font-size: 2.5rem; font-weight: 900; font-family: 'Rajdhani', sans-serif; line-height: 1; color: white; }
.stat-icon { position: absolute; right: 20px; top: 25px; font-size: 3rem; opacity: 0.1; }
.table-container { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 25px;}
.table-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); }
.search-bar { background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); padding: 8px 15px; border-radius: 6px; color: white; width: 250px; outline: none; transition: 0.2s; text-align: center; }
.search-bar:focus { border-color: var(--ps-glow); }
table { width: 100%; border-collapse: collapse; text-align: center; }
th { padding: 15px 10px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); border-bottom: 2px solid var(--glass-border); background: rgba(0,0,0,0.4); text-align: center; }
td { padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: 600; font-size: 0.95rem; text-align: center; vertical-align: middle; }
tr:hover td { background: rgba(255,255,255,0.02); }
.badge { padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 900; text-transform: uppercase; display: inline-block;}
.badge-pending { background: rgba(255,180,0,0.15); color: var(--credits); border: 1px solid rgba(255,180,0,0.3); }
.badge-approved { background: rgba(0,230,118,0.15); color: var(--success); border: 1px solid rgba(0,230,118,0.3); }
.badge-rejected { background: rgba(255,51,102,0.15); color: var(--danger); border: 1px solid rgba(255,51,102,0.3); }
.badge-active { background: rgba(0,162,255,0.15); color: var(--ps-glow); border: 1px solid rgba(0,162,255,0.3); }
.badge-offline { background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid rgba(255,255,255,0.2); }
.role-admin { background: rgba(255,180,0,0.2); color: var(--credits); border: 1px solid var(--credits); }
.role-mod { background: rgba(0,162,255,0.2); color: var(--ps-glow); border: 1px solid var(--ps-glow); }
.role-player { background: rgba(255,255,255,0.1); color: var(--text-muted); border: 1px solid var(--glass-border); }
.action-btns { display: flex; gap: 8px; justify-content: center; align-items: center; }
.btn-icon { width: 32px; height: 32px; border-radius: 6px; border: 1px solid transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; color: white; outline: none; }
.btn-edit { background: rgba(0,162,255,0.2); color: var(--ps-glow); }
.btn-edit:hover { background: var(--ps-glow); color: #000; transform: scale(1.1); }
.btn-approve { background: rgba(0,230,118,0.2); color: var(--success); }
.btn-approve:hover { background: var(--success); color: #000; transform: scale(1.1); }
.btn-reject { background: rgba(255,51,102,0.2); color: var(--danger); }
.btn-reject:hover { background: var(--danger); color: #000; transform: scale(1.1); }
.copy-icon { cursor: pointer; color: var(--text-muted); margin-left: 8px; transition: 0.2s; }
.copy-icon:hover { color: var(--ps-glow); transform: scale(1.2); }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
.modal-content { background: var(--glass-bg); width: 450px; padding: 2.5rem; border-radius: 12px; border: 1px solid var(--glass-border); box-shadow: 0 25px 80px rgba(0,0,0,0.9); position: relative; max-height: 90vh; display: flex; flex-direction: column;}
.modal-close { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
.modal-close:hover { color: var(--danger); transform: scale(1.1);}
.modal-title { font-size: 1.5rem; font-weight: 900; margin-top: 0; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; text-align: center; flex-shrink: 0;}
.input-group { margin-bottom: 15px; }
.input-group label { display: block; color: var(--text-muted); margin-bottom: 8px; font-size: 0.85rem; font-weight: 800; text-transform: uppercase; text-align: center; }
.input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); color: white; border-radius: 6px; font-size: 1rem; font-weight: 600; outline: none; text-align: center; font-family: 'Outfit', sans-serif;}
.input-group input:focus, .input-group textarea:focus, .input-group select:focus { border-color: var(--ps-glow); }
.input-group textarea { resize: vertical; min-height: 100px; text-align: left; }
.input-group select option { background: #000814; color: white; }
#toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.toast { background: rgba(5, 10, 25, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(0, 162, 255, 0.4); color: white; padding: 15px 25px; border-radius: 8px; display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1rem; transform: translateX(120%); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0, 162, 255, 0.25); text-transform: uppercase;}
.toast.show { transform: translateX(0); }
.toast-success { border-left: 5px solid var(--success); border-color: var(--success); box-shadow: 0 10px 30px rgba(0, 230, 118, 0.25); }
.toast-success i { color: var(--success); font-size: 1.3rem;}
.toast-error { border-left: 5px solid var(--danger); border-color: var(--danger); box-shadow: 0 10px 30px rgba(255, 51, 102, 0.25); }
.toast-error i { color: var(--danger); font-size: 1.3rem;}
.code-item { background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); padding: 12px 15px; margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-weight: 800; color: white; }
.code-val { font-family: monospace; font-size: 1.1rem; letter-spacing: 1px; color: var(--ps-glow);}
.code-action { display: flex; align-items: center; gap: 10px; }
.update-item { background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); border-left: 4px solid var(--ps-glow); padding: 20px; border-radius: 8px; margin-bottom: 15px; }
.update-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
.update-title { font-weight: 900; font-size: 1.2rem; text-transform: uppercase; color: white; }
.update-date { color: var(--text-muted); font-size: 0.85rem; font-weight: 800; }
.update-msg { color: #d1d5db; line-height: 1.5; font-size: 0.95rem; }
.pwd-cell { display: flex; align-items: center; justify-content: center; gap: 8px; }
</style>
</head>
<body>

  <div id="toast-container"></div>

  <div id="auth-container">
      <div class="auth-box">
          <div class="auth-title">ADMIN ACCESS</div>
          <div class="auth-sub">Stick N' Trade</div>
          <div id="auth-form-login">
              <div class="input-group" style="margin-bottom:20px;">
                  <input type="text" id="admin-user" class="input-control" placeholder="Username" style="text-align: center;" onkeypress="if(event.key==='Enter') submitAdminAuth()">
              </div>
              <div class="input-group" style="margin-bottom:20px;">
                  <div class="pwd-input-wrapper">
                      <input type="password" id="admin-pass" class="input-control" placeholder="Password" style="text-align: center;" onkeypress="if(event.key==='Enter') submitAdminAuth()">
                      <i class="fas fa-eye" onclick="toggleInputPwd('admin-pass', this)" title="Toggle Visibility"></i>
                  </div>
              </div>
              <div id="auth-error-login" class="auth-error-msg"></div>
              <button class="btn-primary" style="width:100%; padding: 15px; font-size: 1.1rem;" onclick="submitAdminAuth()">SECURE LOGIN</button>
          </div>
      </div>
  </div>

  <div id="app-container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="brand-dot"></div>
          <div><div class="brand-title">Admin Panel</div><div class="brand-sub">Stick N' Trade</div></div>
        </div>
        <div class="nav-menu">
          <a class="nav-item active" onclick="switchView('dashboard', this)"><i class="fas fa-chart-pie"></i> Dashboard</a>
          <a class="nav-item" onclick="switchView('users', this)"><i class="fas fa-users"></i> Users</a>
          <a class="nav-item" onclick="switchView('transactions', this)"><i class="fas fa-exchange-alt"></i> Cashier</a>
          <a class="nav-item" onclick="switchView('giftcodes', this)"><i class="fas fa-gift"></i> Gift Codes</a>
          <a class="nav-item" onclick="switchView('updates', this)"><i class="fas fa-bullhorn"></i> System Updates</a>
          <a class="nav-item" style="margin-top: auto; border-top: 1px solid var(--glass-border); border-radius: 0;" href="/"><i class="fas fa-gamepad"></i> Back to Casino</a>
        </div>
        <div class="admin-profile">
          <div class="admin-avatar">AD</div>
          <div class="admin-info"><div id="admin-name-display">Admin</div><div><i class="fas fa-circle" style="font-size:0.5rem; margin-right:4px;"></i> System Online</div></div>
        </div>
      </aside>

      <main class="main-area">
        <header class="top-header">
          <h1 class="page-title" id="topbar-title">Dashboard</h1>
          <div class="top-actions">
            <button class="btn-primary" onclick="socket.emit('forceSync')"><i class="fas fa-sync-alt"></i> Sync Data</button>
            <button class="btn-primary" style="background: rgba(255,51,102,0.2); color: var(--danger);" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i> Logout</button>
          </div>
        </header>

        <div class="content-wrapper custom-scroll">
          
          <section id="view-dashboard" class="view-section active">
            <div class="stats-grid">
              <div class="stat-card" style="--border-color: var(--credits);">
                <i class="fas fa-coins stat-icon"></i><div class="stat-title">Total Economy (TC)</div><div class="stat-value" id="stat-economy">0</div>
              </div>
              <div class="stat-card" style="--border-color: var(--ps-glow);">
                <i class="fas fa-users stat-icon"></i><div class="stat-title">Registered Players</div><div class="stat-value" id="stat-players">0</div>
              </div>
              <div class="stat-card" style="--border-color: var(--danger);">
                <i class="fas fa-hourglass-half stat-icon"></i><div class="stat-title">Pending Requests</div><div class="stat-value" id="stat-pending">0</div>
              </div>
              <div class="stat-card" style="--border-color: var(--success);">
                <i class="fas fa-gift stat-icon"></i><div class="stat-title">Active Gift Batches</div><div class="stat-value" id="stat-promos">0</div>
              </div>
            </div>
            <div class="table-container">
              <div class="table-header"><h3 style="margin:0; font-size: 1.2rem; text-transform:uppercase; letter-spacing:1px;">Recent System Activity</h3></div>
              <table>
                <thead><tr><th>Time</th><th>Action</th><th>User</th><th>Details</th></tr></thead>
                <tbody id="activity-tbody"></tbody>
              </table>
            </div>
          </section>

          <section id="view-users" class="view-section">
            <div class="table-container">
              <div class="table-header">
                <h3 style="margin:0; font-size: 1.2rem; text-transform:uppercase; letter-spacing:1px;">Player Management</h3>
                <input type="text" class="search-bar" placeholder="Search username..." onkeyup="filterTable('users-tbody', this.value)">
              </div>
              <table>
                <thead><tr><th>Join Date</th><th>Username</th><th>Password</th><th>Role</th><th>Balance (TC)</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="users-tbody"></tbody>
              </table>
            </div>
          </section>

          <section id="view-transactions" class="view-section">
            <div class="table-container">
              <div class="table-header">
                <h3 style="margin:0; font-size: 1.2rem; text-transform:uppercase; letter-spacing:1px;">Cashier Logs</h3>
                <input type="text" class="search-bar" placeholder="Search ID or Username..." onkeyup="filterTable('tx-tbody', this.value)">
              </div>
              <table>
                <thead><tr><th>ID</th><th>Type</th><th>Username</th><th>Amount (TC)</th><th>Ref / Details</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody id="tx-tbody"></tbody>
              </table>
            </div>
          </section>

          <section id="view-giftcodes" class="view-section">
            <div class="table-container">
              <div class="table-header">
                <h3 style="margin:0; font-size: 1.2rem; text-transform:uppercase; letter-spacing:1px;">Gift Code Batches</h3>
                <button class="btn-primary" onclick="openModal('modal-create-giftcode')"><i class="fas fa-plus"></i> Generate Codes</button>
              </div>
              <table>
                <thead><tr><th>Batch ID</th><th>Reward (TC)</th><th>Generated</th><th>Used</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody id="giftcodes-tbody"></tbody>
              </table>
            </div>
          </section>

          <section id="view-updates" class="view-section">
            <div class="table-container" style="padding: 30px;">
                <h3 style="margin: 0 0 20px 0; font-size: 1.5rem; text-transform:uppercase; letter-spacing:1px; text-align:center;">Push System Update</h3>
                <div class="input-group">
                    <label>Announcement Title</label><input type="text" id="update-title" placeholder="e.g. Server Maintenance">
                </div>
                <div class="input-group">
                    <label>Message content</label><textarea id="update-msg" class="input-control" placeholder="Type your update message to all players here..."></textarea>
                </div>
                <button class="btn-primary" style="width: 100%; margin-top: 10px;" onclick="pushUpdate()"><i class="fas fa-paper-plane"></i> PUSH UPDATE</button>
            </div>
            <h3 style="margin: 0 0 15px 0; font-size: 1.2rem; text-transform:uppercase; letter-spacing:1px;">Recent Updates</h3>
            <div id="updates-log-container"></div>
          </section>

        </div>
      </main>
  </div>

  <div id="modal-edit-user" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="width: 400px;">
      <i class="fas fa-times modal-close" onclick="closeModal('modal-edit-user')"></i>
      <h3 class="modal-title">Edit User</h3>
      <input type="hidden" id="edit-uid">
      <div class="input-group"><label>Username</label><input type="text" id="edit-uname" disabled style="opacity:0.7; border-color:transparent;"></div>
      <div class="input-group">
        <label>Account Role</label>
        <select id="edit-urole" class="input-control"><option value="Player">Player</option><option value="Moderator">Moderator</option><option value="Admin">Admin</option></select>
      </div>
      <div class="input-group"><label>Balance (TC)</label><input type="number" id="edit-ubalance"></div>
      <button class="btn-primary" style="width:100%; justify-content:center; margin-top:10px;" onclick="saveUserEdit()">Save Changes</button>
    </div>
  </div>

  <div id="modal-create-giftcode" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <i class="fas fa-times modal-close" onclick="closeModal('modal-create-giftcode')"></i>
      <h3 class="modal-title">Generate Gift Codes</h3>
      <div class="input-group"><label>How many giftcodes?</label><input type="number" id="new-gc-count" placeholder="e.g. 50"></div>
      <div class="input-group"><label>How much credits?</label><input type="number" id="new-gc-amt" placeholder="e.g. 100"></div>
      <button class="btn-primary" style="width:100%; justify-content:center; margin-top:10px;" onclick="saveGiftBatch()"><i class="fas fa-bolt"></i> Generate Codes</button>
    </div>
  </div>

  <div id="modal-view-gcs" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="width: 500px;">
      <i class="fas fa-times modal-close" onclick="closeModal('modal-view-gcs')"></i>
      <h3 class="modal-title" id="gc-modal-title">Gift Codes</h3>
      <button class="btn-primary" style="width:100%; margin-bottom: 15px; background:rgba(255,255,255,0.1); color:white; border: 1px solid var(--glass-border);" id="btn-copy-all-batch"><i class="fas fa-copy"></i> Copy All Codes</button>
      <div id="gc-list" class="custom-scroll" style="flex: 1; overflow-y:auto; padding-right: 5px;"></div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
    // --- SOCKET.IO & GLOBAL STATE ---
    const socket = io();
    let adminDB = { users: [], transactions: [], giftBatches: [], updates: [] };

    // --- AUTHENTICATION LOGIC ---
    function submitAdminAuth() {
        const u = document.getElementById('admin-user').value.trim();
        const p = document.getElementById('admin-pass').value;
        const errDiv = document.getElementById('auth-error-login');
        if(!u || !p) return errDiv.innerText = "Enter credentials.";
        socket.emit('adminLogin', { username: u, password: p });
    }

    socket.on('adminLoginSuccess', (data) => {
        document.getElementById('auth-error-login').innerText = "";
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        document.getElementById('admin-name-display').innerText = data.username;
        showToast(`Welcome back, ${data.role}!`, "success");
        socket.emit('getAdminData'); // Request initial DB dump
    });

    socket.on('authError', (msg) => {
        document.getElementById('auth-error-login').innerText = msg;
    });

    function logoutAdmin() {
        if(confirm("Are you sure you want to log out?")) location.reload();
    }

    function toggleInputPwd(inputId, icon) {
        const input = document.getElementById(inputId);
        if (input.type === "password") { input.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } 
        else { input.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
    }

    function toggleTablePwd(icon) {
        const td = icon.closest('td'); const mask = td.querySelector('.pwd-mask'); const text = td.querySelector('.pwd-text');
        if(mask.style.display === 'none') { mask.style.display = 'inline'; text.style.display = 'none'; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); icon.style.color = 'var(--text-muted)'; } 
        else { mask.style.display = 'none'; text.style.display = 'inline'; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); icon.style.color = 'white'; }
    }

    // --- UI LOGIC ---
    function showToast(msg, type='success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        let icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function switchView(viewId, el) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        
        const titles = { 'dashboard': 'Dashboard', 'users': 'Player Management', 'transactions': 'Cashier Requests', 'giftcodes': 'Gift Codes', 'updates': 'System Updates' };
        document.getElementById('topbar-title').innerText = titles[viewId];

        if(viewId === 'users') renderUsers();
        if(viewId === 'transactions') renderTransactions();
        if(viewId === 'giftcodes') renderGiftBatches();
        if(viewId === 'updates') renderUpdates();
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function filterTable(tbodyId, query) {
        let trs = document.getElementById(tbodyId).getElementsByTagName('tr');
        query = query.toLowerCase();
        for(let i=0; i<trs.length; i++) {
            let txt = trs[i].innerText.toLowerCase();
            trs[i].style.display = txt.includes(query) ? '' : 'none';
        }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => { showToast("Copied to clipboard!", "success"); })
        .catch(() => { showToast("Failed to copy.", "error"); });
    }

    // --- SOCKET DATA SYNCING & RENDERING ---
    socket.on('adminDataSync', (data) => {
        adminDB = data;
        
        // Update Dashboard Stats
        document.getElementById('stat-economy').innerText = data.stats.economy.toLocaleString();
        document.getElementById('stat-players').innerText = data.users.length.toLocaleString();
        document.getElementById('stat-pending').innerText = data.transactions.filter(t => t.status === 'Pending').length;
        document.getElementById('stat-promos').innerText = data.giftBatches.length.toLocaleString();

        // Refresh views based on what's active
        const activeView = document.querySelector('.view-section.active').id;
        if(activeView === 'view-users') renderUsers();
        if(activeView === 'view-transactions') renderTransactions();
        if(activeView === 'view-giftcodes') renderGiftBatches();
        if(activeView === 'view-updates') renderUpdates();
    });

    socket.on('adminToast', (data) => { showToast(data.msg, data.type); });

    function renderUsers() {
        const tb = document.getElementById('users-tbody'); tb.innerHTML = '';
        const roleW = { 'Admin': 1, 'Moderator': 2, 'Player': 3 };
        const statW = { 'Active': 1, 'Offline': 2, 'Banned': 3 };
        
        let sortedUsers = [...adminDB.users].sort((a, b) => {
            if (roleW[a.role] !== roleW[b.role]) return roleW[a.role] - roleW[b.role];
            if (statW[a.status] !== statW[b.status]) return statW[a.status] - statW[b.status];
            return a.username.localeCompare(b.username);
        });

        sortedUsers.forEach(u => {
            let badge = u.status === 'Active' ? 'badge-active' : (u.status === 'Offline' ? 'badge-offline' : 'badge-rejected');
            let roleBadge = u.role === 'Admin' ? 'role-admin' : (u.role === 'Moderator' ? 'role-mod' : 'role-player');

            tb.innerHTML += `
                <tr>
                    <td style="color:var(--text-muted); font-size:0.85rem;">${new Date(u.joinDate).toLocaleDateString()}</td>
                    <td style="font-weight:800; color:white;">${u.username}</td>
                    <td style="font-family:monospace; color:var(--text-muted); font-size:0.9rem;">
                        <div class="pwd-cell"><span class="pwd-mask">••••••••</span><span class="pwd-text" style="display:none;">${u.password}</span><i class="fas fa-eye" style="cursor:pointer; color:var(--text-muted);" onclick="toggleTablePwd(this)" title="Toggle Visibility"></i></div>
                    </td>
                    <td><span class="badge ${roleBadge}">${u.role}</span></td>
                    <td style="color:var(--credits); font-weight:900;">${u.credits.toLocaleString()}</td>
                    <td><span class="badge ${badge}">${u.status}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-icon btn-edit" onclick="openEditUser('${u._id}')" title="Edit/Promote"><i class="fas fa-pen"></i></button>
                            ${u.status !== 'Banned' ? 
                              `<button class="btn-icon btn-reject" onclick="socket.emit('adminAction', {type:'ban', id:'${u._id}'})" title="Ban User"><i class="fas fa-ban"></i></button>` : 
                              `<button class="btn-icon btn-approve" onclick="socket.emit('adminAction', {type:'unban', id:'${u._id}'})" title="Unban User"><i class="fas fa-check"></i></button>`
                            }
                        </div>
                    </td>
                </tr>`;
        });
    }

    function renderTransactions() {
        const tb = document.getElementById('tx-tbody'); tb.innerHTML = '';
        const pending = adminDB.transactions.filter(t => t.status === 'Pending');
        const resolved = adminDB.transactions.filter(t => t.status !== 'Pending');

        const createRow = (t, isPending) => {
            let tColor = t.type === 'Deposit' ? 'var(--success)' : 'var(--danger)';
            let sign = t.type === 'Deposit' ? '+' : '-';
            let statClass = t.status === 'Approved' ? 'badge-approved' : (t.status === 'Rejected' ? 'badge-rejected' : 'badge-pending');
            let actions = isPending ? `
                <button class="btn-icon btn-approve" onclick="socket.emit('adminAction', {type:'resolveTx', id:'${t._id}', status:'Approved'})" title="Approve"><i class="fas fa-check"></i></button>
                <button class="btn-icon btn-reject" onclick="socket.emit('adminAction', {type:'resolveTx', id:'${t._id}', status:'Rejected'})" title="Reject"><i class="fas fa-times"></i></button>
            ` : `<span style="color:var(--text-muted); font-size:0.8rem; font-weight:800; text-transform:uppercase;">Resolved</span>`;

            return `<tr style="${!isPending ? 'opacity:0.4;' : ''}">
                    <td style="font-family:monospace; color:var(--text-muted);">${t._id.substring(0,8)}</td>
                    <td style="font-weight:900; text-transform:uppercase; color:white;">${t.type}</td>
                    <td style="font-weight:800; color:white;">${t.username}</td>
                    <td style="color:${tColor}; font-weight:900;">${sign}${t.amount.toLocaleString()}</td>
                    <td style="font-size:0.85rem; color:var(--text-muted);">${t.ref}</td>
                    <td><span class="badge ${statClass}">${t.status}</span></td>
                    <td style="color:var(--text-muted); font-size:0.85rem;">${new Date(t.date).toLocaleDateString()}</td>
                    <td><div class="action-btns">${actions}</div></td></tr>`;
        };

        let html = '';
        pending.forEach(t => html += createRow(t, true));
        resolved.forEach(t => html += createRow(t, false));
        tb.innerHTML = html;
    }

    function renderGiftBatches() {
        const tb = document.getElementById('giftcodes-tbody'); tb.innerHTML = '';
        adminDB.giftBatches.forEach(b => {
            let total = b.codes.length; let used = b.codes.filter(c => c.redeemedBy !== null).length;
            tb.innerHTML += `<tr>
                    <td style="font-weight:900; color:white; letter-spacing:1px;">${b._id}</td>
                    <td style="color:var(--ps-glow); font-weight:900;">${b.amount.toLocaleString()} TC</td>
                    <td style="color:white; font-weight:800;">${total}</td>
                    <td style="color:var(--text-muted);">${used}</td>
                    <td style="color:var(--text-muted); font-size:0.85rem;">${new Date(b.date).toLocaleDateString()}</td>
                    <td><div class="action-btns">
                            <button class="btn-icon btn-edit" onclick="viewGiftCodes('${b._id}')" title="View Codes"><i class="fas fa-eye"></i></button>
                            <button class="btn-icon btn-reject" onclick="socket.emit('adminAction', {type:'deleteBatch', id:'${b._id}'})" title="Delete Batch"><i class="fas fa-trash"></i></button>
                        </div></td></tr>`;
        });
    }

    function renderUpdates() {
        const con = document.getElementById('updates-log-container'); con.innerHTML = '';
        adminDB.updates.forEach(u => {
            con.innerHTML += `<div class="update-item"><div class="update-header"><div class="update-title">${u.title}</div><div class="update-date">${new Date(u.date).toLocaleDateString()}</div></div><div class="update-msg">${u.msg}</div></div>`;
        });
    }

    // --- EMITTERS ---
    let currentEditUid = null;
    function openEditUser(uid) {
        const user = adminDB.users.find(u => u._id === uid);
        currentEditUid = uid;
        document.getElementById('edit-uname').value = user.username;
        document.getElementById('edit-ubalance').value = user.credits;
        document.getElementById('edit-urole').value = user.role || 'Player';
        openModal('modal-edit-user');
    }

    function saveUserEdit() {
        const newBal = parseInt(document.getElementById('edit-ubalance').value);
        const newRole = document.getElementById('edit-urole').value;
        socket.emit('adminAction', { type: 'editUser', id: currentEditUid, credits: newBal, role: newRole });
        closeModal('modal-edit-user');
    }

    function saveGiftBatch() {
        const count = parseInt(document.getElementById('new-gc-count').value);
        const amt = parseInt(document.getElementById('new-gc-amt').value);
        if(isNaN(count) || isNaN(amt) || count <= 0 || amt <= 0) return showToast('Please enter valid numbers.', 'error');
        socket.emit('adminAction', { type: 'createBatch', count: count, amount: amt });
        closeModal('modal-create-giftcode');
        document.getElementById('new-gc-count').value = ''; document.getElementById('new-gc-amt').value = '';
    }

    function viewGiftCodes(batchId) {
        const batch = adminDB.giftBatches.find(b => b._id === batchId);
        document.getElementById('gc-modal-title').innerText = `Batch ${batchId.substring(0,6)}...`;
        let html = '';
        batch.codes.forEach(c => {
            let statusHTML = c.redeemedBy ? `<span style="color:var(--text-muted); font-size:0.85rem;">Claimed by ${c.redeemedBy}</span>` : `<i class="fas fa-copy copy-icon" onclick="copyToClipboard('${c.code}')"></i>`;
            let color = c.redeemedBy ? 'var(--text-muted)' : 'white';
            let bg = c.redeemedBy ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.4)';
            html += `<div class="code-item" style="background:${bg}"><span class="code-val" style="color:${color}">${c.code}</span><span class="code-action">${statusHTML}</span></div>`;
        });
        document.getElementById('gc-list').innerHTML = html;
        document.getElementById('btn-copy-all-batch').onclick = () => {
            let allCodes = batch.codes.map(c => c.code).join('\n');
            if(!allCodes) return showToast("No codes to copy.", "error");
            copyToClipboard(allCodes);
        };
        openModal('modal-view-gcs');
    }

    function pushUpdate() {
        const title = document.getElementById('update-title').value;
        const msg = document.getElementById('update-msg').value;
        if(!title || !msg) return showToast("Please fill all fields.", "error");
        socket.emit('adminAction', { type: 'pushUpdate', title: title, msg: msg });
        document.getElementById('update-title').value = ''; document.getElementById('update-msg').value = '';
    }

    // --- ANTI-SNOOPING SECURITY ---
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode === 123) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode === 'I'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode === 'C'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.shiftKey && e.keyCode === 'J'.charCodeAt(0)) return false; 
        if(e.ctrlKey && e.keyCode === 'U'.charCodeAt(0)) return false; 
    };
  </script>
</body>
</html>